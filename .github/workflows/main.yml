
name: ğŸ•·ï¸ Spidey VPS - Persistent Session Workflow

on:
  workflow_dispatch:
    inputs:
      force_fresh_install:
        description: 'ğŸ”„ Force fresh installation (ignore backups)'
        required: false
        default: 'false'
        type: boolean
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 400  # 6.5 hours to account for overhead
    
    steps:
    - name: ğŸ•¸ï¸ Web-Slinging Setup - Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ•·ï¸ Spider-Sense Activated - Initialize Environment
      run: |
        echo "ğŸ•·ï¸ Welcome to Spidey's VPS! Your friendly neighborhood server is starting up..."
        echo "ğŸŒŸ Setting hostname to Spidey..."
        sudo hostnamectl set-hostname Spidey
        echo "âœ¨ Spidey VPS Session Started at $(date)"
        
    - name: ğŸ› ï¸ Installing Web-Crawler Tools - Setup rclone
      run: |
        echo "ğŸ”§ Installing rclone for our web of backups..."
        curl https://rclone.org/install.sh | sudo bash
        echo "âœ… rclone installed successfully!"
        
    - name: ğŸ•¸ï¸ Weaving the MEGA Connection
      run: |
        echo "ğŸ”— Setting up MEGA remote connection..."
        mkdir -p ~/.config/rclone
        echo "${{ secrets.RCLONE_CONFIG }}" | base64 -d > ~/.config/rclone/rclone.conf || {
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf
        }
        echo "ğŸŒ MEGA connection established!"
        
    - name: ğŸ” Spider-Sense: Searching for Previous Backup Artifacts
      id: artifact_search
      continue-on-error: true
      run: |
        echo "ğŸ•µï¸ Searching for previous VPS backup artifacts..."
        echo "ğŸ” Looking for vps-backup.tar.gz in recent workflow runs..."
        # This step will be handled by the restore step below
        echo "artifact_available=checking" >> $GITHUB_OUTPUT
        
    - name: ğŸ“¦ Attempting Artifact Recovery
      id: artifact_restore
      continue-on-error: true
      uses: actions/download-artifact@v4
      with:
        name: vps-backup
        path: ./restore/
        
    - name: ğŸ•·ï¸ Web of Restoration - Primary Restore Logic
      id: restore_logic
      run: |
        echo "ğŸ•¸ï¸ Initiating Spidey's restoration sequence..."
        RESTORE_SUCCESS=false
        
        # Step 1: Try artifact restore
        if [ "${{ inputs.force_fresh_install }}" != "true" ] && [ -f "./restore/vps-backup.tar.gz" ]; then
          echo "ğŸ“¦ Found GitHub artifact! Restoring from web of memories..."
          cd /
          sudo tar -xzf "$GITHUB_WORKSPACE/restore/vps-backup.tar.gz"
          if [ $? -eq 0 ]; then
            echo "âœ… Artifact restore successful! Spidey's previous state recovered!"
            RESTORE_SUCCESS=true
          else
            echo "âŒ Artifact restore failed. Web got tangled..."
          fi
        fi
        
        # Step 2: Try MEGA restore if artifact failed
        if [ "$RESTORE_SUCCESS" = "false" ] && [ "${{ inputs.force_fresh_install }}" != "true" ]; then
          echo "ğŸŒ Attempting MEGA restore from the cloud web..."
          rclone copy mega:vps-backups/latest-vps-backup.tar.gz ./restore/ || true
          if [ -f "./restore/latest-vps-backup.tar.gz" ]; then
            echo "ğŸ“¥ MEGA backup found! Downloading from the web..."
            cd /
            sudo tar -xzf "$GITHUB_WORKSPACE/restore/latest-vps-backup.tar.gz"
            if [ $? -eq 0 ]; then
              echo "âœ… MEGA restore successful! Spidey swung back to previous state!"
              RESTORE_SUCCESS=true
            else
              echo "âŒ MEGA restore failed. Even Spider-Man falls sometimes..."
            fi
          else
            echo "ğŸ” No MEGA backup found. Time for a fresh start!"
          fi
        fi
        
        echo "restore_success=$RESTORE_SUCCESS" >> $GITHUB_OUTPUT
        
    - name: ğŸ†• Fresh Web Installation - New Spidey Setup
      if: steps.restore_logic.outputs.restore_success == 'false'
      run: |
        echo "ğŸ•·ï¸ No previous state found! Setting up a brand new Spidey VPS..."
        echo "ğŸ—ï¸ Building from scratch with great power and responsibility!"
        
    - name: ğŸ‘¤ Creating Spider-Squad User
      run: |
        echo "ğŸ‘¤ Creating user jacky (part of the Spider-Squad)..."
        sudo useradd -m -s /bin/bash jacky || echo "ğŸ‘¤ User jacky already exists!"
        echo "jacky:spidey" | sudo chpasswd
        sudo usermod -aG sudo jacky
        echo "âœ… jacky added to the Spider-Squad with sudo powers!"
        
    - name: ğŸ•¸ï¸ Installing Tailscale - Web of Networks
      run: |
        echo "ğŸŒ Installing Tailscale for our secret spider network..."
        curl -fsSL https://tailscale.com/install.sh | sh
        
        if [ -d "/var/lib/tailscale" ] && [ "${{ steps.restore_logic.outputs.restore_success }}" = "true" ]; then
          echo "ğŸ”„ Restoring previous Tailscale identity..."
          sudo systemctl start tailscaled
        else
          echo "ğŸ†• Registering new Tailscale node..."
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTHKEY }}" --hostname="spidey-vps"
        fi
        echo "âœ… Tailscale web connected!"
        
    - name: ğŸ–¥ï¸ Installing aaPanel - Spidey's Control Center
      run: |
        echo "ğŸ•¸ï¸ Installing aaPanel v7.0 - Spidey's web control center..."
        wget -O install.sh http://www.aapanel.com/script/install_7.0_en.sh
        echo "y" | echo "yes" | sudo bash install.sh
        
        echo "ğŸ‘¨â€ğŸ’» Configuring aaPanel with Spidey credentials..."
        sudo /www/server/panel/pyenv/bin/python /www/server/panel/tools.py panel Jacky
        sudo /www/server/panel/pyenv/bin/python /www/server/panel/tools.py password spidey
        echo "âœ… aaPanel configured for the Spider-Squad!"
        
    - name: ğŸ—„ï¸ MariaDB Setup - Spidey's Data Web
      run: |
        echo "ğŸ•¸ï¸ Setting up MariaDB - where Spidey stores all his web data..."
        sudo apt update
        sudo apt install -y mariadb-server mariadb-client
        
        sudo systemctl start mariadb
        sudo systemctl enable mariadb
        
        echo "ğŸ” Securing MariaDB with spider-level security..."
        sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '${{ secrets.DB_ROOT_PASSWORD }}';"
        sudo mysql -u root -p${{ secrets.DB_ROOT_PASSWORD }} -e "CREATE DATABASE IF NOT EXISTS test;"
        echo "âœ… MariaDB web of data is ready!"
        
    - name: ğŸ”„ Service Restoration Check
      if: steps.restore_logic.outputs.restore_success == 'true'
      run: |
        echo "ğŸ”„ Ensuring all Spider-Services are running after restoration..."
        sudo systemctl restart mariadb || echo "âš ï¸ MariaDB restart failed"
        sudo systemctl restart bt || echo "âš ï¸ aaPanel restart failed"
        sudo systemctl status mariadb
        echo "âœ… Service restoration check completed!"
        
    - name: ğŸ•·ï¸ Spider-Session Loop - 6 Hour Web Patrol
      run: |
        echo "ğŸ•¸ï¸ Starting Spidey's 6-hour patrol of the digital web..."
        echo "ğŸš¨ Spider-Sense: Monitoring for /tmp/stop signal..."
        
        END_TIME=$(($(date +%s) + 21000))  # ~5.8 hours
        
        while [ $(date +%s) -lt $END_TIME ]; do
          if [ -f "/tmp/stop" ]; then
            echo "ğŸ›‘ Stop signal detected! Spidey is preparing to swing away..."
            break
          fi
          
          echo "ğŸ•·ï¸ [$(date)] Spidey is on patrol... All systems web-slingin' normally!"
          sleep 300  # Check every 5 minutes
        done
        
        echo "â° Patrol time ending or stop signal received!"
        
    - name: ğŸ“¦ Creating Backup Manifest - Spidey's Memory Web
      run: |
        echo "ğŸ“ Creating Spidey's backup manifest..."
        mkdir -p /tmp/spidey-backup
        
        cat > /tmp/spidey-backup/backup-manifest.txt << 'EOF'
        ğŸ•·ï¸ SPIDEY VPS BACKUP MANIFEST ğŸ•·ï¸
        Created: $(date)
        Hostname: $(hostname)
        
        ğŸ“ Backup Contents:
        - /home (Spider-Squad home directories)
        - /root (Root spider lair)
        - /etc (System web configurations)
        - /var/www (Web content)
        - /opt (Optional spider tools)
        - /var/lib/tailscale (Secret network state)
        - /var/lib/mysql (Data web)
        - aaPanel data (/www)
        
        ğŸ•¸ï¸ With great power comes great backup responsibility!
        EOF
        
        echo "âœ… Backup manifest created!"
        
    - name: ğŸ—œï¸ Weaving the Backup Archive
      run: |
        echo "ğŸ•¸ï¸ Weaving all important data into Spidey's backup web..."
        
        sudo tar -czf /tmp/spidey-backup/vps-backup.tar.gz \
          --exclude='/home/*/.*cache*' \
          --exclude='/var/lib/mysql/mysql.sock*' \
          --exclude='/var/lib/mysql/ib_logfile*' \
          /home \
          /root \
          /etc/hostname \
          /etc/hosts \
          /etc/ssh \
          /etc/crontab \
          /var/www \
          /opt \
          /var/lib/tailscale \
          /var/lib/mysql \
          /www \
          /tmp/spidey-backup/backup-manifest.txt \
          2>/dev/null || true
          
        echo "ğŸ“ Backup size: $(du -h /tmp/spidey-backup/vps-backup.tar.gz)"
        echo "âœ… Backup web successfully woven!"
        
    - name: ğŸ•¸ï¸ GitHub Artifact Web Storage
      uses: actions/upload-artifact@v4
      with:
        name: vps-backup
        path: /tmp/spidey-backup/vps-backup.tar.gz
        retention-days: 30
        
    - name: ğŸŒ MEGA Cloud Web Backup
      continue-on-error: true
      run: |
        echo "ğŸ•¸ï¸ Uploading to MEGA cloud web for redundancy..."
        
        rclone copy /tmp/spidey-backup/vps-backup.tar.gz mega:vps-backups/latest-vps-backup.tar.gz
        rclone copy /tmp/spidey-backup/vps-backup.tar.gz mega:vps-backups/backup-$(date +%Y%m%d-%H%M%S).tar.gz
        
        # Try to generate a public link
        MEGA_LINK=$(rclone link mega:vps-backups/latest-vps-backup.tar.gz 2>/dev/null || echo "Link generation failed")
        echo "$MEGA_LINK" > /tmp/mega-backup-link.txt
        
        echo "ğŸ”— MEGA backup link: $MEGA_LINK"
        echo "âœ… Backup successfully uploaded to the cloud web!"
        
    - name: ğŸ•·ï¸ Final Web Status Report
      run: |
        echo "ğŸ•·ï¸ SPIDEY VPS SESSION COMPLETE! ğŸ•·ï¸"
        echo "â° Session ended at: $(date)"
        echo "ğŸ•¸ï¸ All systems secured in the web of backups!"
        echo "ğŸ’¾ GitHub Artifact: âœ… Created"
        echo "â˜ï¸ MEGA Cloud: âœ… Uploaded"
        echo "ğŸš€ Ready for next web-slinging session!"
        echo ""
        echo "ğŸ•¸ï¸ Remember: With great VPS power comes great backup responsibility! ğŸ•¸ï¸"
