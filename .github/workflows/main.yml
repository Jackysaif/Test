# ğŸ•·ï¸ Spidey Persistent VPS - Production Ready
name: Persistent VPS

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:      # Manual trigger

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

env:
  BACKUP_STORE: /var/backups/vps
  BACKUP_NAME: vps-backup-latest.tar.gz
  MEGA_REMOTE: mega:vps-backup

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 350  # 5 hours 50 minutes (GitHub max is 6 hours)
    
    steps:
      - name: 'ğŸ•¸ï¸ Checkout Code'
        uses: actions/checkout@v4

      - name: 'ğŸ‘¤ Initial Setup: User, Hostname & Services'
        run: |
          set -euo pipefail
          echo "ğŸš€ Setting up fresh VPS environment..."
          
          # Create user jacky
          if ! id "jacky" &>/dev/null; then
            sudo useradd -m -s /bin/bash jacky
            echo "âœ… User 'jacky' created"
          fi
          
          # Set password and sudo privileges
          echo "jacky:root" | sudo chpasswd
          sudo usermod -aG sudo jacky
          echo "jacky ALL=(ALL:ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/jacky
          
          # Set hostname
          sudo hostnamectl set-hostname github-vps
          echo "127.0.1.1 github-vps" | sudo tee -a /etc/hosts
          
          echo "âœ… Basic system setup completed."

      - name: 'âš¡ Install System Tools & MariaDB'
        run: |
          set -euo pipefail
          echo "ğŸš€ Installing core system tools, MariaDB, rclone, and tmate..."
          
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            psmisc screen openssh-server apache2 \
            php php-mysql php-cli php-curl php-zip php-gd php-mbstring php-xml \
            mariadb-server \
            curl wget unzip tar gzip htop nano vim git net-tools || {
              echo "âŒ Package installation failed"
              exit 1
            }
          
          echo "ğŸ“¥ Installing tmate..."
          if ! command -v tmate &>/dev/null; then
            sudo apt-get install -y tmate || {
              wget -q -O /tmp/tmate.tar.xz https://github.com/tmate-io/tmate/releases/download/2.4.0/tmate-2.4.0-static-linux-amd64.tar.xz
              tar -xf /tmp/tmate.tar.xz -C /tmp/
              sudo cp /tmp/tmate-2.4.0-static-linux-amd64/tmate /usr/local/bin/
              sudo chmod +x /usr/local/bin/tmate
            }
          fi
          
          echo "ğŸ“¥ Installing rclone..."
          curl -fsSL https://rclone.org/install.sh | sudo bash || {
            echo "âŒ Rclone installation failed"
            exit 1
          }
          
          echo "âœ… All tools installed successfully."

      - name: 'ğŸ› ï¸ Configure MariaDB for Aapanel'
        run: |
          set -euo pipefail
          echo "ğŸ”§ Configuring MariaDB for Aapanel..."
          
          sudo systemctl unmask mariadb.service || true
          sudo systemctl enable mariadb
          sudo systemctl start mariadb || {
            echo "âŒ Failed to start MariaDB service."
            exit 1
          }
          
          echo "Creating Aapanel database user..."
          sudo mysql -u root -e "
            CREATE USER IF NOT EXISTS 'aapanel'@'localhost' IDENTIFIED BY 'aapanelpass';
            GRANT ALL PRIVILEGES ON *.* TO 'aapanel'@'localhost' WITH GRANT OPTION;
            FLUSH PRIVILEGES;
          " || {
            echo "âŒ Failed to create Aapanel database user."
            exit 1
          }
          echo "âœ… Aapanel user for MariaDB created successfully."

      - name: 'ğŸ› ï¸ Configure Rclone (MEGA) - Enhanced'
        run: |
          set -euo pipefail
          echo "ğŸ” Setting up rclone configuration..."
          
          if [[ -z "${{ secrets.RCLONE_CONFIG || '' }}" ]]; then
            echo "âŒ RCLONE_CONFIG secret is missing!"
            exit 1
          fi
          
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << 'EOF'
          ${{ secrets.RCLONE_CONFIG }}
          EOF
          chmod 600 ~/.config/rclone/rclone.conf
          
          if ! rclone config show >/dev/null 2>&1; then
            echo "âŒ Invalid rclone configuration format"
            exit 1
          fi
          echo "âœ… Rclone configuration created successfully."

      - name: 'âœ… Test Rclone Configuration - Robust'
        run: |
          set -euo pipefail
          echo "ğŸ” Testing MEGA connection..."
          
          if rclone listremotes | grep -q "mega:"; then
            echo "âœ… MEGA remote found in configuration"
            for i in {1..3}; do
              echo "ğŸ”„ Connection test attempt $i/3..."
              if timeout 60 rclone about ${{ env.MEGA_REMOTE }} >/dev/null 2>&1; then
                echo "âœ… MEGA connection successful!"
                break
              elif [[ $i -eq 3 ]]; then
                echo "âŒ MEGA connection failed after 3 attempts"
                exit 1
              else
                echo "âš ï¸ Attempt $i failed, retrying in 10 seconds..."
                sleep 10
              fi
            done
          else
            echo "âŒ MEGA remote not found in configuration"
            exit 1
          fi

      - name: 'ğŸ“¦ Install Aapanel'
        run: |
          set -euo pipefail
          echo "ğŸ“¥ Installing Aapanel control panel..."
          
          URL=https://www.aapanel.com/script/install_7.0_en.sh && if [ -f /usr/bin/curl ];then curl -ksSO "$URL" ;else wget --no-check-certificate -O install_7.0_en.sh "$URL";fi;bash install_7.0_en.sh aapanel || {
            echo "âŒ Aapanel installation failed"
            exit 1
          }
          
          if command -v bt >/dev/null 2>&1; then
            echo "âœ… Aapanel installed successfully"
            sudo bt --version 2>/dev/null || true
          else
            echo "âš ï¸ Aapanel command 'bt' not found in PATH"
          fi

      - name: 'â™»ï¸ Restore MariaDB Data from Backup or Start Fresh'
        run: |
          set -euo pipefail
          echo "Checking for existing MariaDB backup..."
          
          if rclone ls "${MEGA_REMOTE}/${BACKUP_NAME}" >/dev/null 2>&1; then
            echo "âœ… Backup found! Downloading and restoring..."
            mkdir -p /tmp/restore
            if rclone copy "${MEGA_REMOTE}/${BACKUP_NAME}" /tmp/restore/ --progress --retries 3; then
              echo "âœ… Backup downloaded successfully"
            else
              echo "âŒ Failed to download backup"
              exit 1
            fi
            
            echo "ğŸ›‘ Stopping services for data restoration..."
            sudo systemctl stop mariadb apache2 || true
            
            echo "ğŸ“ Restoring data from backup..."
            sudo tar -xzf "/tmp/restore/${BACKUP_NAME}" --absolute-names -C / || true
            
            echo "ğŸ” Setting permissions for restored data..."
            sudo chown -R mysql:mysql /www/server/data
            sudo chmod -R 700 /www/server/data
            
            rm -f "/tmp/restore/${BACKUP_NAME}"
            echo "ï¸ Cleaning old backup from MEGA..."
            rclone delete "${MEGA_REMOTE}/${BACKUP_NAME}" || true
          else
            echo "â„¹ï¸ No backup found. Continuing with fresh installation and configuration."
          fi

      - name: 'ğŸš€ Finalize Configuration and Start Services'
        run: |
          set -euo pipefail
          echo "ğŸ—„ï¸ Restarting MariaDB and Apache services..."
          sudo systemctl restart mariadb apache2 || {
            echo "âŒ Failed to start MariaDB/Apache services."
            exit 1
          }

          echo "ğŸ” Configuring Aapanel credentials..."
          sleep 5
          echo "Jacky" | sudo bt 6 2>/dev/null || echo "âš ï¸ Could not set Aapanel username"
          echo "spidey" | sudo bt 5 2>/dev/null || echo "âš ï¸ Could not set Aapanel password"
          
          echo "ğŸ“‹ Aapanel Information:"
          sudo bt default 2>/dev/null || echo "âš ï¸ Could not retrieve Aapanel info"

      - name: 'ğŸ”— Configure Remote Access and Display Info'
        run: |
          set -euo pipefail
          echo "ğŸ•¸ï¸ Setting up Tailscale VPN..."
          
          if [[ -z "${{ secrets.TAILSCALE_AUTHKEY || '' }}" ]]; then
            echo "âŒ TAILSCALE_AUTHKEY secret is missing!"
            exit 1
          fi
          
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo systemctl enable tailscaled
          sudo systemctl start tailscaled
          
          for i in {1..3}; do
            if sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTHKEY }}" --hostname=github-vps --reset --accept-routes; then
              echo "âœ… Tailscale connected on attempt $i"
              break
            else
              echo "âš ï¸ Tailscale connection attempt $i failed"
              if [[ $i -eq 3 ]]; then
                echo "âŒ Tailscale setup failed"
                exit 1
              fi
              sleep 15
            fi
          done
          
          TAILSCALE_IP=$(sudo tailscale ip -4)
          echo "ğŸŒ Granting remote access to MariaDB for Tailscale IP: $TAILSCALE_IP"
          sudo mysql -e "GRANT ALL PRIVILEGES ON *.* TO 'root'@'${TAILSCALE_IP}' IDENTIFIED BY '' WITH GRANT OPTION; FLUSH PRIVILEGES;" || {
            echo "âŒ Failed to grant remote MariaDB access to Tailscale IP."
          }
          echo "âœ… MariaDB remote access granted for ${TAILSCALE_IP}."

          echo "ğŸ’¬ Starting tmate for SSH access..."
          tmate -S /tmp/tmate.sock new-session -d 'echo "VPS Ready - Welcome to GitHub VPS!"; bash'
          timeout 60 tmate -S /tmp/tmate.sock wait tmate-ready || {
            echo "âš ï¸ tmate session startup timeout"
          }
          
          echo "================================================"
          echo "ğŸ‰ VPS IS READY FOR CONNECTION! ğŸ‰"
          echo "================================================"
          TMATE_SSH=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}' 2>/dev/null || echo "Failed to get tmate info")
          TMATE_WEB=$(tmate -S /tmp/tmate.sock display -p '#{tmate_web}' 2>/dev/null || echo "Not available")
          
          echo "ğŸŒ Tailscale IP: $TAILSCALE_IP"
          echo "ğŸ”‘ SSH Access: $TMATE_SSH"
          echo "ğŸŒ Web Terminal: $TMATE_WEB"
          
          if command -v bt >/dev/null 2>&1; then
            echo "ğŸ›ï¸ Aapanel: http://$TAILSCALE_IP:7800 (Jacky/spidey)"
            echo "ğŸ—„ï¸ MariaDB: Remote access enabled for root user from your Tailscale network."
          fi
          echo "================================================"

      - name: 'â³ Maintain VPS Session'
        run: |
          set -euo pipefail
          echo "ğŸ–¥ï¸ VPS session is running!"
          echo "ğŸ“ To stop gracefully: touch /tmp/stop_session"
          echo "â° Auto-stop in 5.5 hours for backup"
          
          for minute in {1..330}; do
            if [[ -f /tmp/stop_session ]]; then
              echo "ğŸ›‘ Stop signal detected at minute $minute"
              break
            fi
            
            if (( minute % 30 == 0 )); then
              echo "â° Runtime: $minute minutes"
              echo "ğŸ“Š Services: $(systemctl is-active mariadb apache2 ssh tailscaled 2>/dev/null | tr '\n' ' ' || echo 'Not available')"
              if (( minute % 60 == 0 )); then
                echo "ğŸ”— Tailscale IP: $(sudo tailscale ip -4 2>/dev/null || echo 'N/A')"
              fi
            fi
            sleep 60
          done
          echo "ğŸ VPS session maintenance completed"

      - name: 'ğŸ“¦ Create System Backup'
        if: always()
        run: |
          set -euo pipefail
          echo "ğŸ“¦ Creating comprehensive backup..."
          
          sudo mkdir -p "${{ env.BACKUP_STORE }}"
          echo "ğŸ›‘ Stopping services for clean backup..."
          sudo systemctl stop apache2 mariadb || true
          if command -v bt >/dev/null 2>&1; then
            sudo bt stop 2>/dev/null || true
          fi
          sleep 5
          
          echo "ğŸ“ Creating backup archive..."
          sudo tar -czf "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" \
            --absolute-names \
            --ignore-failed-read \
            --warning=no-file-ignored \
            --exclude='/proc/*' --exclude='/tmp/*' --exclude='/sys/*' \
            --exclude='/dev/*' --exclude='/run/*' --exclude='/mnt/*' \
            --exclude='/media/*' --exclude='/lost+found' \
            --exclude='*.log' --exclude='*.pid' \
            /etc/hostname /etc/hosts /etc/passwd /etc/group /etc/shadow \
            /etc/sudoers.d/ /etc/systemd/system/ /etc/ssh/ \
            /etc/apache2/ /etc/mysql/ /var/lib/tailscale/ \
            /www/server/data/ /www/server/panel/ \
            /var/www/ /opt/ /srv/ /root/ /home/jacky/ \
            /usr/local/bin/ \
            2>/dev/null || {
              echo "âš ï¸ Some files couldn't be backed up (normal)"
            }
          
          if [[ -f "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" ]]; then
            BACKUP_SIZE=$(du -h "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" | cut -f1)
            echo "âœ… Backup created: $BACKUP_SIZE"
            if tar -tzf "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" >/dev/null 2>&1; then
              echo "âœ… Backup integrity verified"
            else
              echo "âŒ Backup integrity check failed"
              exit 1
            fi
          else
            echo "âŒ Backup creation failed"
            exit 1
          fi

      - name: 'â˜ï¸ Upload Backup to MEGA'
        if: always()
        run: |
          set -euo pipefail
          echo "ğŸš€ Uploading backup to MEGA..."
          
          if [[ ! -f "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" ]]; then
            echo "âŒ No backup file found to upload"
            exit 1
          fi
          
          for attempt in {1..5}; do
            echo "ğŸ“¤ Upload attempt $attempt/5..."
            if rclone copy "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" "${{ env.MEGA_REMOTE }}" \
               --progress --transfers 1 --retries 3 --low-level-retries 3; then
              echo "âœ… Upload successful on attempt $attempt"
              if rclone ls "${{ env.MEGA_REMOTE }}/${{ env.BACKUP_NAME }}" >/dev/null 2>&1; then
                echo "âœ… Upload verified on MEGA"
                break
              else
                echo "âŒ Upload verification failed"
              fi
            else
              echo "âŒ Upload attempt $attempt failed"
              if [[ $attempt -eq 5 ]]; then
                echo "âŒ All upload attempts exhausted"
                exit 1
              fi
              echo "â³ Waiting 30 seconds before retry..."
              sleep 30
            fi
          done
          
          sudo rm -f "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}"
          echo "ğŸ—‘ï¸ Local backup cleaned up"

      - name: 'ğŸ“‹ Final Status Report'
        if: always()
        run: |
          echo "============================================="
          echo "         ğŸ•·ï¸ VPS SESSION COMPLETE ğŸ•·ï¸"
          echo "============================================="
          echo "ğŸ“… Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ·ï¸ Status: ${{ job.status }}"
          echo "ğŸ–¥ï¸ Hostname: $(hostname)"
          echo "ğŸŒ Runner: $(whoami)@$(hostname)"
          
          case "${{ job.status }}" in
            "success")
              echo "âœ… Session completed successfully!"
              echo "ğŸ’¾ Backup stored: ${{ env.MEGA_REMOTE }}/${{ env.BACKUP_NAME }}"
              ;;
            "failure")
              echo "âŒ Session completed with errors"
              echo "ğŸ’¾ Backup may be available at: ${{ env.MEGA_REMOTE }}/${{ env.BACKUP_NAME }}"
              ;;
            *)
              echo "â¹ï¸ Session was cancelled or timed out"
              echo "ğŸ’¾ Backup status unknown"
              ;;
          esac
