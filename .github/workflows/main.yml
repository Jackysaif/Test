name: Persistent VPS with MEGA Backup

on:
  workflow_dispatch:

jobs:
  vps-session:
    runs-on: ubuntu-22.04
    timeout-minutes: 350

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Display startup info
        run: |
          echo "üîë VPS starting with hostname 'github-vps'"
          echo "Creating username 'jacky' with password 'root'"
          echo "Root password = root"

      - name: Set hostname
        run: |
          sudo hostnamectl set-hostname github-vps
          echo "127.0.0.1 github-vps" | sudo tee -a /etc/hosts

      - name: Set root password
        run: |
          echo "root:root" | sudo chpasswd

      - name: Create user 'jacky' with password 'root'
        run: |
          if ! id -u jacky >/dev/null 2>&1; then
            sudo useradd -m -s /bin/bash jacky
            echo "jacky:root" | sudo chpasswd
            sudo usermod -aG sudo jacky
            echo "jacky ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/jacky
          fi

      - name: Install prerequisites
        run: |
          sudo apt update
          sudo apt install -y tmate curl unzip sudo net-tools neofetch

      - name: Install rclone
        run: |
          curl -fsSL https://rclone.org/install.sh | sudo bash
          rclone version

      - name: Setup rclone with MEGA
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [mega]
          type = mega
          user = ${MEGA_USER}
          pass = ${MEGA_PASS}
          EOF
          rclone listremotes

      - name: Restore VPS backup from MEGA
        id: restore
        run: |
          if rclone lsf mega:vps-backup/ >/dev/null 2>&1; then
            echo "Backup found on MEGA. Restoring..."
            sudo rclone copy mega:vps-backup/ / --exclude '*/.git/*' --exclude '/.rclone.conf' --progress
            echo "backup_found=true" >> "$GITHUB_OUTPUT"
          else
            echo "No backup found on MEGA. Starting with a fresh VPS."
            echo "backup_found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale (restore mode)
        if: ${{ steps.restore.outputs.backup_found == 'true' }}
        run: |
          sudo tailscaled &
          sleep 8
          sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --hostname=github-vps || echo "Tailscale already up"
          echo "üîó Tailscale IP:"
          tailscale ip -4 || echo "Tailscale IP not found"

      - name: Start Tailscale (fresh mode) and backup state
        if: ${{ steps.restore.outputs.backup_found == 'false' }}
        run: |
          sudo tailscaled &
          sleep 8
          sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --hostname=github-vps || echo "Tailscale already up"
          echo "üîó Tailscale IP:"
          tailscale ip -4 || echo "Tailscale IP not found"
          echo "Backing up new Tailscale state immediately."
          sudo chown -R $USER:$USER /var/lib/tailscale
          rclone copy /var/lib/tailscale/tailscaled.state mega:vps-backup/var/lib/tailscale/ --progress

      - name: Start manual tmate session
        run: |
          sudo apt-get install -y tmate
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          echo ""
          echo "üîë SSH:"
          tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}'
          echo ""
          echo "üåê Web:"
          tmate -S /tmp/tmate.sock display -p '#{tmate_web}'

      - name: Sleep to keep VPS alive
        run: sleep 21600

      - name: Backup VPS data to MEGA (on completion)
        if: ${{ success() }}
        run: |
          echo "üì¶ Backing up VPS data to MEGA..."
          sudo chown -R $USER:$USER /var/lib/tailscale
          rclone copy / mega:vps-backup/ --exclude '*/.git/*' --exclude '/.rclone.conf' --progress
          echo "‚úÖ Backup uploaded successfully."

      - name: Final Backup on Cancel 
        if: ${{ cancelled() }}
        run: |
          echo "‚ö†Ô∏è Workflow canceled. Performing final backup..."
          sudo chown -R $USER:$USER /var/lib/tailscale
          rclone copy / mega:vps-backup/ --exclude '*/.git/*' --exclude '/.rclone.conf' --progress
          echo "‚úÖ Final backup completed."
