name: Continuous Persistent VPS

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  vps-session:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: "üöÄ Installing Dependencies"
        run: |
          set -e
          echo "========================================="
          echo "üì¶ Installing system dependencies..."
          echo "========================================="
          sudo apt update
          sudo apt install -y sudo curl unzip zip tmate net-tools neofetch rclone
          echo "‚úÖ Dependencies installed."

      - name: "üë§ Create user jacky"
        run: |
          set -e
          if ! id "jacky" &>/dev/null; then
            echo "üë§ Creating user jacky..."
            sudo useradd -m -s /bin/bash jacky
            echo "jacky:root" | sudo chpasswd
            sudo usermod -aG sudo jacky
          else
            echo "‚ÑπÔ∏è User jacky already exists."
          fi
          echo "‚úÖ User setup complete."

      - name: "‚¨áÔ∏è Install latest Rclone"
        run: |
          set -e
          echo "========================================="
          echo "‚¨áÔ∏è Installing Rclone..."
          echo "========================================="
          curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip rclone-current-linux-amd64.zip
          cd rclone-*-linux-amd64
          sudo cp rclone /usr/bin/
          sudo chmod 755 /usr/bin/rclone
          echo "‚úÖ Rclone Installed"
          rclone version

      - name: "üìÇ Restore Tailscale state"
        run: |
          set -e
          echo "========================================="
          echo "üìÇ Checking for existing Tailscale state..."
          echo "========================================="
          sudo mkdir -p /var/lib/tailscale
          if rclone ls gdrive:vps-backup/system/tailscaled.state >/dev/null 2>&1; then
            echo "üî• Found previous Tailscale state. Restoring..."
            sudo rclone copy gdrive:vps-backup/system/tailscaled.state /var/lib/tailscale/ --progress || true
            sudo chown root:root /var/lib/tailscale/tailscaled.state || true
            sudo chmod 600 /var/lib/tailscale/tailscaled.state || true
            echo "TS_STATE_RESTORED=true" >> $GITHUB_ENV
          else
            echo "‚ÑπÔ∏è No previous Tailscale state found."
            echo "TS_STATE_RESTORED=false" >> $GITHUB_ENV
          fi

      - name: "üåê Install & Start Tailscale"
        run: |
          set -e
          echo "========================================="
          echo "üåê Installing Tailscale..."
          echo "========================================="
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo systemctl stop tailscaled || true
          sudo systemctl start tailscaled
          sudo systemctl enable tailscaled
          
          if [ "$TS_STATE_RESTORED" = "false" ]; then
            echo "‚ö° No old state, logging into Tailscale..."
            sudo tailscale up --authkey tskey-auth-kodgmRrzjh11CNTRL-JTL6FCKJPCC6gMwL6o7HCCJVk67E9VU7 --hostname github-vps || true
            echo "üì¶ Backing up new Tailscale state..."
            sudo rclone copy /var/lib/tailscale/tailscaled.state gdrive:vps-backup/system/ --progress || true
          else
            echo "‚úÖ Using restored Tailscale state."
          fi

      - name: "üíæ Restore VPS Data"
        run: |
          set -e
          echo "========================================="
          echo "üíæ Restoring VPS data from backup..."
          echo "========================================="
          sudo rclone copy gdrive:vps-backup/home/ /home/jacky/ --progress || true
          sudo chown -R jacky:jacky /home/jacky || true
          sudo rclone copy gdrive:vps-backup/etc/ /etc/ --progress || true
          sudo rclone copy gdrive:vps-backup/www/ /var/www/ --progress || true
          echo "‚úÖ Restore complete."

      - name: "‚è≥ Keep Session Alive"
        run: |
          set -e
          echo "========================================="
          echo "‚è≥ VPS Session is active for ~6h..."
          echo "========================================="
          sleep 21600

      - name: "üì¶ Backup VPS Data"
        if: always()
        run: |
          set -e
          echo "========================================="
          echo "üì¶ Starting VPS backup process..."
          echo "========================================="
          sudo rclone copy /home/jacky gdrive:vps-backup/home/ --progress || true
          sudo rclone copy /etc gdrive:vps-backup/etc/ --progress || true
          sudo rclone copy /var/www gdrive:vps-backup/www/ --progress || true
          echo "‚úÖ Backup complete."

      - name: "üìÇ Backup Tailscale state"
        if: always()
        run: |
          set -e
          echo "========================================="
          echo "üìÇ Saving Tailscale state..."
          echo "========================================="
          sudo rclone copy /var/lib/tailscale/tailscaled.state gdrive:vps-backup/system/ --progress || true
          echo "‚úÖ Tailscale state saved."
