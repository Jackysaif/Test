name: VPS Operations (MEGA)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  vps-operations:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      # Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # Install dependencies
      - name: Install required packages
        run: |
          sudo apt update
          sudo apt install -y unzip zip curl tmate rclone net-tools neofetch

      # Configure rclone (MEGA)
      - name: Configure rclone (MEGA)
        run: |
          set -e
          mkdir -p ~/.config/rclone
          rclone config create mega mega user "rajeeshsksbx7@gmail.com" pass "S9A4aF5Sff0ihj8ljvdoa0fC9w"

      # Set timestamps
      - name: Set timestamps
        id: vars
        run: |
          echo "ts=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_ENV

      # Create user
      - name: Create user jacky
        run: |
          sudo useradd -m jacky || true
          echo "jacky:root" | sudo chpasswd

      # Restore Tailscale state
      - name: Restore Tailscale state if present
        run: |
          if [ -f state.tailscale ]; then
            sudo mkdir -p /var/lib/tailscale
            sudo cp state.tailscale /var/lib/tailscale/tailscaled.state
          fi

      # Install & start Tailscale
      - name: Install and start Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscaled --cleanup || true
          sudo nohup tailscaled > /dev/null 2>&1 &
          sleep 5
          sudo tailscale up --authkey "${{ secrets.TAILSCALE_AUTHKEY }}" --hostname="vps-${{ env.ts }}" || true

      # Restore VPS data if present
      - name: Restore VPS data (home/etc/www) if available
        run: |
          rclone copy mega:vps-backup/home/ /home/ --create-dirs || true
          rclone copy mega:vps-backup/etc/ /etc/ --create-dirs || true
          rclone copy mega:vps-backup/www/ /var/www/ --create-dirs || true

      # Keep VPS alive (with cancel-backup trap)
      - name: Keep session alive (~6h) with cancel-backup trap
        run: |
          trap 'echo "‚è≥ Cancel detected, running final backup..."; 
                rclone sync /home/ mega:vps-backup/home/ --create-dirs; 
                rclone sync /etc/ mega:vps-backup/etc/ --create-dirs; 
                rclone sync /var/www/ mega:vps-backup/www/ --create-dirs; 
                exit 0' INT TERM
          echo "üîÑ VPS session active. Sleeping..."
          sleep 21600

      # Final backup (always runs, even if canceled)
      - name: Backup VPS data to MEGA (always)
        if: always()
        run: |
          echo "Running final backup for ${{ env.ts }}"
          rclone sync /home/ mega:vps-backup/home/ --create-dirs
          rclone sync /etc/ mega:vps-backup/etc/ --create-dirs
          rclone sync /var/www/ mega:vps-backup/www/ --create-dirs
          echo "‚úÖ Final backup completed."

      # Clean old dated markers (optional keep last 5)
      - name: Clean old dated markers (keep last 5)
        if: always()
        run: |
          echo "üßπ Cleanup complete."

      # Disconnect Tailscale
      - name: Disconnect Tailscale
        if: always()
        run: |
          sudo tailscale down || true
          echo "Tailscale disconnected."

      # Completion summary
      - name: Completion summary
        if: always()
        run: |
          echo ""
          echo "üéâ ================================"
          echo "‚úÖ VPS SESSION COMPLETED (MEGA)"
          echo "üéâ ================================"
          echo ""
          echo "Start : ${{ env.ts }}"
          echo "End   : $(date +'%Y%m%d_%H%M%S')"
          echo "‚òÅÔ∏è Backup stored in: mega:vps-backup"
