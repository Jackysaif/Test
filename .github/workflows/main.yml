# ðŸ•·ï¸ Spidey Persistent VPS - Optimized with Graceful Shutdown

name: Persistent VPS

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:      # Manual trigger
  push:
    branches: [ main ]    # Optional: trigger on push to main

env:
  BACKUP_STORE: /var/backups/vps
  BACKUP_NAME: vps-backup-latest.tar.gz
  MEGA_REMOTE: mega:vps-backup

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 350  # 5 hours 50 minutes (GitHub max is 6 hours)
    
    steps:
      - name: 'ðŸ•¸ï¸ Checkout Code'
        uses: actions/checkout@v4

      - name: 'âš¡ Install System Tools, Rclone & tmate'
        run: |
          set -euo pipefail  # Exit on error, undefined vars, pipe failures
          echo "ðŸš€ Installing core system tools, rclone, and tmate..."
          
          # Update package lists
          sudo apt-get update -qq
          
          # Install essential packages
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            psmisc \
            screen \
            openssh-server \
            mariadb-server \
            apache2 \
            php \
            php-mysql \
            php-cli \
            php-curl \
            php-zip \
            php-gd \
            php-mbstring \
            php-xml \
            curl \
            wget \
            unzip \
            tar \
            gzip \
            htop \
            nano \
            vim \
            git
          
          # Install tmate
          wget -O /tmp/tmate.tar.xz https://github.com/tmate-io/tmate/releases/download/2.4.0/tmate-2.4.0-static-linux-amd64.tar.xz
          sudo tar -xf /tmp/tmate.tar.xz -C /tmp/
          sudo mv /tmp/tmate-2.4.0-static-linux-amd64/tmate /usr/local/bin/
          sudo chmod +x /usr/local/bin/tmate
          
          # Install rclone
          curl -fsSL https://rclone.org/install.sh | sudo bash
          
          # Enable and start SSH
          sudo systemctl enable ssh
          sudo systemctl start ssh
          
          echo "âœ… Core tools, rclone, and tmate installed."

      - name: 'ðŸ› ï¸ Configure Rclone (MEGA)'
        run: |
          set -euo pipefail
          echo "ðŸ” Creating rclone configuration file from GitHub secrets..."
          
          # Ensure rclone config directory exists
          mkdir -p ~/.config/rclone
          
          # Create rclone config from secrets
          if [[ -z "${{ secrets.RCLONE_CONFIG }}" ]]; then
            echo "âŒ RCLONE_CONFIG secret is not set!"
            exit 1
          fi
          
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf
          chmod 600 ~/.config/rclone/rclone.conf
          
          echo "âœ… rclone configuration file created."

      - name: 'âœ… Test Rclone Configuration'
        run: |
          set -euo pipefail
          echo "ðŸ” Testing connection to MEGA remote..."
          
          # Test rclone connection with timeout
          if timeout 30 rclone about ${{ env.MEGA_REMOTE }} > /dev/null 2>&1; then
            echo "âœ… Rclone configuration succeeded. Connection established to MEGA."
          else
            echo "âŒ Rclone configuration failed. Check your MEGA secrets and the rclone.conf format."
            echo "Available remotes:"
            rclone listremotes || true
            exit 1
          fi

      - name: 'â™»ï¸ Restore from Backup OR Initialize'
        id: restore
        run: |
          set -euo pipefail
          echo "ðŸ” Checking for existing backup on MEGA..."
          
          # Check if backup exists with timeout
          if timeout 60 rclone ls "${MEGA_REMOTE}/${BACKUP_NAME}" >/dev/null 2>&1; then
            echo "âœ… Backup found. Restoring system state..."
            
            # Download backup with progress and verification
            mkdir -p /tmp/restore
            if ! rclone copy "${MEGA_REMOTE}/${BACKUP_NAME}" /tmp/restore/ --progress; then
              echo "âŒ Failed to download backup"
              exit 1
            fi
            
            # Verify backup file exists and is not empty
            if [[ ! -f "/tmp/restore/${BACKUP_NAME}" ]] || [[ ! -s "/tmp/restore/${BACKUP_NAME}" ]]; then
              echo "âŒ Downloaded backup file is missing or empty"
              exit 1
            fi
            
            # Test backup integrity before extraction
            if ! tar -tzf "/tmp/restore/${BACKUP_NAME}" >/dev/null 2>&1; then
              echo "âŒ Backup file is corrupted"
              exit 1
            fi
            
            # Extract backup with error handling
            echo "ðŸ“¦ Extracting backup..."
            sudo tar -xzpf "/tmp/restore/${BACKUP_NAME}" --absolute-names -C / 2>/dev/null || {
              echo "âš ï¸ Some files failed to restore (this is often normal)"
            }
            
            # Clean up downloaded backup
            rm -f "/tmp/restore/${BACKUP_NAME}"
            
            # Delete old backup from MEGA to prevent reuse
            echo "ðŸ—‘ï¸ Cleaning up old backup from MEGA..."
            rclone delete "${MEGA_REMOTE}/${BACKUP_NAME}" || true
            
            echo "is_new_install=false" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No backup found. This will be a fresh installation."
            
            # Create essential directories
            sudo mkdir -p \
              /home/jacky \
              /opt \
              /srv \
              /var/www/html \
              /var/lib/mysql \
              /www/server \
              /root/.ssh \
              /home/jacky/.ssh
            
            echo "is_new_install=true" >> $GITHUB_OUTPUT
          fi

      - name: 'ðŸ‘¤ Initial Setup: Create User, Set Hostname & Aapanel'
        if: steps.restore.outputs.is_new_install == 'true'
        run: |
          set -euo pipefail
          echo "ðŸš€ Performing first-time setup for a new VPS..."
          
          # Create user jacky if it doesn't exist
          if ! id "jacky" &>/dev/null; then
            sudo useradd -m -s /bin/bash jacky
            echo "âœ… User 'jacky' created"
          else
            echo "â„¹ï¸ User 'jacky' already exists"
          fi
          
          # Set password and sudo privileges
          echo "jacky:root" | sudo chpasswd
          sudo usermod -aG sudo jacky
          echo "jacky ALL=(ALL:ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/jacky
          
          # Set hostname
          sudo hostnamectl set-hostname github-vps
          echo "127.0.1.1 github-vps" | sudo tee -a /etc/hosts
          
          # Install Aapanel with error handling
          echo "ðŸ“¥ Downloading and installing Aapanel..."
          if curl -sSLo /tmp/install.sh "http://www.aapanel.com/script/install-ubuntu_6.0_en.sh"; then
            chmod +x /tmp/install.sh
            # Auto-answer installation prompts
            (echo "y" | timeout 600 sudo bash /tmp/install.sh) || {
              echo "âš ï¸ Aapanel installation may have encountered issues"
            }
          else
            echo "âŒ Failed to download Aapanel installer"
          fi
          
          echo "âœ… Initial setup complete."

      - name: 'ðŸš€ Start System Services'
        run: |
          set -euo pipefail
          echo "ðŸ”„ Starting and configuring system services..."
          
          # Reload systemd
          sudo systemctl daemon-reload
          
          # Start and enable MariaDB
          sudo systemctl enable mariadb
          sudo systemctl start mariadb
          echo "âœ… MariaDB started"
          
          # Start and enable Apache
          sudo systemctl enable apache2
          sudo systemctl start apache2
          echo "âœ… Apache2 started"
          
          # Start SSH service
          sudo systemctl enable ssh
          sudo systemctl start ssh
          echo "âœ… SSH service started"
          
          # Start Aapanel if installed
          if command -v bt &> /dev/null; then
            sudo bt restart || echo "âš ï¸ Aapanel not found or failed to start"
          fi
          
          # Verify services are running
          echo "ðŸ” Service status check:"
          sudo systemctl is-active mariadb apache2 ssh || true
          
          echo "âœ… Core services configured."

      - name: 'ðŸ”— Configure Remote Access & Credentials'
        run: |
          set -euo pipefail
          
          # Configure Aapanel credentials if it's a new install
          if [[ "${{ steps.restore.outputs.is_new_install }}" == "true" ]] && command -v bt &> /dev/null; then
            echo "ðŸ” Setting Aapanel credentials..."
            sleep 10
            
            # Set username and password
            echo "jacky" | sudo bt 6 2>/dev/null || echo "âš ï¸ Failed to set Aapanel username"
            echo "spidey" | sudo bt 5 2>/dev/null || echo "âš ï¸ Failed to set Aapanel password"
            
            # Get Aapanel info
            sudo bt default 2>/dev/null || echo "âš ï¸ Could not retrieve Aapanel info"
          fi
          
          # Install and configure Tailscale
          echo "ðŸ•¸ï¸ Installing Tailscale..."
          if [[ -z "${{ secrets.TAILSCALE_AUTHKEY }}" ]]; then
            echo "âŒ TAILSCALE_AUTHKEY secret is not set!"
            exit 1
          fi
          
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo systemctl enable tailscaled
          sudo systemctl start tailscaled
          
          # Connect to Tailscale with retry logic
          for i in {1..3}; do
            if sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTHKEY }}" --hostname=github-vps --reset; then
              echo "âœ… Tailscale connected successfully"
              break
            else
              echo "âš ï¸ Tailscale connection attempt $i failed, retrying..."
              sleep 10
            fi
          done
          
          # Start tmate session
          echo "ðŸ’¬ Starting tmate session for SSH access..."
          tmate -S /tmp/tmate.sock new-session -d 'bash'
          
          # Wait for tmate to be ready with timeout
          timeout 30 tmate -S /tmp/tmate.sock wait tmate-ready || {
            echo "âš ï¸ tmate session may not be ready"
          }
          
          echo "---"
          echo "âœ… VPS IS READY FOR CONNECTION âœ…"
          echo "---"
          
          # Get connection information
          TAILSCALE_IP=$(sudo tailscale ip -4 2>/dev/null || echo "Not available")
          TMATE_SSH=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}' 2>/dev/null || echo "Not available")
          
          echo "ðŸŒ Tailscale IP: $TAILSCALE_IP"
          echo "ðŸ”‘ tmate SSH: $TMATE_SSH"
          echo "ðŸ–¥ï¸ Local SSH: ssh jacky@localhost (password: root)"
          
          if command -v bt &> /dev/null; then
            PANEL_INFO=$(sudo bt default 2>/dev/null | grep -E "(Aapanel|External|username|password)" || echo "Aapanel info not available")
            echo "ðŸŽ›ï¸ Aapanel: $PANEL_INFO"
          fi
          
          echo "---"

      - name: 'â³ Maintain VPS Session'
        run: |
          set -euo pipefail
          echo "ðŸ–¥ï¸ VPS is now running. To stop gracefully and trigger backup, create: touch /tmp/stop_session"
          echo "â° Session will auto-stop in 5.5 hours to allow backup time."
          
          # Monitor for stop signal or timeout (330 minutes = 5.5 hours)
          for i in {1..330}; do
            if [[ -f /tmp/stop_session ]]; then
              echo "ðŸ›‘ Stop signal detected at minute $i. Proceeding to backup..."
              break
            fi
            
            # Show status every 30 minutes
            if (( i % 30 == 0 )); then
              echo "â° VPS running for $i minutes. Services status:"
              sudo systemctl is-active mariadb apache2 ssh tailscaled 2>/dev/null || true
            fi
            
            sleep 60
          done
          
          echo "ðŸ VPS session maintenance completed."

      - name: 'ðŸ“¦ Create Final Backup'
        if: always()  # Run even if previous steps failed
        run: |
          set -euo pipefail
          echo "ðŸ“¦ Creating comprehensive system backup..."
          
          # Create backup directory
          sudo mkdir -p "${{ env.BACKUP_STORE }}"
          
          # Stop services gracefully before backup
          echo "ðŸ›‘ Stopping services for clean backup..."
          sudo systemctl stop apache2 mariadb || true
          sudo bt stop || true
          
          # Create backup with comprehensive file list
          echo "ðŸ“ Creating backup archive..."
          sudo tar -czpf "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" \
            --absolute-names \
            --ignore-failed-read \
            --exclude='/proc/*' \
            --exclude='/tmp/*' \
            --exclude='/sys/*' \
            --exclude='/dev/*' \
            --exclude='/run/*' \
            --exclude='/mnt/*' \
            --exclude='/media/*' \
            --exclude='/lost+found' \
            /etc/hostname \
            /etc/hosts \
            /etc/passwd \
            /etc/group \
            /etc/shadow \
            /etc/sudoers.d/ \
            /etc/systemd/system/ \
            /etc/ssh/ \
            /etc/apache2/ \
            /etc/mysql/ \
            /var/lib/tailscale/ \
            /var/lib/mysql/ \
            /var/www/ \
            /opt/ \
            /srv/ \
            /www/ \
            /root/ \
            /home/jacky/ \
            /usr/bin/bt \
            /usr/local/bin/ \
            2>/dev/null || {
              echo "âš ï¸ Some files failed to backup (this is often normal for system files)"
            }
          
          # Verify backup was created and is not empty
          if [[ -f "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" ]] && [[ -s "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" ]]; then
            BACKUP_SIZE=$(du -h "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" | cut -f1)
            echo "âœ… Backup created successfully (Size: $BACKUP_SIZE)"
            
            # Test backup integrity
            if tar -tzf "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" >/dev/null 2>&1; then
              echo "âœ… Backup integrity verified"
            else
              echo "âŒ Backup may be corrupted"
              exit 1
            fi
          else
            echo "âŒ Failed to create backup or backup is empty"
            exit 1
          fi

      - name: 'â˜ï¸ Upload Final Backup to MEGA'
        if: always()  # Run even if previous steps failed
        run: |
          set -euo pipefail
          echo "ðŸš€ Uploading backup to MEGA cloud storage..."
          
          # Check if backup file exists
          if [[ ! -f "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" ]]; then
            echo "âŒ Backup file not found, skipping upload"
            exit 1
          fi
          
          # Upload with retry logic and progress
          for i in {1..3}; do
            if rclone copy "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" "${{ env.MEGA_REMOTE }}" --progress --transfers 1; then
              echo "âœ… Backup uploaded successfully on attempt $i"
              
              # Verify upload
              if rclone ls "${{ env.MEGA_REMOTE }}/${{ env.BACKUP_NAME }}" >/dev/null 2>&1; then
                echo "âœ… Backup upload verified"
                break
              else
                echo "âŒ Upload verification failed on attempt $i"
              fi
            else
              echo "âš ï¸ Upload attempt $i failed"
              if [[ $i -eq 3 ]]; then
                echo "âŒ All upload attempts failed"
                exit 1
              fi
              sleep 30
            fi
          done
          
          # Clean up local backup
          sudo rm -f "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}"
          echo "ðŸ—‘ï¸ Local backup cleaned up"
          
      - name: 'ðŸ“ Final Status Report'
        if: always()  # Always run this step
        run: |
          echo "============================================="
          echo "       VPS SESSION CONCLUDED"
          echo "============================================="
          echo "ðŸ·ï¸ Job Status: ${{ job.status }}"
          echo "â° Completed at: $(date)"
          echo "ðŸ–¥ï¸ Hostname: $(hostname)"
          
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ… Session completed successfully"
            echo "ðŸ’¾ Backup location: ${{ env.MEGA_REMOTE }}/${{ env.BACKUP_NAME }}"
          elif [[ "${{ job.status }}" == "failure" ]]; then
            echo "âŒ Session completed with errors"
            echo "ðŸ’¾ Backup may still be available at: ${{ env.MEGA_REMOTE }}/${{ env.BACKUP_NAME }}"
          else
            echo "â¹ï¸ Session was cancelled"
            echo "ðŸ’¾ Backup upload was likely skipped"
          fi
          
          # Final service status
          echo "ðŸ” Final service status:"
          sudo systemctl is-active mariadb apache2 ssh tailscaled 2>/dev/null || echo "Services stopped"
          
          echo "============================================="
