
name: ğŸ•·ï¸ Spidey's Persistent VPS Adventure

on:
  workflow_dispatch:
    inputs:
      force_fresh_install:
        description: 'ğŸ”„ Force fresh install (ignore backups)'
        required: false
        default: 'false'
        type: boolean
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 420  # 7 hours to be safe
    
    steps:
      - name: ğŸ•¸ï¸ Web-slinging into action
        run: |
          echo "ğŸ•·ï¸ ===================================================="
          echo "ğŸ•·ï¸ SPIDEY'S VPS IS SWINGING INTO ACTION! ğŸ•¸ï¸"
          echo "ğŸ•·ï¸ Time: $(date)"
          echo "ğŸ•·ï¸ Your friendly neighborhood VPS is starting up! ğŸ¢"
          echo "ğŸ•·ï¸ ===================================================="
          
      - name: ğŸ”§ Installing Spidey's web-tools (rclone)
        run: |
          echo "ğŸ•·ï¸ Installing rclone - Spidey's file-slinging tool! ğŸ•¸ï¸"
          curl https://rclone.org/install.sh | sudo bash
          echo "âœ… Rclone installed! Ready to swing files around! ğŸ•¸ï¸"

      - name: ğŸ” Setting up MEGA web connection
        run: |
          echo "ğŸ•·ï¸ Decoding MEGA secrets with spider sense... ğŸ•¸ï¸"
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" | base64 -d > ~/.config/rclone/rclone.conf 2>/dev/null || echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf
          echo "âœ… MEGA connection established! ğŸ•¸ï¸"

      - name: ğŸ” Spider-sense: Checking for existing backups
        id: backup_check
        run: |
          echo "ğŸ•·ï¸ Spider-sense is tingling... checking for backups! ğŸ•¸ï¸"
          
          RESTORE_SUCCESS=false
          
          if [ "${{ github.event.inputs.force_fresh_install }}" = "true" ]; then
            echo "ğŸ”„ Force fresh install requested! Skipping all backups! ğŸ•·ï¸"
          else
            # Try GitHub artifacts first
            echo "ğŸ” Searching for GitHub artifacts..."
            # Note: In a real scenario, you'd need to download from previous workflow runs
            # This is a placeholder for the artifact download logic
            
            # Try MEGA backup
            echo "ğŸ” Checking MEGA for backup files..."
            if rclone ls mega:spidey-vps-backup/vps-backup.tar.gz > /dev/null 2>&1; then
              echo "ğŸ¯ Found MEGA backup! Spider-sense was right! ğŸ•¸ï¸"
              echo "ğŸ“¥ Downloading backup from MEGA web..."
              rclone copy mega:spidey-vps-backup/vps-backup.tar.gz ./
              if [ -f "vps-backup.tar.gz" ]; then
                echo "ğŸ•·ï¸ Extracting backup with spider precision..."
                sudo tar -xzf vps-backup.tar.gz -C / 2>/dev/null || echo "âš ï¸ Some files couldn't be restored (probably normal)"
                RESTORE_SUCCESS=true
                echo "âœ… Backup restored! The web is back! ğŸ•¸ï¸"
