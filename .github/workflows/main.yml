name: 🕷️ Spidey Persistent VPS

on:
  workflow_dispatch:

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 360  # 6 hours max

    steps:
    # --- Setup ---
    - name: 🕸️ Checkout
      uses: actions/checkout@v4

    - name: ⚡ Install System Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          curl wget unzip tar openssh-client \
          tmux tmate tailscale

    # --- Rclone + MEGA ---
    - name: ⚡ Install Rclone
      run: |
        curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
        unzip rclone-current-linux-amd64.zip
        cd rclone-*-linux-amd64
        sudo cp rclone /usr/bin/
        rclone version

    - name: ☁️ Configure Rclone (MEGA)
      run: |
        mkdir -p ~/.config/rclone
        cat > ~/.config/rclone/rclone.conf <<EOF
        [mega]
        type = mega
        user = ${MEGA_USER}
        pass = ${MEGA_PASS}
        EOF

    # --- User + Hostname ---
    - name: 🧑‍💻 Setup User & Hostname
      run: |
        if ! id -u jacky >/dev/null 2>&1; then
          sudo useradd -m -s /bin/bash jacky
          echo 'jacky:root' | sudo chpasswd
        fi
        sudo hostnamectl set-hostname github-vps
        echo "127.0.0.1 github-vps" | sudo tee -a /etc/hosts

    # --- Restore (Tailscale + Data) ---
    - name: ♻️ Restore From MEGA
      run: |
        echo "🕷️ Checking for backup on MEGA..."
        if rclone ls mega:vps-backup/vps-backup.tar.gz >/dev/null 2>&1; then
          rclone copy mega:vps-backup/vps-backup.tar.gz .
          mkdir -p restore && tar -xpf vps-backup.tar.gz -C restore || true
          sudo rsync -a restore/home/jacky/ /home/jacky/ || true
          sudo rsync -a restore/var/lib/tailscale/ /var/lib/tailscale/ || true
          echo "✅ Restore complete"
        else
          echo "ℹ️ No previous backup found, fresh start."
        fi

    # --- Tailscale ---
    - name: 🔗 Tailscale Setup
      run: |
        sudo systemctl enable --now tailscaled
        sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=github-vps || true
        echo "✅ Tailscale is running"

    # --- Start VPS (tmate) ---
    - name: 🕸️ Start VPS Session
      run: |
        echo "🌍 Starting tmate session..."
        tmate -F &
        sleep 10
        tmate display -p '#{tmate_ssh}'
        echo "✅ VPS ready for 6 hours"
        sleep 21600  # keep alive 6h

    # --- Backup (runs after tmate) ---
    - name: 🕸️ Create Backup
      if: always()
      run: |
        echo "📦 Archiving important data..."
        mkdir -p backup
        cd /

        sudo tar --warning=no-file-changed \
          --use-compress-program="nice -n 19 ionice -c2 -n7 gzip -c" \
          -cpf $GITHUB_WORKSPACE/backup/vps-backup.tar.gz \
          home/jacky \
          var/lib/tailscale \
          etc/hostname \
          etc/hosts || true

        dpkg --get-selections > $GITHUB_WORKSPACE/backup/package-list.txt || true
        echo "✅ Backup archive created"

    - name: ☁️ Upload Backup to MEGA
      if: always()
      run: |
        echo "☁️ Uploading backup to MEGA..."
        rclone mkdir mega:vps-backup || true
        rclone copy $GITHUB_WORKSPACE/backup/ mega:vps-backup/ --progress
        echo "✅ Backup uploaded"

    # --- Cleanup & Report ---
    - name: 🧹 Cleanup
      if: always()
      run: |
        rm -rf backup restore vps-backup.tar.gz || true

    - name: 📊 Final Report
      if: always()
      run: |
        echo "🎉 VPS session completed!"
        echo "✅ Backup stored on MEGA: vps-backup/"
        echo "🕷️ Spidey saved the day!"
