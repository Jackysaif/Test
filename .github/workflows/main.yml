name: Persistent VPS with Backup & Restore (Simple)

on:
  workflow_dispatch:
  workflow_call:

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 360  # 6 hours

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y curl unzip zip tmate net-tools neofetch

      - name: Install rclone
        run: |
          curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip -q rclone-current-linux-amd64.zip
          cd rclone-*-linux-amd64
          sudo cp rclone /usr/bin/
          rclone version

      - name: Configure rclone with MEGA
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [mega]
          type = mega
          user = ${MEGA_USER}
          pass = ${MEGA_PASS}
          EOF
        env:
          MEGA_USER: ${{ secrets.MEGA_USER }}
          MEGA_PASS: ${{ secrets.MEGA_PASS }}

      - name: Create user jacky
        run: |
          if ! id -u jacky >/dev/null 2>&1; then
            sudo useradd -m -s /bin/bash jacky
            echo "jacky:root" | sudo chpasswd
            echo "Created user jacky with password root"
          fi
          sudo hostnamectl set-hostname github-vps
          echo "127.0.0.1 github-vps" | sudo tee -a /etc/hosts

      - name: Restore Tailscale state if available
        run: |
          mkdir -p tailscale_state
          if rclone copy mega:vps-backup/tailscale_state ./tailscale_state --ignore-existing; then
            echo "Restoring previous Tailscale state"
            sudo tailscaled --state=tailscale_state/state.json &
            sleep 5
            sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} || true
          else
            echo "No previous state found, fresh setup"
            sudo tailscaled --state=tailscale_state/state.json &
            sleep 5
            sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }}
            rclone copy ./tailscale_state mega:vps-backup/tailscale_state
          fi

      - name: Start tmate session
        run: |
          echo "Starting tmate..."
          tmate -F &

      - name: Wait to keep session alive
        run: sleep $((360*60))  # 6 hours

      - name: Backup data on cancel
        if: cancelled()
        run: |
          echo "Backing up jacky home and installed packages..."
          mkdir -p backup
          sudo tar -czf backup/jacky_home.tar.gz /home/jacky
          dpkg --get-selections > backup/packages.list
          rclone copy backup mega:vps-backup/backup-$(date +%Y%m%d-%H%M%S) --transfers=4
