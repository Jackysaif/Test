name: üï∑Ô∏è Spidey Persistent VPS - Optimized

on:
  schedule:
    - cron: '0 */6 * * *' # Every 6 hours
  workflow_dispatch:

env:
  BACKUP_STORE: /var/backups/vps
  BACKUP_NAME: vps-backup-latest.tar.gz
  MEGA_REMOTE: mega:vps-backup # Rclone remote path

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 350
    steps:
      - name: üë§ Create user 'jacky' & Set Hostname
        run: |
          echo "üöÄ Creating universal user and hostname setup..."
          sudo useradd -m -s /bin/bash jacky || true
          echo "jacky:root" | sudo chpasswd
          sudo usermod -aG sudo jacky
          echo "jacky ALL=(ALL:ALL) ALL" | sudo tee /etc/sudoers.d/jacky
          sudo hostnamectl set-hostname github-vps
          echo "‚úÖ User 'jacky' created and configured with password 'root'."

      - name: üï∏Ô∏è Checkout Code
        uses: actions/checkout@v4

      - name: ‚ö° Install System Tools, Rclone & tmate
        run: |
          echo "Installing core system tools, rclone, and tmate..."
          sudo apt-get update
          sudo apt-get install -y curl wget unzip tar psmisc screen openssh-server mariadb-server apache2 php php-mysql tmate
          curl -fsSL https://rclone.org/install.sh | sudo bash
          sudo systemctl enable --now ssh
          echo "‚úÖ Core tools, rclone, and tmate installed."

      - name: ‚ôªÔ∏è Restore from Backup OR Initialize
        id: restore
        run: |
          echo "üîç Checking for existing backup on MEGA..."
          if rclone ls ${MEGA_REMOTE}/${BACKUP_NAME} >/dev/null 2>&1; then
            echo "‚úÖ Backup found. Restoring system state..."
            rclone copy ${MEGA_REMOTE}/${BACKUP_NAME} /tmp/
            sudo tar -xzf /tmp/${BACKUP_NAME} --absolute-names -C /
            echo "is_new_install=false" >> $GITHUB_OUTPUT
          else
            echo "‚ÑπÔ∏è No backup found. This will be a fresh installation."
            sudo mkdir -p /home/jacky /opt /srv /var/www /var/lib/mysql /www/server
            echo "is_new_install=true" >> $GITHUB_OUTPUT
          fi

      - name: üóëÔ∏è Delete Backup from MEGA
        if: steps.restore.outputs.is_new_install == 'false'
        run: |
          echo "Deleting backup file from MEGA remote..."
          rclone delete ${{ env.MEGA_REMOTE }}/${{ env.BACKUP_NAME }}
          echo "‚úÖ Backup deleted from MEGA."

      - name: üöÄ Aapanel Setup
        run: |
          echo "Running Aapanel installer to configure over restored files..."
          curl -sSLo /tmp/install.sh http://www.aapanel.com/script/install-ubuntu_6.0_en.sh
          (echo "y" && echo "yes") | sudo bash /tmp/install.sh

      - name: üöÄ Start System Services
        run: |
          set -e
          echo "üîÑ (Re)loading system services..."
          sudo systemctl daemon-reload
          echo "üï∏Ô∏è Installing and starting Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo systemctl enable --now tailscaled
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=github-vps --reset
          sleep 10
          echo "‚öôÔ∏è Starting database, Aapanel, and web services..."
          sudo systemctl start mariadb
          sudo bt restart || true
          sudo systemctl start apache2
          echo "‚úÖ All services are running."
          echo "üåê Tailscale IP: $(sudo tailscale ip -4 || echo 'Not available')"

      - name: üîê Set Aapanel Username & Password
        run: |
          echo "Setting Aapanel username and password..."
          echo "jacky" | sudo bt 6
          echo "spidey" | sudo bt 5
          echo "‚úÖ Aapanel username is 'jacky' and password has been set to 'spidey'."

      - name: üîó Start tmate session
        run: |
          echo "Starting tmate session..."
          # Ensure tmate is installed
          sudo apt-get install -y tmate
          # Start tmate in the background
          tmate -S /tmp/tmate.sock new-session -d
          # Wait for tmate to be ready
          tmate -S /tmp/tmate.sock wait tmate-ready
          echo "‚úÖ tmate session started successfully."
          sleep 3

      - name: Show Tailscale IP and tmate info
        run: |
          echo "üîó Tailscale IP:"
          tailscale ip -4 || echo "Tailscale IP not found"
          echo ""
          echo "üîë tmate SSH session:"
          # Get tmate connection information
          TMATE_SSH=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}' 2>/dev/null || echo "")
          if [ -n "$TMATE_SSH" ]; then
            echo "SSH: $TMATE_SSH"
          else
            echo "Trying alternative method to get tmate connection info..."
            TMATE_SSH=$(tmate -S /tmp/tmate.sock show-messages | grep -o "ssh [^ ]*" | head -1)
            if [ -n "$TMATE_SSH" ]; then
              echo "SSH: $TMATE_SSH"
            else
              echo "Could not retrieve tmate SSH connection information."
            fi
          fi

      - name: ‚è≥ Maintain VPS Session
        run: |
          sudo mkdir -p ${{ env.BACKUP_STORE }}
          
          echo "üì¶ Creating final backup archive..."
          sudo tar --ignore-failed-read -czf ${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }} \
            --absolute-names \
            /etc/hostname \
            /etc/hosts \
            /etc/systemd/system \
            /var/lib/tailscale \
            /opt \
            /srv \
            /var/www \
            /etc/ssh \
            /etc/apache2 \
            /www/server \
            /root \
            /home/jacky \
            /usr/lib/systemd/system \
            /var/lib/mysql \
            /etc/sudoers.d/ \
            /usr/bin/bt \
            2>/dev/null || true
          
          echo "‚úÖ Final backup created at ${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}"

      - name: ‚òÅÔ∏è Upload Final Backup to MEGA
        if: always()
        run: |
          echo "üöÄ Uploading final backup to MEGA..."
          rclone copy ${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }} ${{ env.MEGA_REMOTE }} --progress
          echo "‚úÖ Final backup uploaded successfully."
          
      - name: üìù Final Status Report
        if: always()
        run: |
          echo "=== VPS Session Ended ==="
          echo "Final job status: ${{ job.status }}"
          echo "Backup uploaded to: ${{ env.MEGA_REMOTE }}/${{ env.BACKUP_NAME }}"
          echo "========================="

