name: Persistent VPS with Backup & Restore

on:
  workflow_dispatch:
    inputs:
      operation:
        description: "Choose operation: normal | backup"
        required: false
        default: "normal"
  workflow_call:

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y curl unzip zip tmate net-tools neofetch tailscale

          # Install rclone
          curl -fsSL https://downloads.rclone.org/rclone-current-linux-amd64.zip -o rclone.zip
          unzip rclone.zip
          cd rclone-*-linux-amd64
          sudo install -m 755 rclone /usr/bin/
          cd ..
          rm -rf rclone*

      - name: Configure rclone with MEGA
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [mega]
          type = mega
          user = ${MEGA_USER}
          pass = ${MEGA_PASS}
          EOF
        env:
          MEGA_USER: ${{ secrets.MEGA_USER }}
          MEGA_PASS: ${{ secrets.MEGA_PASS }}

      - name: Create restricted user jacky
        run: |
          if ! id -u jacky >/dev/null 2>&1; then
            sudo useradd -m -s /bin/bash jacky
            echo "jacky:root" | sudo chpasswd
            echo "Created user jacky with password root"
          else
            echo "User jacky already exists"
          fi

      - name: Set hostname
        run: |
          echo "github-vps" | sudo tee /etc/hostname
          sudo hostname github-vps

      - name: Restore VPS data if available
        run: |
          mkdir -p restore
          if rclone ls mega:/vps-backup/vps-latest.tar.gz >/dev/null 2>&1; then
            echo "üì• Restoring full VPS data..."
            rclone copy mega:/vps-backup/vps-latest.tar.gz restore/
            sudo tar -xzf restore/vps-latest.tar.gz -C /
            
            # Restore user home
            if [ -f /backup/home-jacky.tar.gz ]; then
              sudo tar -xzf /backup/home-jacky.tar.gz -C /home/
            fi

            # Restore installed packages
            if [ -f /backup/installed-packages.txt ]; then
              xargs -a /backup/installed-packages.txt sudo apt-get install -y
            fi
          else
            echo "üÜï No previous VPS backup found, starting fresh..."
          fi

      - name: Start Tailscale (restore-first logic)
        run: |
          set -eux
          if [ -f /backup/tailscaled.state ]; then
            echo "üì• Restoring Tailscale state..."
            sudo cp /backup/tailscaled.state /var/lib/tailscale/tailscaled.state
            sudo tailscaled --state=/var/lib/tailscale/tailscaled.state &
            sleep 5
            sudo tailscale up --ssh --hostname github-vps
          else
            echo "üÜï No Tailscale state present; bringing up fresh..."
            sudo tailscaled --state=/var/lib/tailscale/tailscaled.state &
            sleep 5
            sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --ssh --hostname github-vps
          fi

      - name: Start tmate session (keep VPS alive)
        run: |
          echo "üîó Starting tmate session..."
          tmate -F

  backup:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.operation == 'backup' || cancelled()
    runs-on: ubuntu-22.04
    steps:
      - name: Install rclone
        run: |
          sudo apt update
          sudo apt install -y curl unzip zip
          curl -fsSL https://downloads.rclone.org/rclone-current-linux-amd64.zip -o rclone.zip
          unzip rclone.zip
          cd rclone-*-linux-amd64
          sudo install -m 755 rclone /usr/bin/
          cd ..
          rm -rf rclone*

      - name: Configure rclone with MEGA
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [mega]
          type = mega
          user = ${MEGA_USER}
          pass = ${MEGA_PASS}
          EOF
        env:
          MEGA_USER: ${{ secrets.MEGA_USER }}
          MEGA_PASS: ${{ secrets.MEGA_PASS }}

      - name: Backup VPS data to MEGA
        run: |
          mkdir -p backup

          echo "üì¶ Collecting Tailscale state..."
          sudo cp /var/lib/tailscale/tailscaled.state backup/ || true

          echo "üë§ Collecting user data..."
          sudo tar -czf backup/home-jacky.tar.gz -C /home jacky || true

          echo "üì¶ Collecting installed apps list..."
          dpkg --get-selections > backup/installed-packages.txt

          echo "üì¶ Creating full backup archive..."
          tar -czf vps-latest.tar.gz -C backup .

          echo "‚òÅÔ∏è Uploading to MEGA..."
          rclone copy vps-latest.tar.gz mega:/vps-backup --progress

          echo "‚úÖ VPS BACKUP COMPLETED SUCCESSFULLY"
