# 🕷️ Spidey Persistent VPS - Optimized with Graceful Shutdown

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

env:
  BACKUP_STORE: /var/backups/vps
  BACKUP_NAME: vps-backup-latest.tar.gz
  MEGA_REMOTE: mega:vps-backup

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 350
    steps:
      - name: '🕸️ Checkout Code'
        uses: actions/checkout@v4

      - name: '⚡ Install System Tools, Rclone & tmate'
        run: |
          echo "🚀 Installing core system tools, rclone, and tmate..."
          sudo apt-get update
          sudo apt-get install -y psmisc screen openssh-server mariadb-server apache2 php php-mysql tmate
          curl -fsSL https://rclone.org/install.sh | sudo bash
          sudo systemctl enable --now ssh
          echo "✅ Core tools, rclone, and tmate installed."

      - name: '♻️ Restore from Backup OR Initialize'
        id: restore
        run: |
          echo "🔍 Checking for existing backup on MEGA..."
          if rclone ls ${MEGA_REMOTE}/${BACKUP_NAME} >/dev/null 2>&1; then
            echo "✅ Backup found. Restoring system state..."
            rclone copy ${MEGA_REMOTE}/${BACKUP_NAME} /tmp/
            sudo tar -xzpf /tmp/${BACKUP_NAME} --absolute-names -C /
            echo "🗑️ Deleting old backup from MEGA to prevent reuse on next run..."
            rclone delete ${MEGA_REMOTE}/${BACKUP_NAME}
            echo "is_new_install=false" >> $GITHUB_OUTPUT
          else
            echo "ℹ️ No backup found. This will be a fresh installation."
            sudo mkdir -p /home/jacky /opt /srv /var/www /var/lib/mysql /www/server
            echo "is_new_install=true" >> $GITHUB_OUTPUT
          fi

      - name: '👤 Initial Setup: Create User, Set Hostname & Aapanel'
        if: steps.restore.outputs.is_new_install == 'true'
        run: |
          echo "🚀 Performing first-time setup for a new VPS..."
          sudo useradd -m -s /bin/bash jacky || true
          echo "jacky:root" | sudo chpasswd
          sudo usermod -aG sudo jacky
          echo "jacky ALL=(ALL:ALL) ALL" | sudo tee /etc/sudoers.d/jacky
          sudo hostnamectl set-hostname github-vps
          curl -sSLo /tmp/install.sh http://www.aapanel.com/script/install-ubuntu_6.0_en.sh
          (echo "y" && echo "yes") | sudo bash /tmp/install.sh
          echo "✅ Initial setup complete."

      - name: '🚀 Start System Services'
        run: |
          set -e
          echo "🔄 (Re)loading system services..."
          sudo systemctl daemon-reload
          sudo systemctl restart mariadb apache2 || true
          sudo bt restart || true
          echo "✅ Core services (MariaDB, Apache, Aapanel) are running."

      - name: '🔗 Configure Remote Access & Credentials'
        run: |
          if [ "${{ steps.restore.outputs.is_new_install }}" == "true" ]; then
            echo "🔐 Setting default Aapanel username and password..."
            sleep 15
            echo "jacky" | sudo bt 6
            echo "spidey" | sudo bt 5
            echo "✅ Aapanel username set to 'jacky' and password to 'spidey'."
          fi
          
          echo "🕸️ Installing and starting Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo systemctl enable --now tailscaled
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=github-vps --reset
          
          echo "💬 Starting tmate session for direct SSH access..."
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          
          echo "---"
          echo "✅ VPS IS READY FOR CONNECTION ✅"
          echo "---"
          echo "🌐 Tailscale IP: $(sudo tailscale ip -4)"
          echo "🔑 tmate SSH: $(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')"
          echo "---"

      # This step now actively waits for a shutdown signal, allowing for graceful termination.
      - name: '⏳ Maintain VPS Session'
        run: |
          echo "🖥️ VPS is now running. To stop gracefully and trigger a backup, run this command in the VPS: touch /tmp/stop_session"
          # Loop for 330 minutes (5.5 hours), checking for the stop file every 60 seconds.
          # This leaves enough time for backup before the 350-minute job timeout.
          for i in {1..330}; do
            if [ -f /tmp/stop_session ]; then
              echo "🛑 Stop signal detected. Proceeding to backup..."
              break
            fi
            sleep 60
          done

      # The backup steps now run on success OR failure, but NOT on cancellation.
      - name: '📦 Create Final Backup'
        if: success() || failure()
        run: |
          echo "📦 Creating final backup archive..."
          sudo mkdir -p ${{ env.BACKUP_STORE }}
          sudo tar -czpf ${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }} \
            --absolute-names \
            --ignore-failed-read \
            /etc/hostname \
            /etc/hosts \
            /etc/systemd/system \
            /var/lib/tailscale \
            /opt \
            /srv \
            /var/www \
            /etc/ssh \
            /etc/apache2 \
            /www/server \
            /root \
            /home/jacky \
            /usr/lib/systemd/system \
            /var/lib/mysql \
            /etc/sudoers.d/ \
            /usr/bin/bt \
            || true
          echo "✅ Final backup created."

      - name: '☁️ Upload Final Backup to MEGA'
        if: success() || failure()
        run: |
          echo "🚀 Uploading final backup to MEGA..."
          rclone copy ${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }} ${{ env.MEGA_REMOTE }} --progress
          echo "✅ Final backup uploaded successfully."
          
      - name: '📝 Final Status Report'
        if: always()
        run: |
          echo "========================="
          echo "  VPS Session Concluded  "
          echo "========================="
          echo "Final job status: ${{ job.status }}"
          if [[ "${{ job.status }}" == "success" || "${{ job.status }}" == "failure" ]]; then
            echo "Backup uploaded to: ${{ env.MEGA_REMOTE }}/${{ env.BACKUP_NAME }}"
          else
            echo "Job was cancelled. Backup steps were skipped."
          fi
          echo "========================="
