# GitHub Actions Workflow for Persistent VPS Session - Ben 10 Edition! ğŸ›¸ğŸ‘½
# Required Secrets:
# - TAILSCALE_AUTHKEY: Tailscale authentication key (string)
# - MEGA_RCLONE: Base64-encoded rclone configuration text for MEGA remote
# - DB_ROOT_PASSWORD: Root password for MariaDB (string)

name: Persistent VPS - Ben 10 Alien Force

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 400
    steps:
      - name: Checkout repository ğŸ›’
        uses: actions/checkout@v4

      - name: Prepare environment ğŸš€ Omnitrix Loading!
        run: |
          set -euo pipefail
          echo "ğŸ‘½ Ben 10 transforming! Installing packages... ğŸ”¥"
          sudo apt update || { echo "ğŸ˜± Apt update failed! Alien invasion detected!"; exit 1; }
          sudo apt install -y rclone jq tar gzip expect mariadb-server wget curl tmate || { echo "ğŸš¨ Package install error! Call Grandpa Max!"; exit 1; }
          echo "ğŸ¦¸ Tailscale install initiating... Four Arms punching through!"
          curl -fsSL https://tailscale.com/install.sh | sh || { echo "ğŸ˜¤ Tailscale install failed! Try Heatblast next time."; exit 1; }
          echo "ğŸ” Decoding rclone config... XLR8 speed mode! âš¡"
          mkdir -p ~/.config/rclone
          echo "${{ secrets.MEGA_RCLONE }}" | base64 -d > ~/.config/rclone/rclone.conf || { echo "ğŸ¤¯ Decode failed! Diamondhead unbreakable error."; exit 1; }
          echo "ğŸ‰ Environment ready! It's Hero Time! ğŸ•°ï¸"

      - name: Create user and set hostname ğŸ‘¤ Spidey Alien Unlocked!
        run: |
          set -euo pipefail
          echo "ğŸ•·ï¸ Creating user jacky... Swampfire growing roots!"
          id -u jacky &>/dev/null || sudo useradd -m -s /bin/bash jacky || { echo "ğŸ˜  Useradd failed! Echo Echo duplicating errors."; exit 1; }
          echo "jacky:spidey" | sudo chpasswd || { echo "ğŸ”‘ Chpasswd error! Ghostfreak haunting passwords."; exit 1; }
          sudo usermod -aG sudo jacky || { echo "ğŸ‘¥ Usermod failed! Big Chill freezing groups."; exit 1; }
          sudo hostnamectl set-hostname Spidey || { echo "ğŸ·ï¸ Hostname set failed! Upgrade to Ultimate Spidey."; exit 1; }
          echo "âœ… User and hostname set! Ben 10 wins again! ğŸ†"

      - name: Install aaPanel ğŸ› ï¸ Panel Power-Up!
        run: |
          set -euo pipefail
          echo "ğŸ“¦ Fetching aaPanel installer... Jetray flying in! âœˆï¸"
          /usr/bin/expect <<EOF
          set timeout 300
          spawn bash -c "URL=https://www.aapanel.com/script/install_7.0_en.sh && if [ -f /usr/bin/curl ];then curl -ksSO \"\\\$URL\" ;else wget --no-check-certificate -O install_7.0_en.sh \"\\\$URL\";fi;bash install_7.0_en.sh"
          expect {
            "install panel" { send "y\r"; exp_continue }
            "force install" { send "yes\r"; exp_continue }
            eof
          }
          EOF
          if [ $? -ne 0 ]; then
            echo "ğŸ’¥ aaPanel install exploded! Chromastone absorbing failure."
            exit 1
          fi
          echo "ğŸŒŸ aaPanel installed! Time to go hero! ğŸ’ª"

      - name: Restore or provision ğŸ”„ Omnitrix Scan for Backups!
        run: |
          set -euo pipefail

          # Define directories to backup/restore
          DIRS=("/home" "/root" "/etc/mysql" "/etc/systemd/system" "/var/www" "/opt" "/www" "/var/lib/tailscale" "/var/lib/mysql")
          echo "ğŸ“ Directories targeted: ${DIRS[@]} ... Brainstorm calculating! ğŸ§ "

          # Function to download from artifact
          download_from_artifact() {
            echo "ğŸ” Searching GitHub artifacts... Wildmutt sniffing! ğŸ•"
            GITHUB_TOKEN="${{ github.token }}"
            REPO="${{ github.repository }}"
            curl -s -H "Accept: application/vnd.github.v3+json" -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/$REPO/actions/artifacts?per_page=100" > artifacts.json || { echo "ğŸŒ Curl failed! Nanomech tiny error."; return 1; }
            ARTIFACT_ID=$(jq -r '.artifacts | sort_by(.created_at) | reverse | .[] | select(.name == "vps-backup") | .id' artifacts.json | head -1)
            if [ -z "$ARTIFACT_ID" ]; then
              echo "âŒ No artifact found! Rath smashing disappointment! ğŸ˜¡"
              return 1
            fi
            echo "ğŸ¯ Found artifact ID: $ARTIFACT_ID ... Armodrillo drilling down!"
            curl -s -H "Accept: application/vnd.github.v3+json" -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/$REPO/actions/artifacts/$ARTIFACT_ID" > artifact.json || { echo "ğŸ“„ Artifact info fetch failed!"; return 1; }
            DOWNLOAD_URL=$(jq -r '.archive_download_url' artifact.json)
            curl -L -o artifact.zip -H "Authorization: token $GITHUB_TOKEN" "$DOWNLOAD_URL" || { echo "â¬‡ï¸ Download failed! Water Hazard flooding errors."; return 1; }
            unzip -q artifact.zip -d temp_artifact || { echo "ğŸ¤ Unzip error!"; return 1; }
            mv temp_artifact/*.tar.gz backup.tar.gz || { echo "ğŸšš Move failed!"; return 1; }
            rm -rf temp_artifact artifact.zip artifacts.json artifact.json
            echo "âœ… Artifact downloaded! Heroic success! ğŸ¦¸â€â™‚ï¸"
            return 0
          }

          # Function to download from MEGA
          download_from_mega() {
            echo "â˜ï¸ Listing MEGA backups... Stinkfly scouting! ğŸ¦Ÿ"
            rclone lsjson mega:vps-backups/ > files.json || { echo "ğŸ“‹ Rclone lsjson failed!"; return 1; }
            LATEST_FILE=$(jq -r '[ .[] | select(.Name | endswith(".tar.gz")) ] | sort_by(.ModifiedTime) | reverse | .[0].Name' files.json)
            if [ -z "$LATEST_FILE" ] || [ "$LATEST_FILE" = "null" ]; then
              echo "ğŸš« No MEGA backup found! Goop slipping away."
              return 1
            fi
            echo "ğŸ“¥ Downloading $LATEST_FILE ... AmpFibian electrifying! âš¡"
            rclone copy "mega:vps-backups/$LATEST_FILE" . || { echo "ğŸ”„ Rclone copy failed!"; return 1; }
            mv "$LATEST_FILE" backup.tar.gz
            rm files.json
            echo "âœ… MEGA download complete! Alien force united!"
            return 0
          }

          # Function to restore from backup.tar.gz
          perform_restore() {
            echo "ğŸ› ï¸ Extracting backup... Humungousaur strength! ğŸ’¥"
            mkdir -p restore_dir
            tar xzf backup.tar.gz -C restore_dir || { echo "ğŸ“¦ Tar extract failed!"; exit 1; }
            echo "ğŸ›‘ Stopping services... Kickin' Hawk pausing! ğŸ¦…"
            sudo systemctl stop mariadb tailscaled || true
            sudo bt stop || true
            echo "ğŸ“‚ Restoring files... Lodestar guiding! â­"
            sudo cp -rp restore_dir/* / || { echo "ğŸ“ Copy failed! Terraspin spinning errors."; exit 1; }
            echo "ğŸ”’ Setting permissions... Cannonbolt rolling secure! ğŸ”´"
            sudo chown -R mysql:mysql /var/lib/mysql
            sudo chown -R root:root /var/lib/tailscale
            sudo chown -R www:www /www || true  # Assuming aaPanel uses www user/group
            echo "ğŸ”„ Reloading services... Feedback amplifying! ğŸ“¢"
            sudo systemctl daemon-reload
            sudo systemctl start mariadb || { echo "ğŸš¨ MariaDB start failed!"; exit 1; }
            sudo systemctl start tailscaled || { echo "ğŸš¨ Tailscaled start failed!"; exit 1; }
            sudo tailscale up || true  # Reconnect with restored state
            sudo bt restart || true
            echo "ğŸ©º Health checks incoming... Clockwork timing! â°"
            sleep 10
            sudo systemctl status mariadb --no-pager || echo "ğŸ˜· MariaDB health check failed - Call Dr. Animo!"
            tailscale status || echo "ğŸ˜· Tailscale health check failed - Vilgax attack?"
            sudo bt default || echo "ğŸ˜· aaPanel health check failed - Plumber alert!"
            rm -rf restore_dir backup.tar.gz
            echo "ğŸŠ Restore complete! Ben 10 saves the day! ğŸŒŸ"
          }

          # Function for fresh provision
          perform_fresh() {
            echo "ğŸ†• Starting fresh provision... Ripjaws diving in! ğŸ¦ˆ"
            # Set aaPanel credentials
            sudo bt 5 Jacky || { echo "ğŸ‘¤ aaPanel username set failed!"; exit 1; }
            sudo bt 6 spidey || { echo "ğŸ”‘ aaPanel password set failed!"; exit 1; }
            DB_PASS="${{ secrets.DB_ROOT_PASSWORD }}"
            echo "ğŸ—ï¸ Setting MariaDB root password... Grey Matter intelligence! ğŸ§ "
            sudo mysql -u root <<EOF
            ALTER USER 'root'@'localhost' IDENTIFIED BY '$DB_PASS';
            FLUSH PRIVILEGES;
            EOF
            if [ $? -ne 0 ]; then
              echo "ğŸ›‘ MySQL command failed! Alien X rewriting reality?"
              exit 1
            fi
            echo "ğŸ“Š Creating test database... Way Big stomping! ğŸ‘£"
            mysql -u root -p"$DB_PASS" -e "CREATE DATABASE IF NOT EXISTS test;" || { echo "ğŸ—ï¸ Database create failed!"; exit 1; }
            echo "ğŸŒ Starting Tailscale... Blitzwolfer howling! ğŸº"
            sudo tailscale up --authkey "${{ secrets.TAILSCALE_AUTHKEY }}" || { echo "ğŸ”— Tailscale up failed!"; exit 1; }
            # Immediate backup of new Tailscale state to MEGA
            cd /tmp
            echo "ğŸ’¾ Backing up Tailscale state... Snare-oh wrapping! ğŸ§»"
            sudo tar czf tailscale-state.tar.gz /var/lib/tailscale || { echo "ğŸ“¦ Tar failed!"; exit 1; }
            rclone copy tailscale-state.tar.gz mega:vps-backups/ || { echo "â˜ï¸ Rclone upload failed!"; exit 1; }
            rm tailscale-state.tar.gz
            # Start services (already started, but ensure)
            sudo systemctl start mariadb || { echo "ğŸš¨ MariaDB start failed!"; exit 1; }
            sudo bt restart || true
            echo "ğŸš€ Fresh provision done! Ultimate Ben 10,000! ğŸ”®"
          }

          # Attempt restores or fresh
          echo "ğŸ•µï¸ Attempting artifact restore... Eye Guy watching! ğŸ‘€"
          if download_from_artifact; then
            perform_restore
            echo "ğŸ”™ Restored from GitHub artifact - Time travel success!"
          else
            echo "ğŸ”„ Falling back to MEGA... Frankenstrike shocking! âš¡"
            if download_from_mega; then
              perform_restore
              echo "ğŸ”™ Restored from MEGA - Backup heroes!"
            else
              perform_fresh
              echo "ğŸ†• Performed fresh provision - New alien unlocked!"
            fi
          fi

      - name: Run persistent session â³ Session in Alien Mode!
        run: |
          set -euo pipefail

          # Define directories for backup (same as above)
          DIRS=("/home" "/root" "/etc/mysql" "/etc/systemd/system" "/var/www" "/opt" "/www" "/var/lib/tailscale" "/var/lib/mysql")
          echo "ğŸ“ Backup dirs: ${DIRS[@]} ... Computron computing! ğŸ¤–"

          # Function to perform backup
          perform_backup() {
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            BACKUP_FILE="/tmp/vps-backup-$TIMESTAMP.tar.gz"
            MANIFEST="/tmp/backup-manifest.txt"
            echo "ğŸ“ Creating manifest... Ditto duplicating! ğŸ‘¥"
            cat <<EOF > $MANIFEST
           Backed up directories:
           $(printf "%s\n" "${DIRS[@]}")
            EOF
            cd /
            echo "ğŸ”’ Tarring files... Ball Weevil rolling! ğŸŸ¡"
            sudo tar czf "$BACKUP_FILE" "$MANIFEST" "${DIRS[@]}" || { echo "ğŸ’¥ Tar failed! Crashhopper jumping errors."; exit 1; }
            rm "$MANIFEST"
            echo "$BACKUP_FILE" > /tmp/backup_file_path.txt
            echo "âœ… Backup created: $BACKUP_FILE - Saved the universe! ğŸŒŒ"
          }

          # Start tmate for debugging
          echo "ğŸ”§ Starting tmate debug session... Pesky Dust sprinkling! ğŸ§š"
          tmate -F &

          # Run loop for ~6 hours (21600 seconds), check every 5 minutes (300 seconds)
          END_TIME=$(( $(date +%s) + 21600 ))
          echo "â±ï¸ Starting session loop... Chromastone absorbing time! ğŸ’"
          while [ $(date +%s) -lt $END_TIME ]; do
            if [ -f /tmp/stop ]; then
              echo "ğŸ›‘ Graceful shutdown triggered! Toepick scaring off! ğŸ˜±"
              perform_backup
              break
            fi
            echo "ğŸ”„ Loop check... Still going strong! NRG energizing! â˜¢ï¸"
            sleep 300
          done

          # Final backup if not already done
          if [ ! -f /tmp/backup_file_path.txt ]; then
            echo "ğŸ›¡ï¸ Final backup initiating... Ultimos supreme! ğŸ¦¸â€â™‚ï¸"
            perform_backup
          fi

      - name: Set backup file path environment variable ğŸ“¥ Prep Artifact Upload!
        run: |
          set -euo pipefail
          echo "ğŸ”§ Setting backup path... Upgrade transforming! ğŸ”§"
          BACKUP_FILE=$(cat /tmp/backup_file_path.txt || echo "/tmp/vps-backup-default.tar.gz")
          echo "BACKUP_PATH=$BACKUP_FILE" >> $GITHUB_ENV

      - name: Upload backup as GitHub artifact ğŸ“¤ Artifact Beam!
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: vps-backup
          path: ${{ env.BACKUP_PATH }}
          retention-days: 7  # Short retention to avoid accumulation
        # Note: Imagine: echo "ğŸš€ Uploading to GitHub... Skurd attaching!"

      - name: Upload backup to MEGA and generate link â˜ï¸ MEGA Warp!
        if: always()
        run: |
          set -euo pipefail
          BACKUP_FILE=$(cat /tmp/backup_file_path.txt)
          if [ -f "$BACKUP_FILE" ]; then
            echo "ğŸ“¤ Uploading to MEGA... Gravattack pulling! ğŸª"
            rclone copy "$BACKUP_FILE" mega:vps-backups/ || { echo "â˜ï¸ Rclone copy failed! Atomix atomic error."; exit 1; }
            FILENAME=$(basename "$BACKUP_FILE")
            echo "ğŸ”— Generating link... Buzzshock buzzing! âš¡"
            LINK=$(rclone link "mega:vps-backups/$FILENAME") || { echo "ğŸ”— Link failed!"; exit 1; }
            echo "$LINK" > mega-backup-link.txt
            echo "âœ… MEGA upload and link ready! Ben 10 ultimate victory! ğŸ‰"
          else
            echo "ğŸš« No backup file found, skipping MEGA upload - Feedback loop broken?"
          fi

      - name: Upload MEGA link as artifact ğŸ“ Link Artifact!
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mega-backup-link
          path: mega-backup-link.txt
          retention-days: 7
        # Note: Imagine echo "ğŸ“ Uploading link... Walkatrout swimming upstream! ğŸŸ"
