name: ðŸ•·ï¸ Spidey Persistent VPS - Enhanced

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Daily backup at midnight

env:
  PERSISTENT_DIR: /opt/persistent-vps
  BACKUP_NAME: vps-backup-latest.tar.gz

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      # ðŸ•¸ï¸ Checkout Repo
      - name: ðŸ•¸ï¸ Checkout
        uses: actions/checkout@v4

      # âš¡ Install Required Tools
      - name: âš¡ Install System Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget unzip tar psmisc lsof

      # âš¡ Install Rclone
      - name: âš¡ Install Rclone
        run: |
          curl -fsSL https://rclone.org/install.sh | sudo bash
          rclone version

      # â˜ï¸ Configure Rclone MEGA
      - name: â˜ï¸ Configure Rclone (MEGA)
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [mega]
          type = mega
          user = ${{ secrets.MEGA_USER }}
          pass = ${{ secrets.MEGA_PASS }}
          EOF

      # â™»ï¸ Restore VPS from Backup (if exists)
      - name: â™»ï¸ Restore From MEGA
        run: |
          echo "ðŸ” Checking for existing backup..."
          if rclone ls mega:vps-backup/$BACKUP_NAME >/dev/null 2>&1; then
            echo "ðŸ“¥ Downloading VPS backup..."
            rclone copy mega:vps-backup/$BACKUP_NAME .
            
            echo "ðŸ›‘ Stopping services that might interfere with restore..."
            sudo pkill -f "tmate" || true
            sudo pkill -f "tailscale" || true
            
            echo "ðŸ”“ Unpacking backup..."
            sudo mkdir -p $PERSISTENT_DIR
            sudo tar -xzf $BACKUP_NAME -C $PERSISTENT_DIR
            
            # Restore system files
            if [ -f "$PERSISTENT_DIR/etc/hostname" ]; then
              sudo cp $PERSISTENT_DIR/etc/hostname /etc/hostname
            fi
            
            if [ -f "$PERSISTENT_DIR/etc/hosts" ]; then
              sudo cp $PERSISTENT_DIR/etc/hosts /etc/hosts
            fi
            
            echo "âœ… Restore complete"
          else
            echo "â„¹ï¸ No previous backup found. Starting fresh!"
            sudo mkdir -p $PERSISTENT_DIR
          fi

      # ðŸ‘¤ Create Jacky User + Set Hostname
      - name: ðŸ‘¤ Setup User & Hostname
        run: |
          if ! id -u jacky >/dev/null 2>&1; then
            sudo useradd -m -s /bin/bash jacky
            echo "jacky:root" | sudo chpasswd
            sudo usermod -aG sudo jacky
          fi
          
          # Restore home directory if it exists in backup
          if [ -d "$PERSISTENT_DIR/home/jacky" ]; then
            echo "ðŸ”„ Restoring jacky home directory..."
            sudo rsync -a $PERSISTENT_DIR/home/jacky/ /home/jacky/
            sudo chown -R jacky:jacky /home/jacky
          fi
          
          sudo hostnamectl set-hostname github-vps
          echo "âœ… User jacky ready (password: root)"
          echo "âœ… Hostname set to github-vps"

      # ðŸ•¸ï¸ Tailscale Setup with State Restoration
      - name: ðŸ•¸ï¸ Tailscale Setup
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo systemctl enable --now tailscaled

          # Restore Tailscale state if available
          if [ -d "$PERSISTENT_DIR/var/lib/tailscale" ]; then
            echo "â™»ï¸ Restoring Tailscale state..."
            sudo systemctl stop tailscaled
            sudo rsync -a $PERSISTENT_DIR/var/lib/tailscale/ /var/lib/tailscale/
            sudo systemctl start tailscaled
            sleep 3
            sudo tailscale up --hostname=github-vps --reset || true
          else
            echo "ðŸ†• No Tailscale state found, using fresh auth key..."
            sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=github-vps || true
          fi

          echo "âœ… Tailscale setup complete"
          echo "ðŸŒ Tailscale IP: $(sudo tailscale ip -4 || echo 'Not available')"

      # ðŸ”§ Restore System Services
      - name: ðŸ”§ Restore System Services
        run: |
          echo "ðŸ”§ Restoring system services..."
          
          # Restore systemd services if they exist
          if [ -d "$PERSISTENT_DIR/etc/systemd/system" ]; then
            sudo rsync -a $PERSISTENT_DIR/etc/systemd/system/ /etc/systemd/system/
            sudo systemctl daemon-reload
          fi
          
          # Start common services that should persist
          if [ -f "/etc/systemd/system/persistent-service.service" ]; then
            sudo systemctl enable --now persistent-service.service
          fi
          
          echo "âœ… Services restored"

      # ðŸ›°ï¸ Start Tmate Session with Persistent Socket
      - name: ðŸ›°ï¸ Start Persistent Tmate Session
        run: |
          # Install tmate
          sudo apt-get install -y tmate
          
          # Set up tmate with persistent socket
          TMATE_SOCK="/tmp/tmate.sock"
          TMATE_SESSION_NAME="github-vps-$(date +%s)"
          
          # Kill any existing tmate sessions
          sudo pkill -f "tmate" || true
          
          # Start tmate in a background screen session with persistent socket
          sudo -u jacky bash -c "cd /home/jacky && tmate -S $TMATE_SOCK new-session -d -s $TMATE_SESSION_NAME"
          sleep 3
          
          # Display connection information
          sudo -u jacky bash -c "tmate -S $TMATE_SOCK display -p '#{tmate_ssh}'" | head -1
          sudo -u jacky bash -c "tmate -S $TMATE_SOCK display -p '#{tmate_web}'" | head -1
          
          # Keep the session alive in background
          echo "ðŸ›°ï¸ Tmate session started with persistent socket: $TMATE_SOCK"

      # ðŸ• Keep Alive Mechanism
      - name: ðŸ• Keep Session Alive
        run: |
          # This step will run for the duration of the job timeout
          echo "â° Session keep-alive active. Press Ctrl+C to stop the session."
          echo "ðŸ“ The VPS will be automatically backed up when the session ends."
          
          # Infinite loop to keep the job running
          while true; do
            sleep 300
            echo "ðŸ”„ Session heartbeat: $(date)"
          done

      # ðŸ’¾ Create Backup (on success or failure)
      - name: ðŸ’¾ Create Backup
        if: always()
        run: |
          echo "ðŸ›‘ Preparing system for backup..."
          
          # Stop services that might interfere with backup
          sudo systemctl stop tailscaled || true
          sudo pkill -f "tmate" || true
          
          echo "ðŸ“¦ Creating backup archive..."
          sudo mkdir -p $PERSISTENT_DIR
          
          # Backup important directories
          sudo tar --ignore-failed-read -czf /tmp/backup.tar.gz \
            /home/jacky \
            /etc/hostname \
            /etc/hosts \
            /etc/systemd/system \
            /var/lib/tailscale \
            /opt \
            /srv \
            /var/www 2>/dev/null || true
          
          # Move to persistent directory
          sudo mv /tmp/backup.tar.gz $PERSISTENT_DIR/$BACKUP_NAME
          echo "âœ… Backup created: $PERSISTENT_DIR/$BACKUP_NAME"

      # â˜ï¸ Upload Backup to MEGA
      - name: â˜ï¸ Upload Backup to MEGA
        if: always()
        run: |
          echo "ðŸš€ Uploading backup to MEGA..."
          rclone copy $PERSISTENT_DIR/$BACKUP_NAME mega:vps-backup/ --progress
          echo "âœ… Backup uploaded successfully"

      # ðŸ“ Final Status Report
      - name: ðŸ“ Status Report
        if: always()
        run: |
          echo "=== VPS STATUS REPORT ==="
          echo "Hostname: $(hostname)"
          echo "User: jacky (password: root)"
          echo "Tailscale IP: $(sudo tailscale ip -4 2>/dev/null || echo 'Not configured')"
          echo "Backup Status: ${{ job.status }}"
          echo "========================="
