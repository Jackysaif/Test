name: Persistent VPS with Backup & Restore

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # every 6 hours

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y unzip curl tar
          curl -Of https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip -a rclone-current-linux-amd64.zip
          cd rclone-*-linux-amd64
          sudo cp rclone /usr/bin/
          sudo chown root:root /usr/bin/rclone
          sudo chmod 755 /usr/bin/rclone
          rclone version

      - name: Create user jacky
        run: |
          if ! id -u jacky >/dev/null 2>&1; then
            sudo useradd -m -s /bin/bash jacky
            echo "jacky:root" | sudo chpasswd
            sudo usermod -aG sudo jacky
            echo "jacky ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/jacky
            echo "User jacky created with password root"
          else
            echo "User jacky already exists"
          fi

      - name: Configure rclone for MEGA
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [mega]
          type = mega
          user = ${{ secrets.MEGA_USER }}
          pass = ${{ secrets.MEGA_PASS }}
          EOF
          rclone ls mega:/ || echo "‚ö†Ô∏è Could not list MEGA (empty or wrong creds)"

      - name: Restore backup if available
        run: |
          mkdir -p restore
          if rclone copy mega:/vps-backup/latest.tar.gz restore/ --progress; then
            echo "‚úÖ Backup found, restoring..."
            sudo tar -xzf restore/latest.tar.gz -C /
          else
            echo "‚ÑπÔ∏è No previous backup found"
          fi

      - name: Setup Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --hostname=github-vps --ssh
          echo "üéâ Connected to Tailscale!"
          tailscale ip -4
          echo "üë§ Username: jacky"
          echo "üîë Password: root"

      - name: Backup VPS data
        if: always()
        run: |
          mkdir -p backup
          echo "üì¶ Creating backup archive..."
          sudo tar --exclude='*.tar.gz' -czf backup/latest.tar.gz \
            /home/jacky \
            /root \
            /var/lib/tailscale 2>/dev/null || true
          ls -lh backup/

      - name: Upload backup to MEGA
        if: always()
        run: |
          echo "‚òÅÔ∏è Uploading backup to MEGA..."
          rclone mkdir mega:/vps-backup || true
          rclone copy backup/latest.tar.gz mega:/vps-backup --progress
          echo "‚úÖ Backup uploaded to MEGA"
