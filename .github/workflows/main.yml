
name: ğŸ•·ï¸ Spidey's Persistent VPS Session
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 400  # 6.5 hours to cover session + overhead
    
    steps:
    - name: ğŸ•·ï¸ Spidey's Web is Starting Up!
      run: |
        echo "ğŸ•·ï¸ ==============================================="
        echo "ğŸ•¸ï¸  Welcome to Spidey's VPS Session! ğŸ•¸ï¸"
        echo "ğŸ•·ï¸ ==============================================="
        echo "ğŸš€ Time: $(date)"
        echo "ğŸŒŸ Session will run for ~6 hours"
        echo "ğŸ”§ Setting up the web..."
        
    - name: ğŸ› ï¸ Install Essential Spider Tools
      run: |
        echo "ğŸ•·ï¸ Installing rclone for web-slinging backups..."
        sudo apt-get update -qq
        sudo apt-get install -y rclone curl wget expect
        echo "âœ… Spidey's tools are ready!"

    - name: ğŸ•¸ï¸ Configure MEGA Web Connection
      run: |
        echo "ğŸ•·ï¸ Setting up MEGA connection for Spidey's backup web..."
        mkdir -p ~/.config/rclone
        echo "${{ secrets.RCLONE_CONFIG }}" | base64 -d > ~/.config/rclone/rclone.conf || \
        echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf
        echo "âœ… MEGA web connection established!"

    - name: ğŸ” Spider-Sense:Checking for Previous Backup
      id: restore_check
      run: |
        echo "ğŸ•·ï¸ Spider-sense is tingling... checking for backups..."
        RESTORE_SUCCESS=false
        
        # Try GitHub artifact first
        echo "ğŸ” Searching GitHub's web for artifacts..."
        if gh api repos/${{ github.repository }}/actions/artifacts --paginate | jq -r '.artifacts[] | select(.name=="vps-backup") | .archive_download_url' | head -1 > /tmp/artifact_url && [ -s /tmp/artifact_url ]; then
          echo "ğŸ¯ Found GitHub artifact! Downloading..."
          if wget -O vps-backup.tar.gz "$(cat /tmp/artifact_url)" 2>/dev/null; then
            echo "ğŸ“¦ Extracting Spidey's backup..."
            if sudo tar -xzf vps-backup.tar.gz -C / 2>/dev/null; then
              echo "âœ… GitHub backup restored successfully!"
              RESTORE_SUCCESS=true
            fi
          fi
        fi
        
        # Fallback to MEGA
        if [ "$RESTORE_SUCCESS" = "false" ]; then
          echo "ğŸ•¸ï¸ Trying MEGA backup..."
          if rclone copy mega:spidey-vps/latest-backup.tar.gz . 2>/dev/null; then
            echo "ğŸ“¦ Extracting MEGA backup..."
            if sudo tar -xzf latest-backup.tar.gz -C / 2>/dev/null; then
              echo "âœ… MEGA backup restored!"
              RESTORE_SUCCESS=true
            fi
          fi
        fi
        
        if [ "$RESTORE_SUCCESS" = "false" ]; then
          echo "ğŸ†• No backup found - fresh Spidey installation incoming!"
        fi
        
        echo "restore_success=$RESTORE_SUCCESS" >> $GITHUB_OUTPUT
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ  Set Hostname to Spidey
      run: |
        echo "ğŸ•·ï¸ Setting hostname to Spidey..."
        sudo hostnamectl set-hostname Spidey
        echo "âœ… I am Spidey!"

    - name: ğŸ‘¤ Create Spidey User (Jacky)
      run: |
        echo "ğŸ•·ï¸ Creating user 'jacky' with spider powers..."
        if ! id jacky 2>/dev/null; then
          sudo useradd -m -s /bin/bash jacky
          echo "jacky:spidey" | sudo chpasswd
          sudo usermod -aG sudo jacky
          echo "âœ… User jacky created with password 'spidey' and sudo powers!"
        else
          echo "ğŸ‘‹ User jacky already exists!"
        fi

    - name: ğŸ•¸ï¸ Install Tailscale (Spider Network)
      run: |
        echo "ğŸ•·ï¸ Installing Tailscale for spider web networking..."
        curl -fsSL https://tailscale.com/install.sh | sh
        echo "âœ… Tailscale installed!"
        
        # Try to restore Tailscale state first
        if [ -f /var/lib/tailscale/tailscaled.state.bak ]; then
          echo "ğŸ”„ Restoring previous Tailscale identity..."
          sudo cp /var/lib/tailscale/tailscaled.state.bak /var/lib/tailscale/tailscaled.state
        fi
        
        echo "ğŸš€ Starting Tailscale..."
        sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTHKEY }}" || true
        
        # Backup new state
        sudo cp /var/lib/tailscale/tailscaled.state /var/lib/tailscale/tailscaled.state.bak 2>/dev/null || true
        echo "âœ… Spider web network activated!"

    - name: ğŸ¬ Install MariaDB (Spider Database)
      run: |
        echo "ğŸ•·ï¸ Installing MariaDB for Spidey's data web..."
        sudo apt-get install -y mariadb-server mariadb-client
        
        echo "ğŸ”§ Configuring MariaDB..."
        sudo systemctl start mariadb
        sudo systemctl enable mariadb
        
        # Set root password
        sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '${{ secrets.DB_ROOT_PASSWORD }}';" || true
        sudo mysql -u root -p${{ secrets.DB_ROOT_PASSWORD }} -e "CREATE DATABASE IF NOT EXISTS test;" || true
        
        echo "âœ… MariaDB is spinning in Spidey's web!"

    - name: ğŸ›ï¸ Install aaPanel (Spidey Control Center)
      if: steps.restore_check.outputs.restore_success == 'false'
      run: |
        echo "ğŸ•·ï¸ Installing aaPanel v7.0 - Spidey's control center!"
        
        # Get latest aaPanel installer
        INSTALLER_URL="https://www.aapanel.com/script/install_6.0_en.sh"
        echo "ğŸ“¥ Downloading latest aaPanel installer..."
        wget -O install_aapanel.sh "$INSTALLER_URL"
        
        echo "ğŸ¤– Creating automated installation script..."
        cat > install_aapanel_auto.sh << 'EOF'
        #!/bin/bash
        echo "ğŸ•·ï¸ Starting automated aaPanel installation..."

        # Create expect script for automated responses
        expect << 'EXPECT_EOF'
        set timeout 300
        spawn bash install_aapanel.sh

        expect {
        "Do you want to install aaPanel to the /www directory now*" {
        send "y\r"
        exp_continue
    }
    "*enter y to install panel*" {
        send "y\r"
        exp_continue
    }
    "*Force installation*" {
        send "yes\r"
        exp_continue
    }
    "*Force Install*" {
        send "yes\r"
        exp_continue
    }
    "*force install*" {
        send "yes\r"
        exp_continue
    }
    "*install panel*" {
        send "y\r"
        exp_continue
    }
    eof
}
EXPECT_EOF
EOF

        chmod +x install_aapanel_auto.sh
        echo "ğŸš€ Running automated aaPanel installation..."
        sudo ./install_aapanel_auto.sh || true
        
        # Wait for installation to complete
        sleep 30
        
        echo "ğŸ”§ Configuring aaPanel credentials..."
        # Set aaPanel credentials using bt command
        sudo /www/server/panel/pyenv/bin/python /www/server/panel/BT-Panel/tools.py username Jacky || true
        sudo /www/server/panel/pyenv/bin/python /www/server/panel/BT-Panel/tools.py password spidey || true
        
        # Alternative method using bt script
        sudo bt << 'BT_EOF' || true
14
Jacky
BT_EOF
        
        sudo bt << 'BT_EOF' || true
15
spidey
BT_EOF
        
        echo "âœ… aaPanel installed and configured!"
        echo "ğŸ¯ Username: Jacky"
        echo "ğŸ” Password: spidey"

    - name: ğŸ”„ Start All Spider Services
      run: |
        echo "ğŸ•·ï¸ Starting all spider services..."
        
        # Start MariaDB
        sudo systemctl start mariadb || true
        
        # Start aaPanel if installed
        sudo systemctl start bt || true
        sudo /etc/init.d/bt start || true
        
        # Start any web services
        if [ -d "/www" ]; then
          echo "ğŸŒ aaPanel directory found, ensuring services are running..."
          sudo systemctl enable bt || true
        fi
        
        echo "âœ… All services are in the web!"

    - name: ğŸ•·ï¸ Spider Session Active - Monitor for Stop Signal
      run: |
        echo "ğŸ•·ï¸ ============================================="
        echo "ğŸ•¸ï¸  SPIDEY VPS SESSION IS NOW ACTIVE! ğŸ•¸ï¸"
        echo "ğŸ•·ï¸ ============================================="
        echo "â° Session Duration: ~6 hours"
        echo "ğŸ›‘ To stop: touch /tmp/stop"
        echo "ğŸ’¾ Auto-backup in ~5.5 hours"
        echo "ğŸ•·ï¸ ============================================="
        
        # Monitor for stop signal and run for ~5.5 hours
        START_TIME=$(date +%s)
        DURATION=$((5 * 60 * 60 + 30 * 60))  # 5.5 hours in seconds
        
        while true; do
          CURRENT_TIME=$(date +%s)
          ELAPSED=$((CURRENT_TIME - START_TIME))
          REMAINING=$((DURATION - ELAPSED))
          
          if [ -f /tmp/stop ]; then
            echo "ğŸ›‘ Stop signal detected! Spidey is preparing to backup and exit..."
            break
          fi
          
          if [ $ELAPSED -ge $DURATION ]; then
            echo "â° Time's up! Spidey session complete - preparing backup..."
            break
          fi
          
          # Show friendly status every 30 minutes
          if [ $((ELAPSED % 1800)) -eq 0 ] && [ $ELAPSED -gt 0 ]; then
            HOURS=$((REMAINING / 3600))
            MINUTES=$(((REMAINING % 3600) / 60))
            echo "ğŸ•·ï¸ Spidey status: ${HOURS}h ${MINUTES}m remaining in the web!"
          fi
          
          sleep 60
        done

    - name: ğŸ’¾ Create Spidey's Backup Web
      run: |
        echo "ğŸ•·ï¸ Creating backup of Spidey's important data..."
        
        # Create backup manifest
        cat > backup-manifest.txt << EOF
ğŸ•·ï¸ SPIDEY'S BACKUP MANIFEST ğŸ•·ï¸
Created: $(date)
Session: ${{ github.run_number }}

Included directories:
- /home (user data)
- /root (root config)
- /etc (system configs)
- /var/www (web data)
- /opt (optional software)
- /var/lib/tailscale (network state)
- /var/lib/mysql (database)
- /www (aaPanel data)
EOF
        
        echo "ğŸ“¦ Creating backup archive..."
        sudo tar -czf vps-backup.tar.gz \
          --exclude="/var/lib/mysql/mysql.sock*" \
          --exclude="/var/lib/mysql/aria_log*" \
          --exclude="/var/lib/mysql/ib_logfile*" \
          /home /root /etc /var/www /opt \
          /var/lib/tailscale /var/lib/mysql /www \
          backup-manifest.txt 2>/dev/null || true
        
        echo "âœ… Backup created: $(du -h vps-backup.tar.gz)"

    - name: ğŸ“¤ Upload to GitHub Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: vps-backup
        path: vps-backup.tar.gz
        retention-days: 30

    - name: ğŸ•¸ï¸ Upload to MEGA Web
      run: |
        echo "ğŸ•·ï¸ Uploading backup to MEGA web..."
        if rclone copy vps-backup.tar.gz mega:spidey-vps/ --progress; then
          echo "ğŸ“¤ Creating MEGA public link..."
          MEGA_LINK=$(rclone link mega:spidey-vps/vps-backup.tar.gz 2>/dev/null || echo "Link creation failed")
          echo "$MEGA_LINK" > mega-backup-link.txt
          echo "âœ… MEGA backup complete!"
          echo "ğŸ”— Link: $MEGA_LINK"
        else
          echo "âš ï¸ MEGA upload failed, but GitHub artifact backup is available!"
        fi

    - name: ğŸ•·ï¸ Spidey Session Complete!
      run: |
        echo "ğŸ•·ï¸ ============================================="
        echo "ğŸ•¸ï¸  SPIDEY'S VPS SESSION COMPLETE! ğŸ•¸ï¸"
        echo "ğŸ•·ï¸ ============================================="
        echo "âœ… Backup created and uploaded"
        echo "ğŸ“Š Session stats:"
        echo "   ğŸ•’ Duration: ~6 hours"
        echo "   ğŸ’¾ Backup size: $(du -h vps-backup.tar.gz 2>/dev/null || echo 'N/A')"
        echo "   ğŸŒ Services: MariaDB, aaPanel, Tailscale"
        echo "ğŸš€ Next session in 6 hours!"
        echo "ğŸ•·ï¸ With great power comes great responsibility!"
        echo "ğŸ•·ï¸ ============================================="
