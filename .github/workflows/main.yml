# GitHub Actions Workflow for Persistent VPS Session - Sparta Edition! âš”ï¸ğŸ›¡ï¸
# Required Secrets:
# - TAILSCALE_AUTHKEY: Tailscale authentication key (string)
# - RCLONE_CONFIG: Raw rclone configuration text for MEGA remote
# - DB_ROOT_PASSWORD: Root password for MariaDB (string)
# - USER_PASSWORD: Password for user jacky (string)

name: Persistent VPS (Sparta Edition)

on:
  schedule:
    # Runs automatically every 6 hours to refresh the session.
    - cron: '0 */6 * * *'
  workflow_dispatch:
    # Allows for manual triggering of the workflow from the Actions tab.

env:
  # Configuration for the full system backup. Using a separate mount point.
  BACKUP_STORE: /mnt/backups/vps
  BACKUP_NAME: vps-full-backup.tar.gz
  # Rclone remote and path for cloud storage.
  MEGA_REMOTE: mega:vps-backup

jobs:
  vps:
    runs-on: ubuntu-22.04
    # Set a generous timeout. GitHub Actions max is 6 hours (360 minutes).
    timeout-minutes: 350
    permissions:
      contents: read
      actions: write

    steps:
      - name: 'ğŸ•¸ï¸ Checkout Code âš”ï¸'
        uses: actions/checkout@v4

      # ------------------------------------------------------------------
      # Part 1: Initial Setup & Environment Preparation
      # ------------------------------------------------------------------

      - name: 'ğŸ”§ Install Core Tools & Rclone ğŸ›¡ï¸'
        run: |
          set -euo pipefail
          echo "ğŸŒ Updating package list... This is Sparta's preparation!"
          sudo apt-get update -qq || { echo "ğŸ˜  Apt update failed! Spartans retreat!"; exit 1; }
          echo "â˜ï¸ Installing Rclone... Messenger of the gods!"
          curl -fsSL https://rclone.org/install.sh | sudo bash || { echo "ğŸš¨ Rclone install failed! Kick into the pit!"; exit 1; }
          echo "ğŸ“¦ Installing essential system tools... Arming the warriors!"
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            tar gzip openssh-server htop nano vim git net-tools tmate jq curl \
            software-properties-common apt-transport-https ca-certificates \
            gnupg lsb-release psmisc screen mariadb-server || { echo "âš”ï¸ Package install error! Sparta falls!"; exit 1; }
          echo "ğŸ›³ï¸ Installing Docker... Building the fleet!"
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg || { echo "ğŸ”‘ GPG key failed!"; exit 1; }
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get update -qq || { echo "ğŸ˜  Docker update failed!"; exit 1; }
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io || { echo "ğŸš¢ Docker install failed!"; exit 1; }
          echo "âœ… All core tools installed. Spartans ready!"

      - name: 'ğŸ› ï¸ Configure Rclone ğŸ”'
        run: |
          set -euo pipefail
          echo "ğŸ” Setting up rclone configuration... Securing the phalanx!"
          if [[ -z "${{ secrets.RCLONE_CONFIG || '' }}" ]]; then
            echo "âŒ ERROR: RCLONE_CONFIG secret is missing! Traitor in the ranks!" >&2
            exit 1
          fi
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf
          chmod 600 ~/.config/rclone/rclone.conf
          echo "âœ… Rclone configured successfully. Shields up!"

      - name: 'ğŸ” Check for Data Backup ğŸ•µï¸'
        id: check_backup
        run: |
          set -euo pipefail
          echo "ğŸ” Checking for existing data backup... Scouts ahead!"
          if rclone ls "${{ env.MEGA_REMOTE }}/${{ env.BACKUP_NAME }}" >/dev/null 2>&1; then
              echo "âœ… Data backup found in MEGA! Victory from the clouds!"
              echo "has_backup=true" >> $GITHUB_OUTPUT
              echo "backup_source=mega" >> $GITHUB_OUTPUT
          else
              echo "ğŸ” No MEGA backup found. Searching recent artifacts... Oracle consult!"
              RECENT_RUN=$(curl -s -H "Authorization: token ${{ github.token }}" \
                "https://api.github.com/repos/${{ github.repository }}/actions/workflows" \
                | jq -r '.workflows[] | select(.name == "Persistent VPS (Sparta Edition)") | .id' | head -1)
              if [[ -n "$RECENT_RUN" && "$RECENT_RUN" != "null" ]]; then
                LATEST_RUN=$(curl -s -H "Authorization: token ${{ github.token }}" \
                  "https://api.github.com/repos/${{ github.repository }}/actions/workflows/${RECENT_RUN}/runs?status=success&per_page=3" \
                  | jq -r '.workflow_runs[] | select(.id != ${{ github.run_id }}) | .id' | head -1)
                if [[ -n "$LATEST_RUN" && "$LATEST_RUN" != "null" ]]; then
                  ARTIFACT_ID=$(curl -s -H "Authorization: token ${{ github.token }}" \
                    "https://api.github.com/repos/${{ github.repository }}/actions/runs/${LATEST_RUN}/artifacts" \
                    | jq -r '.artifacts[] | select(.name == "${{ env.BACKUP_NAME }}") | .id')
                  if [[ -n "$ARTIFACT_ID" && "$ARTIFACT_ID" != "null" ]]; then
                    ARTIFACT_URL="https://api.github.com/repos/${{ github.repository }}/actions/artifacts/${ARTIFACT_ID}/zip"
                    echo "âœ… Found data backup in recent run! Artifact retrieved!"
                    echo "has_backup=true" >> $GITHUB_OUTPUT
                    echo "backup_source=artifact" >> $GITHUB_OUTPUT
                    echo "artifact_url=${ARTIFACT_URL}" >> $GITHUB_OUTPUT
                  else
                    echo "â„¹ï¸ No backup found. Starting fresh. New battle begins!"
                    echo "has_backup=false" >> $GITHUB_OUTPUT
                  fi
                else
                  echo "â„¹ï¸ No recent runs found. Starting fresh."
                  echo "has_backup=false" >> $GITHUB_OUTPUT
                fi
              else
                echo "â„¹ï¸ Workflow not found. Starting fresh."
                echo "has_backup=false" >> $GITHUB_OUTPUT
              fi
          fi

      - name: 'ğŸ“¥ Download & Restore Data Backup ğŸ”„'
        if: steps.check_backup.outputs.has_backup == 'true'
        run: |
          set -euo pipefail
          echo "ğŸ“¥ Downloading and restoring full system backup... Reassembling the legion!"
          
          # Use /mnt for temporary storage to save root disk space
          mkdir -p /mnt/restore
          cd /mnt/restore
          
          if [[ "${{ steps.check_backup.outputs.backup_source }}" == "mega" ]]; then
            echo "â˜ï¸ Downloading from MEGA... Cloud warriors descend!"
            rclone copy "${{ env.MEGA_REMOTE }}/${{ env.BACKUP_NAME }}" . || { echo "ğŸš¨ Rclone download failed!"; exit 1; }
            mv "${{ env.BACKUP_NAME }}" backup.tar.gz
          else
            echo "ğŸ“¦ Downloading from GitHub artifact... Fetching the scroll!"
            curl -L -H "Authorization: token ${{ github.token }}" \
              "${{ steps.check_backup.outputs.artifact_url }}" \
              -o "backup.zip" || { echo "ğŸŒ Curl failed!"; exit 1; }
          
            # Extract the GitHub artifact (always a zip)
            unzip -q backup.zip || { echo "ğŸ¤ Unzip failed!"; exit 1; }
            
            # Move the tar.gz
            mv *.tar.gz backup.tar.gz || { echo "ğŸšš Move failed!"; exit 1; }
          fi
          
          echo "ğŸ“‹ Backup file details:"
          ls -lh backup.tar.gz
          
          # Test backup integrity
          echo "ğŸ§ª Testing backup integrity... Inspect the weapons!"
          if ! tar -tzf backup.tar.gz >/dev/null 2>&1; then
            echo "âŒ Backup is corrupted! Dishonor!"
            exit 1
          fi
          
          echo "ğŸ“‚ Restoring data... This is Sparta's rebirth!"
          # Restore the entire filesystem from the backup
          sudo tar -xzpf backup.tar.gz -C / --warning=no-timestamp || { echo "ğŸ’¥ Restore failed!"; exit 1; }
          
          echo "âœ… Full system restoration complete. Spartans rise!"

      # ------------------------------------------------------------------
      # Part 2: System Configuration & Services Setup
      # ------------------------------------------------------------------

      - name: 'ğŸ‘¤ Setup User Account ğŸ¹'
        run: |
          set -euo pipefail
          echo "ğŸ‘¤ Configuring user account... Recruiting the hoplite!"
          if [[ -z "${{ secrets.USER_PASSWORD || '' }}" ]]; then
            echo "âŒ ERROR: USER_PASSWORD secret missing!" >&2
            exit 1
          fi
          sudo useradd -m -s /bin/bash jacky 2>/dev/null || echo "User exists - Veteran returns!"
          echo "jacky:${{ secrets.USER_PASSWORD }}" | sudo chpasswd || { echo "ğŸ”‘ Password set failed!"; exit 1; }
          sudo usermod -aG sudo,docker jacky || { echo "ğŸ‘¥ Group add failed!"; exit 1; }
          echo "jacky ALL=(ALL:ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/jacky > /dev/null
          sudo hostnamectl set-hostname github-vps || { echo "ğŸ·ï¸ Hostname failed!"; exit 1; }
          echo "127.0.1.1 github-vps" | sudo tee -a /etc/hosts > /dev/null
          echo "âœ… User account configured. Ready for battle!"

      - name: 'ğŸ“¦ Install/Configure Aapanel ğŸ›ï¸'
        run: |
          set -euo pipefail
          if command -v bt >/dev/null 2>&1; then
            echo "âœ… Aapanel already installed (from backup). Old guard stands!"
          else
            echo "ğŸ“¥ Installing Aapanel (fresh install)... New shields forged!"
            URL="https://www.aapanel.com/script/install_7.0_en.sh"
            if [ -f /usr/bin/curl ]; then curl -ksSO "$URL" ; else wget --no-check-certificate -O install_7.0_en.sh "$URL"; fi
            timeout 900 bash -c "printf 'y\nyes\n' | sudo bash install_7.0_en.sh" || {
              echo "âš ï¸ Aapanel installation timed out, continuing... Warriors endure!"
            }
          fi
          if command -v bt >/dev/null 2>&1; then
            echo "ğŸ›ï¸ Setting Aapanel credentials... Commanding the panel!"
            sleep 5
            echo "Jacky" | sudo bt 6 || true
            echo "spidey" | sudo bt 5 || true
          fi
          echo "âœ… Aapanel ready! This is Panel!"

      

      - name: 'ğŸš€ Start All Services ğŸ”„'
        run: |
          set -euo pipefail
          echo "ğŸ”„ Configuring and starting all system services... Rally the troops!"
          sudo systemctl daemon-reload
          sudo systemctl enable --now ssh docker mariadb || true
          if command -v bt >/dev/null 2>&1; then
            echo "ğŸ›ï¸ Starting Aapanel..."
            sudo bt start || true
          fi
          sleep 3
          echo "ğŸ“Š Final Service Status Check:"
          for service in ssh docker mariadb; do
            if systemctl is-active --quiet $service; then
              echo "  âœ… $service is active. Warrior stands!"
            else
              echo "  âŒ $service is INACTIVE. Fallen soldier!"
            fi
          done

      - name: 'ğŸ”— Configure Remote Access (Tailscale & tmate) ğŸ•¸ï¸'
        run: |
          set -euo pipefail
          echo "ğŸ•¸ï¸ Setting up Tailscale VPN for secure access... Connecting the empire!"
          if [[ -z "${{ secrets.TAILSCALE_AUTHKEY || '' }}" ]]; then
            echo "âŒ ERROR: TAILSCALE_AUTHKEY secret is missing!" >&2
            exit 1
          fi
          curl -fsSL https://tailscale.com/install.sh | sh || { echo "ğŸ˜¤ Tailscale install failed!"; exit 1; }
          sudo systemctl enable --now tailscaled || { echo "ğŸš¨ Tailscaled enable failed!"; exit 1; }
          if [ -f /var/lib/tailscale/tailscaled.state ]; then
            echo "ğŸ”„ Restored Tailscale state - Reconnecting old identity!"
            sudo tailscale up --accept-routes || true
          else
            echo "ğŸ†• New Tailscale setup - Registering warrior!"
            sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTHKEY }}" --hostname=github-vps --reset --accept-routes || { echo "ğŸ”— Up failed!"; exit 1; }
            # Immediate backup of new state to MEGA
            sudo tar czf /tmp/tailscale-state.tar.gz /var/lib/tailscale || { echo "ğŸ“¦ State tar failed!"; exit 1; }
            rclone copy /tmp/tailscale-state.tar.gz "${{ env.MEGA_REMOTE }}/" || { echo "â˜ï¸ State upload failed!"; exit 1; }
            rm /tmp/tailscale-state.tar.gz
          fi
          echo "ğŸ’¬ Starting tmate for emergency SSH access... Scout's link!"
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          echo "================================================"
          echo "ğŸ‰          VPS IS READY FOR CONNECTION         ğŸ‰"
          echo "================================================"
          TAILSCALE_IP=$(sudo tailscale ip -4)
          echo "ğŸŒ Tailscale IP: $TAILSCALE_IP"
          echo "ğŸ”‘ tmate SSH:    $(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')"
          if command -v bt >/dev/null 2>&1; then
            echo ""
            echo "ğŸ›ï¸ Aapanel Panel Details:"
            sudo bt default || true
          fi
          echo "================================================"

      - name: 'â³ Maintain Session ğŸ–¥ï¸'
        run: |
          echo "ğŸ–¥ï¸ VPS session active. Will run for ~5.5 hours. Hold the line!"
          echo "ğŸ’¡ To stop early: touch /tmp/stop"
          echo "ğŸ• Started: $(date)"
          end_time=$((SECONDS + 19800))
          while [ $SECONDS -lt $end_time ]; do
            if [ -f "/tmp/stop" ]; then
              echo "âœ… Graceful shutdown requested. Honorable retreat!"
              rm -f "/tmp/stop"
              break
            fi
            if [ $((SECONDS % 600)) -eq 0 ]; then
              remaining=$(((end_time - SECONDS) / 60))
              echo "ğŸ”„ Session active - $remaining minutes remaining - $(date) Spartans endure!"
            fi
            sleep 60
          done
          echo "â° Session ending, preparing backup... Fall back!"

      - name: 'ğŸ’¾ Create Full System Backup ğŸ“¦'
        if: always()
        run: |
          set -euo pipefail
          echo "ğŸ’¾ Creating full system backup... Archiving the battlefield!"
          # Use /mnt for backup storage to save root disk space
          sudo mkdir -p "${{ env.BACKUP_STORE }}"
          echo "ğŸ›‘ Stopping services cleanly for consistent backup... Cease fire!"
          if command -v bt >/dev/null 2>&1; then sudo bt stop || true; fi
          sudo systemctl stop mariadb || true
          sudo systemctl stop docker || true
          sleep 5
          echo "ğŸ“¦ Backing up entire root filesystem... This is Archive!"
          sudo tar -czpf "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" \
            --absolute-names \
            --exclude=/dev \
            --exclude=/proc \
            --exclude=/sys \
            --exclude=/tmp \
            --exclude=/run \
            --exclude=/mnt \
            --exclude=/media \
            --exclude=/var/backups \
            --exclude=/lost+found \
            / || {
            echo "âš ï¸ Tar encountered some missing files, continuing... Minor casualties!"
          }
          if [[ -f "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" ]]; then
            BACKUP_SIZE=$(du -h "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" | cut -f1)
            echo "âœ… Full system backup created. Size: $BACKUP_SIZE Glory!"
            echo "ğŸ“‹ Backup contents (sample):"
            sudo tar -tzf "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" | head -10
          else
            echo "âŒ Backup creation failed! Defeat!"
            exit 1
          fi

      - name: 'â¬†ï¸ Upload Data Backup as Artifact ğŸ“¤'
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BACKUP_NAME }}
          path: ${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}
          retention-days: 7
          if-no-files-found: warn

      - name: 'â˜ï¸ Upload Backup to MEGA & Generate Link ğŸ”—'
        if: always()
        run: |
          set -euo pipefail
          echo "â˜ï¸ Uploading backup to MEGA... Sending to the heavens!"
          if [[ -f "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" ]]; then
            rclone copy "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" "${{ env.MEGA_REMOTE }}/" || { echo "ğŸš¨ Rclone upload failed!"; exit 1; }
            echo "ğŸ”— Generating public link... Oracle's vision!"
            LINK=$(rclone link "${{ env.MEGA_REMOTE }}/${{ env.BACKUP_NAME }}") || echo "âš ï¸ Link generation failed, but backup uploaded."
            echo "$LINK" > mega-backup-link.txt
            echo "âœ… MEGA upload complete. Link: $LINK"
          else
            echo "ğŸš« No backup file found. Skipping MEGA upload."
          fi
          # Clean up local backup file from /mnt to free up disk space
          sudo rm -f "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}"

      - name: 'ğŸ“ Upload MEGA Link as Artifact'
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: mega-backup-link
          path: mega-backup-link.txt
          retention-days: 7

      - name: 'ğŸ“‹ Session Summary ğŸ†'
        if: always()
        run: |
          echo "============================================="
          echo "    âœ… SPARTA VPS SESSION COMPLETE âœ…"
          echo "============================================="
          echo "Status: ${{ job.status }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "End Time: $(date)"
          echo "Had Previous Backup: ${{ steps.check_backup.outputs.has_backup }}"
          echo "Runtime: $((SECONDS / 60)) minutes"
          echo ""
          echo "ğŸ’¾ Full System Backup Used"
          echo "   âœ“ All installed software (Apache, PHP, etc.)"
          echo "   âœ“ All configuration files"
          echo "   âœ“ All user data, databases, and Docker volumes"
          echo "   âœ— Temporary and virtual filesystems (dev, proc, etc.)"
          echo "============================================="
