name: Persistent VPS with Backup & Restore

on:
  workflow_dispatch:
  workflow_call:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Create restricted user "jacky"
      - name: Create restricted user
        run: |
          if ! id -u jacky >/dev/null 2>&1; then
            sudo useradd -m -s /bin/bash jacky
            echo "jacky:root" | sudo chpasswd
          fi
          echo "âœ… User jacky created with password 'root'"

      # Configure rclone (MEGA)
      - name: Configure rclone (MEGA)
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<'EOF'
[mega]
type = mega
user = rajeeshsksbx7@gmail.com
pass = EfABK_S7bUsZtacq8JlaxYackzNv7KmZAQ1mpA
EOF
          echo "âœ… rclone configured with MEGA"

      # Restore VPS data (before Tailscale up)
      - name: Restore VPS data
        run: |
          mkdir -p restore
          echo "ðŸ“¥ Downloading latest backup set from MEGA..."
          rclone copy mega:/vps-backup restore --progress || echo "âš ï¸ No backup found in MEGA"

          if [ -f restore/jacky-home.tar.gz ]; then
            echo "ðŸ“‚ Restoring jacky home directory..."
            sudo tar -xzf restore/jacky-home.tar.gz -C /
          fi

          if [ -f restore/aapanel.tar.gz ]; then
            echo "ðŸ“‚ Restoring aaPanel data..."
            sudo mkdir -p /www/server
            sudo tar -xzf restore/aapanel.tar.gz -C /
          fi

          echo "âœ… Restore process finished"

      # Setup Tailscale (after restore)
      - name: Setup Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --ssh --hostname github-vps
          echo "ðŸŽ‰ Connected to Tailscale!"
          echo "ðŸŒ Tailscale IP:"
          tailscale ip -4
          echo "ðŸ‘¤ Username: jacky"
          echo "ðŸ”‘ Password: root"

      # Backup VPS data (only jacky + optional aaPanel)
      - name: Backup VPS data
        run: |
          mkdir -p backup
          echo "ðŸ“¦ Backing up user jacky home directory..."
          sudo tar -czf backup/jacky-home.tar.gz /home/jacky

          if [ -d "/www/server" ]; then
            echo "ðŸ“¦ Backing up aaPanel data..."
            sudo tar -czf backup/aapanel.tar.gz /www/server
          else
            echo "â„¹ï¸ aaPanel not installed, skipping..."
          fi

          echo "âœ… Backup complete:"
          ls -lh backup

      # Upload backup to MEGA
      - name: Upload backup to MEGA
        run: |
          rclone mkdir mega:/vps-backup || true
          rclone copy backup mega:/vps-backup --progress
          echo "âœ… Backup uploaded to MEGA"

      # Final backup if the workflow is cancelled
      - name: Final backup on cancel
        if: ${{ cancelled() }}
        run: |
          echo "âš ï¸ Workflow cancelled â€” performing final backup"
          mkdir -p backup
          sudo tar -czf backup/jacky-home-final.tar.gz /home/jacky
          rclone copy backup mega:/vps-backup --progress
          echo "âœ… Final backup uploaded to MEGA"
