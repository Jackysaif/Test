name: Continuous Persistent VPS

on:
  schedule:
    - cron: '0 */6 * * *'   # Every 6h
  workflow_dispatch:

jobs:
  vps-session:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: "üöÄ Installing Dependencies"
        run: |
          set -e
          sudo apt update
          sudo apt install -y sudo curl unzip zip tmate net-tools neofetch rclone

      - name: "‚öôÔ∏è Setup rclone"
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
[gdrivveed]
type = drive
client_id = 534417340383-f4b86oa9dffhjuhdh4ekd38b0l9llnum.apps.googleusercontent.com
client_secret = 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
scope = drive
root_folder_id = appDataFolder
token = {"access_token":"ya29.A0AS3H6Ny6o1OvniaMus3wYXmmqBbanb_MNJmGTEfrQoBCbR_qTGcDCyGrObAOymSrxJ1Nq3g9Rd7JYyvPyD6L4vmgOwuJxEuePxz7--w3-Rl18LBNve5-1s8UVy0T_0VZOnn8TNqVdvScS9atFE8lUu4uPZxwb1ditSB3f9mqzZZOJAiKIXG31PHH9wu8XVdaLSq40pcaCgYKAbcSARQSFQHGX2MizZMgdAx4L1I4h9UJZKs6AQ0206","token_type":"Bearer","refresh_token":"1//0g1VFlKVUuwKlCgYIARAAGBASNwF-L9IrGhVBSYCiWVLzMiBL5VSP4_neIDcsmPELBjeHMIYSmA057I-AxPy2SAXr0nm-6vRRhUQ","expiry":"2025-08-31T15:42:32.953801261Z","expires_in":3599}
team_drive =
EOF

      - name: "üë§ Create user jacky"
        run: |
          if ! id "jacky" &>/dev/null; then
            sudo useradd -m -s /bin/bash jacky
            echo "jacky:root" | sudo chpasswd
            sudo usermod -aG sudo jacky
          fi

      - name: "üìÇ Restore Tailscale state"
        run: |
          sudo mkdir -p /var/lib/tailscale
          if rclone ls gdrivveed:vps-backup/system/tailscaled.state >/dev/null 2>&1; then
            sudo rclone copy gdrivveed:vps-backup/system/tailscaled.state /var/lib/tailscale/ --progress || true
            sudo chown root:root /var/lib/tailscale/tailscaled.state || true
            sudo chmod 600 /var/lib/tailscale/tailscaled.state || true
            echo "TS_STATE_RESTORED=true" >> $GITHUB_ENV
          else
            echo "TS_STATE_RESTORED=false" >> $GITHUB_ENV
          fi

      - name: "üåê Install & Start Tailscale"
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo systemctl stop tailscaled || true
          sudo systemctl start tailscaled
          sudo systemctl enable tailscaled
          
          if [ "$TS_STATE_RESTORED" = "false" ]; then
            sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --hostname github-vps || true
            sudo rclone copy /var/lib/tailscale/tailscaled.state gdrivveed:vps-backup/system/ --progress || true
          fi

      - name: "üíæ Restore VPS Data"
        run: |
          sudo rclone copy gdrivveed:vps-backup/home/ /home/jacky/ --progress || true
          sudo chown -R jacky:jacky /home/jacky || true
          sudo rclone copy gdrivveed:vps-backup/etc/ /etc/ --progress || true
          sudo rclone copy gdrivveed:vps-backup/www/ /var/www/ --progress || true

      - name: "üîë Show Tailscale IP"
        run: |
          sudo tailscale ip -4
          sudo tailscale ip -6

      - name: "‚è≥ Keep Session Alive"
        run: sleep 21600   # 6h

      - name: "üì¶ Backup VPS Data"
        if: always()
        run: |
          sudo rclone copy /home/jacky gdrivveed:vps-backup/home/ --progress || true
          sudo rclone copy /etc gdrivveed:vps-backup/etc/ --progress || true
          sudo rclone copy /var/www gdrivveed:vps-backup/www/ --progress || true

      - name: "üìÇ Backup Tailscale state"
        if: always()
        run: |
          sudo rclone copy /var/lib/tailscale/tailscaled.state gdrivveed:vps-backup/system/ --progress || true
