name: Persistent VPS with Backup & Restore

on:
  workflow_dispatch:
  workflow_call:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y curl unzip zip rclone tmate net-tools neofetch tailscale

      - name: Configure rclone MEGA
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [mega]
          type = mega
          user = rajeeshsksbx7@gmail.com
          pass = EfABK_S7bUsZtacq8JlaxYackzNv7KmZAQ1mpA
          EOF
          echo "âœ… rclone mega configured successfully"

      - name: Restore Tailscale state if available
        run: |
          mkdir -p backup
          if rclone ls mega:backup/tailscale-initial.tar.gz >/dev/null 2>&1; then
            echo "ğŸ“‚ Found previous Tailscale backup, restoring..."
            rclone copy mega:backup/tailscale-initial.tar.gz backup/
            sudo tar -xzf backup/tailscale-initial.tar.gz -C /
            echo "âœ… Tailscale state restored"
          else
            echo "ğŸ†• No previous Tailscale backup found, will setup fresh."
          fi

      - name: Setup Tailscale
        run: |
          sudo systemctl enable --now tailscaled
          sleep 5
          if [ -f /var/lib/tailscale/tailscaled.state ]; then
            echo "â™»ï¸ Restored Tailscale state detected."
            sudo tailscale up --ssh
          else
            echo "ğŸ†• Setting up fresh Tailscale..."
            sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --ssh --hostname github-vps
            echo "âœ… Fresh Tailscale setup complete"
            # Backup new state immediately
            sudo tar -czf backup/tailscale-initial.tar.gz -C / var/lib/tailscale/tailscaled.state
            rclone copy backup/tailscale-initial.tar.gz mega:backup/
            echo "ğŸ’¾ New Tailscale state backed up"
          fi
          echo "ğŸŒ Tailscale IP:"
          tailscale ip -4
          echo "ğŸ‘¤ User: jacky / Password: root"

      - name: Start Tmate session (keep VPS alive)
        run: |
          echo "ğŸ”— Starting tmate session (keep-alive for 21600s)..."
          tmate -F new-session -d
          sleep 21600

      - name: Backup VPS data (manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸ—„ï¸ Starting manual backup..."
          sudo tar -czf backup/vps-backup.tar.gz /home/jacky || true
          rclone copy backup/vps-backup.tar.gz mega:backup/
          echo "âœ… VPS data backup complete"

      - name: Final backup on cancel/failure
        if: cancelled() || failure()
        run: |
          echo "âš ï¸ Workflow cancelled/failure â€“ running final backup..."
          sudo tar -czf backup/vps-backup-final.tar.gz /home/jacky || true
          rclone copy backup/vps-backup-final.tar.gz mega:backup/
          echo "âœ… Final backup complete (on cancel/failure)"
