name: Persistent VPS with Backup & Restore (Lightweight)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *" # Run every 6 hours

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # === Restore Section ===
      - name: Download latest backup
        uses: actions/download-artifact@v4
        with:
          name: vps-backup
          path: backup
        continue-on-error: true

      - name: Restore VPS data & Tailscale state
        run: |
          if ls backup/vps-backup-*.tar.gz 1>/dev/null 2>&1; then
            echo "📦 Restoring VPS data..."
            sudo tar -xzf backup/vps-backup-*.tar.gz -C / || true
            
            if [ -d /home/jacky ]; then
              sudo chown -R jacky:jacky /home/jacky
            fi
            
            if [ -f /var/lib/tailscale/tailscaled.state ]; then
              echo "🔄 Restoring Tailscale state..."
              sudo systemctl restart tailscaled || true
            fi
          else
            echo "ℹ️ No previous backup found, starting fresh."
          fi

      # === Setup User & Tailscale ===
      - name: Create restricted user
        run: |
          if ! id -u jacky >/dev/null 2>&1; then
            sudo useradd -m -s /bin/bash jacky
            echo "jacky:root" | sudo chpasswd
            echo "jacky ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/jacky
            echo "✅ User 'jacky' created with password 'root'"
          else
            echo "jacky:root" | sudo chpasswd
            echo "✅ Password updated for existing user 'jacky'"
          fi

      - name: Install & Start Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo systemctl enable tailscaled
          sudo systemctl start tailscaled
          sleep 5
          sudo tailscale up \
            --authkey ${{ secrets.TAILSCALE_AUTHKEY }} \
            --hostname github-vps \
            --ssh

      - name: System Info
        run: |
          echo "=== System Information ==="
          uname -a
          echo "User: $(whoami)"
          id
          df -h
          free -m

      # === Interactive Access ===
      - name: Keep VPS alive
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 300

      # === Backup Section ===
      - name: Backup VPS data and Tailscale state
        if: always()
        run: |
          mkdir -p backup
          TEMP_BACKUP=$(mktemp -d)

          BACKUP_ITEMS=(
            "/etc"
            "/home"
            "/var/lib/tailscale/tailscaled.state"
            "/root/.ssh"
            "/opt"
          )

          for item in "${BACKUP_ITEMS[@]}"; do
            if [ -e "$item" ]; then
              sudo mkdir -p "$TEMP_BACKUP$(dirname "$item")"
              sudo cp -a "$item" "$TEMP_BACKUP$(dirname "$item")/"
            fi
          done

          BACKUP_FILE="backup/vps-backup-$(date +%Y%m%d-%H%M%S).tar.gz"
          sudo tar -czf "$BACKUP_FILE" -C "$TEMP_BACKUP" .
          sudo chown $USER:$USER "$BACKUP_FILE"
          sudo rm -rf "$TEMP_BACKUP"

          echo "✅ Backup created: $BACKUP_FILE"

      - name: Upload VPS backup artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vps-backup
          path: backup/*.tar.gz
          retention-days: 7
          compression-level: 0

      - name: Completion Summary
        if: always()
        run: |
          echo "🎉 VPS Backup & Restore Workflow Completed"
          if ls backup/*.tar.gz 1>/dev/null 2>&1; then
            du -h backup/*.tar.gz
          fi
