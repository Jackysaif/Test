
name: ğŸ•·ï¸ Spidey's VPS Adventure

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 400
    
    steps:
      - name: ğŸ•¸ï¸ Spidey's Web Setup
        run: |
          echo "ğŸ•·ï¸ Spidey is swinging into action!"
          echo "ğŸŒ Setting up the web of connections..."
          
      - name: ğŸ Python Power-Up
        run: |
          echo "ğŸ Giving Spidey some Python powers!"
          sudo apt-get update -qq
          sudo apt-get install -y python3-pip python3-psutil
          pip3 install psutil requests
          
      - name: ğŸ—ï¸ Installing Essential Tools
        run: |
          echo "ğŸ› ï¸ Spidey's tool belt is getting loaded!"
          sudo apt-get install -y curl wget unzip jq
          
      - name: ğŸ—„ï¸ MariaDB Setup (Spidey's Data Vault)
        run: |
          echo "ğŸ—„ï¸ Setting up Spidey's secret data vault..."
          sudo apt-get install -y mariadb-server mariadb-client
          sudo systemctl start mariadb
          sudo systemctl enable mariadb
          echo "ğŸ” Securing the vault with Spidey's password..."
          sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '${{ secrets.DB_ROOT_PASSWORD }}';"
          echo "âœ… Data vault is secure!"

      - name: ğŸ•¸ï¸ Tailscale Web Connection
        run: |
          echo "ğŸ•¸ï¸ Connecting to Spidey's web network..."
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --ssh
          echo "ğŸŒ Spidey is now connected to the web!"

      - name: â˜ï¸ RClone Setup (Spidey's Cloud Powers)
        run: |
          echo "â˜ï¸ Giving Spidey cloud-swinging abilities..."
          curl -O https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip rclone-current-linux-amd64.zip
          sudo cp rclone-*/rclone /usr/local/bin/
          sudo chmod +x /usr/local/bin/rclone
          
          echo "ğŸ“ Setting up Spidey's cloud config..."
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf
          echo "â˜ï¸ Cloud powers activated!"

      - name: ğŸ”„ Restore Spidey's Previous Work
        run: |
          echo "ğŸ”„ Checking if Spidey has previous work to restore..."
          if rclone lsf mega:spidey-backup/ | grep -q "spidey-web-backup.tar.gz"; then
            echo "ğŸ“¥ Found Spidey's previous work! Restoring..."
            rclone copy mega:spidey-backup/spidey-web-backup.tar.gz ./
            sudo tar -xzf spidey-web-backup.tar.gz -C /
            echo "âœ… Spidey's previous work restored!"
          else
            echo "ğŸ†• No previous work found. This must be Spidey's first mission!"
          fi

      - name: ğŸ›ï¸ Installing aaPanel (Spidey's Control Center)
        run: |
          echo "ğŸ›ï¸ Installing Spidey's web control center!"
          echo "ğŸ•·ï¸ Downloading the latest aaPanel installer..."
          
          # Use expect to handle prompts automatically
          sudo apt-get install -y expect
          
          # Create expect script for aaPanel installation
          cat > install_aapanel.exp << 'EOF'
          #!/usr/bin/expect
          set timeout 300
          spawn bash -c "wget -O install.sh http://www.aapanel.com/script/install_7.0_en.sh && bash install.sh aapanel"
          
          # Handle first prompt (usually asking to confirm installation)
          expect {
            "*y/n*" { send "y\r"; exp_continue }
            "*Y/N*" { send "Y\r"; exp_continue }
            "*yes/no*" { send "yes\r"; exp_continue }
            "*continue*" { send "y\r"; exp_continue }
            eof
          }
          EOF
          
          chmod +x install_aapanel.exp
          echo "ğŸš€ Starting automated aaPanel installation..."
          sudo ./install_aapanel.exp
          
          echo "âœ… aaPanel installed! Spidey's control center is ready!"

      - name: ğŸ Starting All Spidey Services
        run: |
          echo "ğŸ Starting all of Spidey's services..."
          sudo systemctl start mariadb
          sudo systemctl start bt-panel || echo "aaPanel will start automatically"
          echo "ğŸ•·ï¸ All services are web-slinging!"

      - name: ğŸ•·ï¸ Spidey's Patrol Loop (6 hours of web-slinging)
        run: |
          echo "ğŸ•·ï¸ Spidey is starting his 6-hour patrol!"
          echo "ğŸŒƒ Watching over the city..."
          
          patrol_start=$(date +%s)
          patrol_duration=$((6 * 3600 - 1800))  # 6 hours minus 30 min for backup
          
          while true; do
            current_time=$(date +%s)
            elapsed=$((current_time - patrol_start))
            
            if [ $elapsed -ge $patrol_duration ]; then
              echo "â° Patrol time is up! Time for backup..."
              break
            fi
            
            remaining=$((patrol_duration - elapsed))
            hours=$((remaining / 3600))
            minutes=$(((remaining % 3600) / 60))
            
            echo "ğŸ•¸ï¸ Spidey is on patrol... ${hours}h ${minutes}m remaining"
            sleep 300  # Check every 5 minutes
          done

      - name: ğŸ’ Creating Backup of Spidey's Web
        run: |
          echo "ğŸ’ Spidey is packing up his work for safekeeping..."
          
          # Create comprehensive backup
          sudo tar -czf spidey-web-backup.tar.gz \
            --exclude='/proc' \
            --exclude='/tmp' \
            --exclude='/sys' \
            --exclude='/dev' \
            --exclude='/run' \
            --exclude='/mnt' \
            --exclude='/media' \
            /var/lib/mysql \
            /www \
            /root \
            /home \
            /etc/systemd/system/multi-user.target.wants/mariadb.service \
            /usr/local/btpanel 2>/dev/null || true
            
          echo "ğŸ“¦ Backup created! Size: $(du -h spidey-web-backup.tar.gz | cut -f1)"

      - name: â¬†ï¸ Uploading to GitHub Artifacts (Primary backup)
        uses: actions/upload-artifact@v4
        with:
          name: spidey-backup-${{ github.run_number }}
          path: spidey-web-backup.tar.gz
          retention-days: 30

      - name: â˜ï¸ Uploading to MEGA (Secondary backup)
        run: |
          echo "â˜ï¸ Spidey is storing backup in the cloud..."
          rclone copy spidey-web-backup.tar.gz mega:spidey-backup/
          echo "âœ… Cloud backup complete!"

      - name: ğŸ¯ Spidey's Mission Complete!
        run: |
          echo "ğŸ¯ Another successful mission for Spidey!"
          echo "ğŸ•·ï¸ The web is safe for another day!"
          echo "ğŸ“Š Mission Stats:"
          echo "   ğŸ’¾ Backup created: âœ…"
          echo "   â˜ï¸ Cloud storage: âœ…"
          echo "   ğŸŒ Network secure: âœ…"
          echo "   ğŸ—„ï¸ Database running: âœ…"
          echo ""
          echo "ğŸ•¸ï¸ Until next time, true believers!"
