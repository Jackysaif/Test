name: Persistent VPS with Backup & Restore (MEGA)

on:
  workflow_dispatch:
  workflow_call:
  schedule:
    - cron: "0 */6 * * *"   # Every 6 hours

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      # =========================
      # Checkout
      # =========================
      - name: Checkout repo
        uses: actions/checkout@v4

      # =========================
      # Install dependencies + rclone
      # =========================
      - name: Install dependencies and rclone
        run: |
          sudo apt update
          sudo apt install -y unzip curl
          curl -Of https://downloads.rclone.org/rclone-current-linux-amd64.zip
          unzip -a rclone-current-linux-amd64.zip
          cd rclone-*-linux-amd64
          sudo cp rclone /usr/bin/
          sudo chown root:root /usr/bin/rclone
          sudo chmod 755 /usr/bin/rclone
          rclone version

      # =========================
      # Create restricted user
      # =========================
      - name: Create user jacky
        run: |
          if ! id -u jacky >/dev/null 2>&1; then
            sudo useradd -m -s /bin/bash jacky
            echo "jacky:root" | sudo chpasswd
            echo "âœ… User jacky created (password: root)"
          else
            echo "â„¹ï¸ User jacky already exists"
          fi

      # =========================
      # Setup rclone with MEGA (Secrets)
      # =========================
      - name: Setup rclone with MEGA
        env:
          MEGA_USER: ${{ secrets.MEGA_USER }}
          MEGA_PASS: ${{ secrets.MEGA_PASS }}
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [mega]
          type = mega
          user = $MEGA_USER
          pass = $MEGA_PASS
          EOF

          echo "ðŸ”‘ MEGA rclone configured successfully!"
          echo "ðŸ“‚ Testing MEGA access:"
          rclone lsd mega:/ || echo "âš ï¸ Could not list MEGA (maybe empty?)"

      # =========================
      # Restore Backup (if exists)
      # =========================
      - name: Restore VPS backup from MEGA
        run: |
          mkdir -p restore
          if rclone copy mega:/vps-backup/latest.tar.gz restore/ --progress; then
            echo "âœ… Backup found, restoring..."
            sudo tar -xzf restore/latest.tar.gz -C /
          else
            echo "â„¹ï¸ No previous backup found"
          fi

      # =========================
      # Install Tailscale
      # =========================
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale
        run: |
          sudo tailscaled &
          sleep 5
          sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --hostname github-vps --ssh
          echo "âœ… Tailscale started"
          tailscale ip -4
          echo "ðŸ‘¤ Username: jacky"
          echo "ðŸ”‘ Password: root"

      # =========================
      # Start tmate session
      # =========================
      - name: Start manual tmate session
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true

      # =========================
      # Keep VPS alive
      # =========================
      - name: Sleep to keep VPS alive
        run: sleep 3600

      # =========================
      # Backup VPS data to MEGA
      # =========================
      - name: Backup VPS data to MEGA (on completion)
        if: always()
        run: |
          mkdir -p backup
          echo "ðŸ“¦ Backing up /home/jacky directory..."
          sudo tar --exclude='*.tar.gz' -czf backup/latest.tar.gz /home/jacky
          echo "â˜ï¸ Uploading to MEGA..."
          rclone mkdir mega:/vps-backup || true
          rclone copy backup/latest.tar.gz mega:/vps-backup --progress
          echo "âœ… Backup completed to MEGA"

      # =========================
      # Final Backup on Cancel
      # =========================
      - name: Final Backup on Cancel
        if: cancelled()
        run: |
          echo "âš ï¸ Job cancelled, performing final backup..."
          rclone copy backup/latest.tar.gz mega:/vps-backup --progress || true
