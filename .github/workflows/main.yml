name: Persistent VPS with MEGA Backup

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # Every 6 hours

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y unzip zip curl tmate neofetch tar
          curl https://rclone.org/install.sh | sudo bash

      # === Restore Section ===
      - name: Restore backup from MEGA
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [mega]
          type = mega
          user = rajeeshsksbx7@gmail.com
          pass = Rajesh123580
          EOF

          mkdir -p backup
          rclone copy mega:vps-backups/latest-backup.tar.gz backup/ || true

          if [ -f backup/latest-backup.tar.gz ]; then
            echo "📦 Found backup on MEGA, restoring..."
            sudo tar -xzf backup/latest-backup.tar.gz -C /
          else
            echo "ℹ️ No backup found, starting fresh."
          fi

      # === VPS Setup ===
      - name: Setup user jacky
        run: |
          sudo useradd -m jacky || true
          echo "jacky:root" | sudo chpasswd
          echo "👤 User Info:"
          echo "Username: jacky"
          echo "Password: root"

      - name: Start Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey tskey-auth-kodgmRrzjh11CNTRL-JTL6FCKJPCC6gMwL6o7HCCJVk67E9VU7 --hostname gha-vps
          echo "🌐 Tailscale IP: $(tailscale ip -4)"

      - name: VPS Session (SSH over tmate)
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 240

      # === Backup Section (always runs, even on cancel/fail) ===
      - name: Create and upload backup
        if: always()
        run: |
          BACKUP_FILE="backup-$(date +%Y%m%d-%H%M%S).tar.gz"
          BACKUP_DIR="/opt/vps-backup"
          sudo mkdir -p "$BACKUP_DIR"

          echo "🗂 Collecting backup data..."

          # Backup jacky’s home
          sudo cp -r /home/jacky "$BACKUP_DIR/"

          # Backup Tailscale state
          if [ -f /var/lib/tailscale/tailscaled.state ]; then
            sudo mkdir -p "$BACKUP_DIR/tailscale"
            sudo cp /var/lib/tailscale/tailscaled.state "$BACKUP_DIR/tailscale/"
          fi

          # Optional: Backup aaPanel if installed
          if [ -d /www/server/panel ]; then
            echo "📦 aaPanel found, backing up..."
            sudo cp -r /www/server/panel "$BACKUP_DIR/aapanel"
          else
            echo "ℹ️ aaPanel not installed, skipping..."
          fi

          # Pack backup
          sudo tar -czf "$BACKUP_FILE" -C /opt vps-backup

          # Upload to MEGA
          echo "📤 Uploading backup to MEGA..."
          rclone copy "$BACKUP_FILE" mega:vps-backups/
          rclone copy "$BACKUP_FILE" mega:vps-backups/latest-backup.tar.gz --copy-links

          echo "✅ Backup completed: $BACKUP_FILE"
