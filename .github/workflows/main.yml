# üï∑Ô∏è Spidey Persistent VPS - Production Ready

name: Persistent VPS

on:
  schedule:
    - cron: '0 */6 * * *'   # Every 6 hours
  workflow_dispatch:        # Manual trigger

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

env:
  BACKUP_STORE: /var/backups/vps
  BACKUP_NAME: vps-backup-latest.tar.gz
  MEGA_REMOTE: mega:vps-backup

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 350   # 5 hours 50 minutes (GitHub max = 6 hours)

    steps:
    # ============================================================
    - name: 'üï∏Ô∏è Checkout Code'
      uses: actions/checkout@v4
    # ============================================================

    - name: 'üë§ Initial Setup: User, Hostname & Services'
      run: |
        set -euo pipefail
        echo "üöÄ Setting up fresh VPS environment..."
        
        # Create user jacky
        if ! id "jacky" &>/dev/null; then
          sudo useradd -m -s /bin/bash jacky
          echo "‚úÖ User 'jacky' created"
        fi
        
        # Set password and sudo privileges
        echo "jacky:root" | sudo chpasswd
        sudo usermod -aG sudo jacky
        echo "jacky ALL=(ALL:ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/jacky
        
        # Set hostname
        sudo hostnamectl set-hostname github-vps
        echo "127.0.1.1 github-vps" | sudo tee -a /etc/hosts
        
        echo "‚úÖ Basic system setup completed."
    # ============================================================

    - name: '‚ö° Install System Tools & MariaDB'
      run: |
        set -euo pipefail
        echo "üöÄ Installing system tools, MariaDB, rclone, and tmate..."
        
        sudo apt-get update -qq
        
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          psmisc screen openssh-server apache2 \
          php php-mysql php-cli php-curl php-zip php-gd php-mbstring php-xml \
          mariadb-server \
          curl wget unzip tar gzip htop nano vim git net-tools || {
            echo "‚ùå Package installation failed"
            exit 1
          }

        # Unmask MariaDB service
        echo "üîß Ensuring MariaDB service is unmasked..."
        sudo systemctl unmask mariadb.service || true
        sudo systemctl enable mariadb.service
        sudo systemctl start mariadb.service
        
        # Install tmate
        echo "üì• Installing tmate..."
        if ! command -v tmate &>/dev/null; then
          sudo apt-get install -y tmate || {
            wget -q -O /tmp/tmate.tar.xz https://github.com/tmate-io/tmate/releases/download/2.4.0/tmate-2.4.0-static-linux-amd64.tar.xz
            tar -xf /tmp/tmate.tar.xz -C /tmp/
            sudo cp /tmp/tmate-2.4.0-static-linux-amd64/tmate /usr/local/bin/
            sudo chmod +x /usr/local/bin/tmate
          }
        fi
        
        # Install rclone
        echo "üì• Installing rclone..."
        curl -fsSL https://rclone.org/install.sh | sudo bash || {
          echo "‚ùå Rclone installation failed"
          exit 1
        }
        
        echo "‚úÖ Tools installed successfully."
    # ============================================================

    - name: 'üõ†Ô∏è Configure MariaDB for Aapanel'
      run: |
        set -euo pipefail
        echo "üîß Configuring MariaDB service..."
        
        sudo systemctl restart mariadb.service || {
          echo "‚ùå Failed to start MariaDB service"
          exit 1
        }
        
        echo "‚úÖ MariaDB service is running."
        
        echo "üîß Creating Aapanel database user..."
        sudo mysql -u root -e "
          CREATE USER IF NOT EXISTS 'aapanel'@'localhost' IDENTIFIED BY 'aapanelpass';
          GRANT ALL PRIVILEGES ON *.* TO 'aapanel'@'localhost' WITH GRANT OPTION;
          FLUSH PRIVILEGES;
        "
        echo "‚úÖ MariaDB user 'aapanel' created."
    # ============================================================

    - name: 'üõ†Ô∏è Configure Rclone (MEGA)'
      run: |
        set -euo pipefail
        echo "üîê Setting up rclone configuration..."
        
        if [[ -z "${{ secrets.RCLONE_CONFIG || '' }}" ]]; then
          echo "‚ùå RCLONE_CONFIG secret is missing!"
          exit 1
        fi
        
        mkdir -p ~/.config/rclone
        cat > ~/.config/rclone/rclone.conf << 'EOF'
        ${{ secrets.RCLONE_CONFIG }}
        EOF
        chmod 600 ~/.config/rclone/rclone.conf
        
        if ! rclone config show >/dev/null 2>&1; then
          echo "‚ùå Invalid rclone configuration"
          exit 1
        fi
        
        echo "‚úÖ Rclone configured successfully."
    # ============================================================

    - name: '‚úÖ Test Rclone Configuration'
      run: |
        set -euo pipefail
        echo "üîç Testing MEGA remote..."
        
        if rclone listremotes | grep -q "mega:"; then
          echo "‚úÖ MEGA remote found"
          for i in {1..3}; do
            echo "üîÑ Test attempt $i/3..."
            if timeout 60 rclone about ${{ env.MEGA_REMOTE }} >/dev/null 2>&1; then
              echo "‚úÖ MEGA connection successful"
              break
            elif [[ $i -eq 3 ]]; then
              echo "‚ùå MEGA test failed"
              exit 1
            else
              sleep 10
            fi
          done
        else
          echo "‚ùå MEGA remote missing"
          exit 1
        fi
    # ============================================================

    - name: 'üì¶ Install Aapanel'
      run: |
        set -euo pipefail
        echo "üì• Installing Aapanel..."
        
        URL=https://www.aapanel.com/script/install_7.0_en.sh
        if [ -f /usr/bin/curl ]; then 
          curl -ksSO "$URL"
        else 
          wget --no-check-certificate -O install_7.0_en.sh "$URL"
        fi
        
        sudo bash install_7.0_en.sh aapanel || {
          echo "‚ùå Aapanel installation failed"
          exit 1
        }
        
        if command -v bt >/dev/null 2>&1; then
          echo "‚úÖ Aapanel installed"
          sudo bt --version || true
        else
          echo "‚ö†Ô∏è Aapanel command not found"
        fi
    # ============================================================

    - name: '‚ôªÔ∏è Restore MariaDB Data from Backup'
      run: |
        set -euo pipefail
        echo "üîÑ Checking for MariaDB backup..."
        
        if rclone ls "${MEGA_REMOTE}/${BACKUP_NAME}" >/dev/null 2>&1; then
          echo "‚úÖ Backup found, restoring..."
          mkdir -p /tmp/restore
          rclone copy "${MEGA_REMOTE}/${BACKUP_NAME}" /tmp/restore/ --progress --retries 3
          
          sudo systemctl stop mariadb apache2 || true
          sudo tar -xzf "/tmp/restore/${BACKUP_NAME}" --absolute-names -C / || true
          sudo chown -R mysql:mysql /www/server/data
          sudo chmod -R 700 /www/server/data
          
          rm -f "/tmp/restore/${BACKUP_NAME}"
          rclone delete "${MEGA_REMOTE}/${BACKUP_NAME}" || true
        else
          echo "‚ÑπÔ∏è No backup found. Skipping restore."
        fi
    # ============================================================

    - name: 'üöÄ Finalize & Configure Services'
      run: |
        set -euo pipefail
        sudo systemctl restart mariadb apache2
        
        echo "üîê Configuring Aapanel..."
        sleep 5
        echo "Jacky" | sudo bt 6 2>/dev/null || true
        echo "spidey" | sudo bt 5 2>/dev/null || true
        
        echo "üìã Aapanel Info:"
        sudo bt default 2>/dev/null || true
    # ============================================================

    - name: 'üîó Configure Remote Access'
      run: |
        set -euo pipefail
        echo "üï∏Ô∏è Configuring Tailscale..."
        
        if [[ -z "${{ secrets.TAILSCALE_AUTHKEY || '' }}" ]]; then
          echo "‚ùå Missing TAILSCALE_AUTHKEY"
          exit 1
        fi
        
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo systemctl enable tailscaled
        sudo systemctl start tailscaled
        
        for i in {1..3}; do
          if sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTHKEY }}" --hostname=github-vps --reset --accept-routes; then
            echo "‚úÖ Tailscale connected"
            break
          elif [[ $i -eq 3 ]]; then
            echo "‚ùå Tailscale failed"
            exit 1
          fi
          sleep 15
        done
        
        TAILSCALE_IP=$(sudo tailscale ip -4)
        echo "üåê Granting MariaDB access to subnet..."
        SUBNET=$(echo $TAILSCALE_IP | cut -d. -f1-3).%
        sudo mysql -e "GRANT ALL PRIVILEGES ON *.* TO 'root'@'${SUBNET}' IDENTIFIED BY '' WITH GRANT OPTION; FLUSH PRIVILEGES;"
        
        echo "‚úÖ MariaDB remote access granted for subnet ${SUBNET}"
        
        echo "üí¨ Starting tmate..."
        tmate -S /tmp/tmate.sock new-session -d 'echo "Welcome to GitHub VPS!"; bash'
        timeout 60 tmate -S /tmp/tmate.sock wait tmate-ready || true
        
        TMATE_SSH=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}' || echo "N/A")
        TMATE_WEB=$(tmate -S /tmp/tmate.sock display -p '#{tmate_web}' || echo "N/A")
        
        echo "================================================"
        echo "üéâ VPS IS READY üéâ"
        echo "üåê Tailscale IP: $TAILSCALE_IP"
        echo "üîë SSH: $TMATE_SSH"
        echo "üåç Web Terminal: $TMATE_WEB"
        echo "üéõÔ∏è Aapanel: http://$TAILSCALE_IP:7800 (Jacky/spidey)"
        echo "================================================"
    # ============================================================

    - name: '‚è≥ Maintain VPS Session'
      run: |
        set -euo pipefail
        echo "üñ•Ô∏è VPS running..."
        
        for minute in {1..330}; do
          if [[ -f /tmp/stop_session ]]; then
            echo "üõë Stop signal detected"
            break
          fi
          
          if (( minute % 30 == 0 )); then
            echo "‚è∞ Runtime: $minute minutes"
            echo "Services: $(systemctl is-active mariadb apache2 ssh tailscaled | tr '\n' ' ')"
          fi
          sleep 60
        done
    # ============================================================

    - name: 'üì¶ Create System Backup'
      if: always()
      run: |
        set -euo pipefail
        echo "üì¶ Creating backup..."
        
        sudo mkdir -p "${{ env.BACKUP_STORE }}"
        sudo systemctl stop apache2 mariadb || true
        sleep 5
        
        sudo tar -czf "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" \
          --absolute-names \
          --exclude='/proc/*' --exclude='/tmp/*' --exclude='/sys/*' \
          --exclude='/dev/*' --exclude='/run/*' --exclude='/mnt/*' \
          --exclude='/media/*' --exclude='/lost+found' \
          --exclude='*.log' --exclude='*.pid' \
          /etc/hostname /etc/hosts /etc/passwd /etc/group /etc/shadow \
          /etc/sudoers.d/ /etc/systemd/system/ /etc/ssh/ \
          /etc/apache2/ /etc/mysql/ /var/lib/tailscale/ \
          /www/server/data/ /www/server/panel/ \
          /var/www/ /opt/ /srv/ /root/ /home/jacky/ /usr/local/bin/
        
        echo "‚úÖ Backup created"
    # ============================================================

    - name: '‚òÅÔ∏è Upload Backup to MEGA'
      if: always()
      run: |
        set -euo pipefail
        echo "üöÄ Uploading backup..."
        
        for attempt in {1..5}; do
          if rclone copy "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}" "${{ env.MEGA_REMOTE }}" --progress; then
            echo "‚úÖ Upload success"
            break
          elif [[ $attempt -eq 5 ]]; then
            echo "‚ùå Upload failed"
            exit 1
          fi
          sleep 30
        done
        sudo rm -f "${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}"
    # ============================================================

    - name: 'üìã Final Status Report'
      if: always()
      run: |
        echo "============================================="
        echo "         üï∑Ô∏è VPS SESSION COMPLETE üï∑Ô∏è"
        echo "============================================="
        echo "üìÖ Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "üè∑Ô∏è Status: ${{ job.status }}"
        echo "============================================="
    # ============================================================

    - name: 'üõë Stop Runner on Cancel'
      if: cancelled()
      run: |
        echo "‚ö†Ô∏è Workflow cancelled, stopping runner..."
        sudo systemctl stop apache2 mariadb tailscaled || true
        sudo pkill -u jacky || true
        sudo shutdown -h now || true
    # ============================================================
