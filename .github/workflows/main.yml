# üï∑Ô∏èÔ∏è Spidey Persistent VPS - Optimized Workflow
# This version is the most reliable and efficient, incorporating all fixes
# to ensure a complete and functional persistent VPS.

name: üï∑Ô∏è Spidey Persistent VPS - Optimized (Fixed for Space)

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

env:
  BACKUP_STORE: /var/backups/vps
  BACKUP_NAME: vps-backup-latest.tar.gz
  MEGA_REMOTE: mega:vps-backup # Rclone remote path
  
jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      # 1. Universal User Setup (runs every time to ensure the user exists)
      - name: üë§ Create user 'jacky' & Set Hostname
        run: |
          echo "üöÄ Creating universal user and hostname setup..."
          sudo useradd -m -s /bin/bash jacky || true # Use || true to ignore if user exists
          echo "jacky:root" | sudo chpasswd
          sudo usermod -aG sudo jacky
          echo "jacky ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/jacky
          sudo hostnamectl set-hostname github-vps
          echo "‚úÖ User 'jacky' created and configured with password 'root'."
      
      # 2. Basic Setup & Tool Installation
      - name: üï∏Ô∏è Checkout Code
        uses: actions/checkout@v4

      - name: ‚ö° Install System Tools & Rclone
        run: |
          echo "Installing core system tools..."
          sudo apt-get update
          sudo apt-get install -y curl wget unzip tar psmisc screen openssh-server mariadb-server apache2 php php-mysql
          curl -fsSL https://rclone.org/install.sh | sudo bash
          sudo systemctl enable --now ssh

      - name: ‚òÅÔ∏è Configure Rclone (MEGA)
        run: |
          echo "Configuring Rclone for MEGA..."
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [mega]
          type = mega
          user = ${{ secrets.MEGA_USER }}
          pass = ${{ secrets.MEGA_PASS }}
          EOF

      # 3. Restore or Initialize System
      - name: ‚ôªÔ∏è Restore from Backup OR Initialize
        id: restore
        run: |
          echo "üîç Checking for existing backup on MEGA..."
          if rclone ls ${MEGA_REMOTE}/${BACKUP_NAME} >/dev/null 2>&1; then
            echo "‚úÖ Backup found. Restoring system state..."
            # Restore: download to /tmp and extract
            rclone copy ${MEGA_REMOTE}/${BACKUP_NAME} /tmp/
            sudo tar -xzf /tmp/${BACKUP_NAME} --absolute-names -C /
            echo "is_new_install=false" >> $GITHUB_OUTPUT
          else
            echo "‚ÑπÔ∏è No backup found. This will be a fresh installation."
            # Initialize: create directories that are backed up
            sudo mkdir -p /home/jacky /opt /srv /var/www /var/lib/mysql /www/server
            echo "is_new_install=true" >> $GITHUB_OUTPUT
          fi
          
      # 4. Delete Backup from MEGA (Clean slate for the new run)
      - name: üóëÔ∏è Delete Old Backup from MEGA
        if: steps.restore.outputs.is_new_install == 'false'
        run: |
          echo "Deleting old backup file from MEGA remote..."
          rclone delete ${{ env.MEGA_REMOTE }}/${{ env.BACKUP_NAME }}
          echo "‚úÖ Old backup deleted from MEGA."
      
      # 5. Aapanel Setup (install and overwrite using non-interactive flag)
      - name: üöÄ Aapanel Setup
        run: |
          echo "Running Aapanel installer to configure over restored files..."
          curl -sSLo /tmp/install.sh http://www.aapanel.com/script/install-ubuntu_6.0_en.sh
          # Pipe 'y' and 'yes' to the installer to handle both prompts
          (echo "y" && echo "yes") | sudo bash /tmp/install.sh

      # 6. Start System Services
      - name: üöÄ Start System Services
        run: |
          echo "üîÑ (Re)loading system services..."
          sudo systemctl daemon-reload
          
          echo "üï∏Ô∏è Installing and starting Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo systemctl enable --now tailscaled
          # Use --reset to handle potential runner hostname changes
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=github-vps --reset || true
          
          # Wait for Tailscale network to fully stabilize
          echo "Pausing for 10 seconds to allow Tailscale network to establish..."
          sleep 10
          
          # Start the services in a logical order
          echo "‚öôÔ∏è Starting database, Aapanel, and web services..."
          sudo systemctl start mariadb || true
          sudo bt restart || true
          sudo systemctl start apache2 || true

          echo "‚úÖ All services are running."
          echo "üåê Tailscale IP: $(sudo tailscale ip -4 || echo 'Not available')"
      
      # 7. Set Aapanel Credentials
      - name: üîê Set Aapanel Username & Password
        run: |
          echo "Setting Aapanel username and password..."
          echo "jacky" | sudo bt 6
          echo "spidey" | sudo bt 5
          echo "‚úÖ Aapanel username is 'jacky' and password has been set to 'spidey'."
      
      - name: üõ∞Ô∏è Start Tmate Session
        run: |
          sudo apt-get install -y tmate
          # Start tmate in a detached screen as the 'jacky' user
          sudo -u jacky screen -dmS tmate-session tmate
          sleep 3
          echo "‚úÖ Tmate session started in background. Use 'sudo -u jacky screen -r tmate-session' to attach."

      # 8. Maintain the Session (Graceful Shutdown Loop)
      - name: ‚è≥ Maintain VPS Session
        run: |
          echo "üñ•Ô∏è VPS is now running. To trigger a manual shutdown, create a file named '/tmp/stop_session' inside the VPS."
          
          # This loop keeps the job alive for up to 6 hours (timeout-minutes: 360)
          while [ ! -f /tmp/stop_session ]; do
            echo "Session is active. Sleeping for 60 seconds..."
            sleep 60
          done
          
          echo "Graceful shutdown initiated. Proceeding to final backup."

      # 9. Create and Stream Final Backup to MEGA (The FIX for disk space)
      # This combines the backup creation and upload into a single streaming process.
      - name: üíæ Create & Stream Final Backup
        if: always() # Ensure this runs even if the session was interrupted
        run: |
          echo "üõë Stopping services for a clean backup..."
          sudo systemctl stop tailscaled || true
          sudo systemctl stop btpanel.service || true
          sudo systemctl stop apache2 || true
          sudo systemctl stop mariadb || true
          sudo pkill -f "tmate" || true
          
          echo "üì¶ Streaming compressed backup archive directly to MEGA..."
          
          # Define the directories to be included in the backup
          BACKUP_DIRS="/etc/hostname /etc/hosts /etc/systemd/system /var/lib/tailscale /opt /srv /var/www /etc/ssh /etc/apache2 /www/server /root /home/jacky /usr/lib/systemd/system /var/lib/mysql /etc/sudoers.d/ /usr/bin/bt"
          
          # Use tar to create the compressed archive and pipe it directly to rclone rcat
          # rclone rcat streams the data to the remote, avoiding local disk space issues.
          sudo tar --ignore-failed-read -czf - $BACKUP_DIRS 2>/dev/null | \
          rclone rcat ${{ env.MEGA_REMOTE }}/${{ env.BACKUP_NAME }}
          
          echo "‚úÖ Final backup streamed successfully to ${{ env.MEGA_REMOTE }}/${{ env.BACKUP_NAME }}"
          
      # 10. Final Status Report
      - name: üìù Final Status Report
        if: always()
        run: |
          echo "=== VPS Session Ended ==="
          echo "Final job status: ${{ job.status }}"
          echo "Backup uploaded to: ${{ env.MEGA_REMOTE }}/${{ env.BACKUP_NAME }}"
          echo "========================="
