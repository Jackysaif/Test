name: Persistent VPS with Tailscale + MEGA Backup

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # Run every 6 hours

jobs:
  vps-session:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      # ============================================================
      # Prepare environment
      # ============================================================
      - name: Setup environment
        run: |
          set -e
          sudo apt update
          sudo apt install -y sudo curl unzip zip rclone tmate net-tools neofetch

      # ============================================================
      # Create user
      # ============================================================
      - name: Create user jacky
        run: |
          set -e
          sudo useradd -m -s /bin/bash jacky || true
          echo "jacky:root" | sudo chpasswd
          echo "‚úÖ User jacky created with password root"

      # ============================================================
      # Configure rclone with MEGA (hardcoded credentials)
      # ============================================================
      - name: Configure rclone (MEGA)
        run: |
          set -e
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
[mega]
type = mega
user = rajeeshsksbx7@gmail.com
pass = Rajesh123580
EOF
          echo "‚úÖ rclone configured with MEGA."
          rclone mkdir mega:vps-backup || true
          rclone lsd mega: || true

      # ============================================================
      # Restore VPS backup
      # ============================================================
      - name: Restore VPS backup
        run: |
          set -e
          echo "üìÇ Checking for VPS backup..."
          if rclone ls mega:vps-backup/vps-backup.tar.gz >/dev/null 2>&1; then
            echo "üî• Found VPS backup. Restoring..."
            rclone copy mega:vps-backup/vps-backup.tar.gz /tmp/ --progress
            sudo tar -xzf /tmp/vps-backup.tar.gz -C /
          else
            echo "‚ÑπÔ∏è No VPS backup found."
          fi

      # ============================================================
      # Restore Tailscale state if available
      # ============================================================
      - name: Restore Tailscale state
        run: |
          set -e
          echo "üìÇ Checking for Tailscale state backup..."
          if rclone ls mega:vps-backup/tailscale.state >/dev/null 2>&1; then
            echo "üî• Found Tailscale state. Restoring..."
            rclone copy mega:vps-backup/tailscale.state /tmp/ --progress
            sudo mkdir -p /var/lib/tailscale
            sudo cp /tmp/tailscale.state /var/lib/tailscale/tailscaled.state
          else
            echo "‚ÑπÔ∏è No Tailscale state found."
          fi

      # ============================================================
      # Install & start Tailscale
      # ============================================================
      - name: Install & connect Tailscale
        run: |
          set -e
          curl -fsSL https://tailscale.com/install.sh | sh
          if [ -f /var/lib/tailscale/tailscaled.state ]; then
            echo "üîó Restoring previous Tailscale state..."
            sudo systemctl restart tailscaled
            sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname github-vps --accept-routes --accept-dns --reset || true
          else
            echo "üîó No state found. Logging in with new key..."
            sudo systemctl start tailscaled
            sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname github-vps --accept-routes --accept-dns || true
          fi
          tailscale ip -4 || true
          tailscale ip -6 || true

      # ============================================================
      # Keep session alive for 6h
      # ============================================================
      - name: Keep alive
        run: |
          echo "üü¢ VPS session started. Keeping alive for 6h..."
          for i in $(seq 1 360); do
            echo "üí§ Minute $i/360 - VPS alive..."
            sleep 60
          done

      # ============================================================
      # Backup before exit (VPS + Tailscale state)
      # ============================================================
      - name: Backup VPS & Tailscale
        if: always()
        run: |
          set -e
          echo "üì¶ Backing up VPS system..."
          sudo tar -czf /tmp/vps-backup.tar.gz /home /etc || true
          rclone copy /tmp/vps-backup.tar.gz mega:vps-backup/ --progress
          echo "‚úÖ VPS backup uploaded."

          echo "üì¶ Backing up Tailscale state..."
          sudo cp /var/lib/tailscale/tailscaled.state /tmp/tailscale.state || true
          rclone copy /tmp/tailscale.state mega:vps-backup/ --progress
          echo "‚úÖ Tailscale state uploaded."
