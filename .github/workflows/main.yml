# ðŸ•·ï¸ Spidey Persistent VPS - Optimized Workflow
# This version improves logic by separating the initial setup from the restore process,
# eliminating redundant steps and ensuring a cleaner execution flow.

name: ðŸ•·ï¸ Spidey Persistent VPS - Optimized

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Daily backup at midnight

env:
  BACKUP_STORE: /var/backups/vps
  BACKUP_NAME: vps-backup-latest.tar.gz
  MEGA_REMOTE: mega:vps-backup # Rclone remote path

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      # 1. User Setup (runs at the very start of every session)
      - name: ðŸ‘¤ Create user 'not' & Set root password
        run: |
          echo "Setting root password..."
          echo "root:fleppy" | sudo chpasswd
          
          echo "Creating user 'not'..."
          sudo useradd -m -s /bin/bash not
          echo "not:fleppy" | sudo chpasswd
          sudo usermod -aG sudo not
          echo "not ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/not
          echo "âœ… User 'not' created and configured with password 'fleppy'."

      # 2. Universal User Setup (runs every time to ensure the user exists)
      - name: ðŸ‘¤ Create user 'jacky' & Set Hostname
        run: |
          echo "ðŸš€ Creating universal user and hostname setup..."
          sudo useradd -m -s /bin/bash jacky
          echo "jacky:root" | sudo chpasswd
          sudo usermod -aG sudo jacky
          sudo hostnamectl set-hostname github-vps
          echo "âœ… User 'jacky' created with password 'root'."
      
      # 3. Basic Setup & Tool Installation
      - name: ðŸ•¸ï¸ Checkout Code
        uses: actions/checkout@v4

      - name: âš¡ Install System Tools & Rclone
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget unzip tar psmisc screen
          curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: â˜ï¸ Configure Rclone (MEGA)
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [mega]
          type = mega
          user = ${{ secrets.MEGA_USER }}
          pass = ${{ secrets.MEGA_PASS }}
          EOF

      # 4. Restore or Initialize System
      - name: â™»ï¸ Restore from Backup OR Initialize
        id: restore
        run: |
          echo "ðŸ” Checking for existing backup on MEGA..."
          if rclone ls ${MEGA_REMOTE}/${BACKUP_NAME} >/dev/null 2>&1; then
            echo "âœ… Backup found. Restoring system state..."
            rclone copy ${MEGA_REMOTE}/${BACKUP_NAME} /tmp/
            # The tar command will restore the previous state on top of the newly created 'jacky' user home directory.
            sudo tar -xzf /tmp/${BACKUP_NAME} -C /
            echo "is_new_install=false" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No backup found. This will be a fresh installation."
            sudo mkdir -p /home/jacky /opt /srv /var/www
            echo "is_new_install=true" >> $GITHUB_OUTPUT
          fi

      # 5. Runtime Configuration (runs every time)
      - name: ðŸš€ Start System Services
        run: |
          echo "ðŸ”„ (Re)loading system services..."
          sudo systemctl daemon-reload
          # Enable any specific services you backed up, e.g.:
          # sudo systemctl enable --now my-persistent-app.service || true
          
          # This section now handles Tailscale setup for every run
          echo "ðŸ•¸ï¸ Installing and starting Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo systemctl enable --now tailscaled
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=github-vps --reset || true
          
          echo "âœ… Services are running."
          echo "ðŸŒ Tailscale IP: $(sudo tailscale ip -4 || echo 'Not available')"

      - name: ðŸ›°ï¸ Start Tmate Session
        run: |
          sudo apt-get install -y tmate
          # Start tmate in a detached screen as the 'jacky' user
          sudo -u jacky screen -dmS tmate-session tmate
          sleep 3
          echo "âœ… Tmate session started in background. Use 'sudo -u jacky screen -r tmate-session' to attach."

      # 6. Maintain the Session (New Graceful Shutdown)
      - name: â³ Maintain VPS Session
        run: |
          echo "ðŸ–¥ï¸ VPS is now running. To trigger a manual shutdown, create a file named '/tmp/stop_session' inside the VPS."
          
          # This loop will continue until the stop file is created
          while [ ! -f /tmp/stop_session ]; do
            echo "Session is active. Sleeping for 60 seconds..."
            sleep 60
          done
          
          echo "Graceful shutdown initiated. Proceeding to final backup."

            # 7. Final Backup (always runs)
      - name: ðŸ’¾ Create Final Backup
        if: always()
        run: |
          echo "ðŸ›‘ Stopping services for a clean backup..."
          sudo systemctl stop tailscaled || true
          sudo pkill -f "tmate" || true
          
          echo "ðŸ“¦ Creating final backup archive..."
          sudo mkdir -p ${{ env.BACKUP_STORE }}
          sudo tar --ignore-failed-read -czf ${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }} \
            /home/jacky \
            /etc/hostname \
            /etc/hosts \
            /etc/systemd/system \
            /var/lib/tailscale \
            /opt \
            /srv \
            /var/www \
            /etc/ssh \
            /home/jacky/.ssh 2>/dev/null || true
          
          echo "âœ… Final backup created at ${{ env.BACKUP_STORE }}/${{ env.BACKUP_NAME }}"
