# -----------------------------------------------------------------------------------
# Persistent VPS (Immortal Edition) - Comprehensive Backup
#
# v18.0 - A full-system backup that is fast, reliable, and does not time out.
# -----------------------------------------------------------------------------------

name: Persistent VPS (Immortal Edition)

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      force_fresh_install:
        description: 'Force fresh installation (ignore backups)'
        required: false
        default: 'false'
        type: boolean
      backup_retention_days:
        description: 'Backup retention days'
        required: false
        default: '7'
        type: string
      session_duration_minutes:
        description: 'Session duration in minutes'
        required: false
        default: '220'
        type: string

env:
  BACKUP_STORE: /tmp/vps-backups
  FINAL_BACKUP_NAME: full-system-backup.tar.zst
  MEGA_REMOTE: mega:vps-backup

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 235
    permissions:
      contents: write
      actions: write

    steps:
      - name: '🚀 Initialize Environment'
        uses: actions/checkout@v4

      - name: '🔧 Install Enhanced Toolchain'
        run: |
          set -euo pipefail
          echo "✨ Installing the ultimate toolchain... ⚙️"
          
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            zstd pv rsync jq curl wget psmisc screen tmate \
            htop fail2ban ufw python3-pip tree fuse \
            software-properties-common apt-transport-https ca-certificates \
            gnupg lsb-release
          
          curl -fsSL https://rclone.org/install.sh | sudo bash
          pip3 install --user psutil requests
          
          rclone version
          zstd --version
          echo "✅ Toolchain installed! Ready to roll. 🤘"

      - name: '🔐 Configure Rclone'
        run: |
          set -euo pipefail
          
          if [[ -z "${{ secrets.RCLONE_CONFIG || '' }}" ]]; then
            echo "❌ CRITICAL: RCLONE_CONFIG secret is missing! Aborting. 🚫" >&2
            exit 1
          fi
          
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf
          chmod 600 ~/.config/rclone/rclone.conf
          
          if ! rclone listremotes | grep -q "mega:"; then
            echo "❌ CRITICAL: Rclone MEGA remote not configured properly! Aborting. 💥" >&2
            exit 1
          fi
          
          echo "✅ Rclone configured and tested! Access granted. 🔑"

      - name: '🔍 Comprehensive Backup Discovery'
        id: discover_backup
        run: |
          set -euo pipefail
          echo "🔎 Searching for the most recent comprehensive backup..."
          
          BACKUP_FOUND=false
          BACKUP_SOURCE=""
          BACKUP_URL=""
          
          if [[ "${{ github.event.inputs.force_fresh_install || 'false' }}" == "true" ]]; then
            echo "🔄 Fresh installation requested by user. Skipping restore. 🍃"
            echo "backup_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Use the API to find the latest full-system backup artifact
          MAX_ATTEMPTS=5
          for attempt in $(seq 1 $MAX_ATTEMPTS); do
            echo "Attempt $attempt/$MAX_ATTEMPTS: Querying GitHub API for latest backup artifact..."
            
            ARTIFACTS_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/actions/artifacts?per_page=100")
            
            FULL_ARTIFACT_ID=$(echo "$ARTIFACTS_JSON" | jq -r ".artifacts[] | select(.name == \"${{ env.FINAL_BACKUP_NAME }}\") | .id" | head -1)

            if [[ -n "$FULL_ARTIFACT_ID" && "$FULL_ARTIFACT_ID" != "null" ]]; then
                BACKUP_URL="https://api.github.com/repos/${{ github.repository }}/actions/artifacts/${FULL_ARTIFACT_ID}/zip"
                BACKUP_SOURCE="github_artifact"
                BACKUP_FOUND=true
                break
            fi
            sleep 10
          done
          
          # If no artifact found, check Mega for a direct link
          if [[ "$BACKUP_FOUND" == "false" ]] && rclone ls "${MEGA_REMOTE}/full_backup_link.txt" >/dev/null 2>&1; then
            BACKUP_URL=$(rclone cat "${MEGA_REMOTE}/full_backup_link.txt" | head -1)
            BACKUP_SOURCE="mega_link"
            BACKUP_FOUND=true
          fi
          
          echo "backup_found=$BACKUP_FOUND" >> $GITHUB_OUTPUT
          echo "backup_source=$BACKUP_SOURCE" >> $GITHUB_OUTPUT
          echo "backup_url=$BACKUP_URL" >> $GITHUB_OUTPUT
          
          if [[ "$BACKUP_FOUND" == "true" ]]; then
            echo "✅ Comprehensive backup detected from $BACKUP_SOURCE! Preparing for restore. 🚀"
          else
            echo "ℹ️ No recent backup found. Starting with a fresh slate. ✨"
          fi

      - name: '🔄 Comprehensive System Restoration'
        if: steps.discover_backup.outputs.backup_found == 'true'
        run: |
          set -euo pipefail
          echo "⏳ Initiating comprehensive system restoration..."
          
          sudo mkdir -p /mnt/restore
          cd /mnt/restore
          
          max_attempts=3
          for attempt in $(seq 1 $max_attempts); do
            echo "Download attempt $attempt/$max_attempts..."
            if timeout 600 curl --retry 3 -L \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "${{ steps.discover_backup.outputs.backup_url }}" -o "backup.zip"; then
              break
            fi
            if [[ $attempt -eq $max_attempts ]]; then
              echo "❌ Download failed after $max_attempts attempts! Aborting. 💥" >&2
              exit 1
            fi
            sleep 30
          done
          
          sudo unzip -q backup.zip
          BACKUP_FILE=$(find . -name "*.tar.zst" -type f | head -1)
          
          if [[ ! -f "$BACKUP_FILE" ]] || ! zstd -t "$BACKUP_FILE"; then
            echo "❌ Backup file invalid or corrupted! Cannot proceed. 💔" >&2
            exit 1
          fi
          
          echo "✅ Backup verified! Size: $(du -h "$BACKUP_FILE" | cut -f1)"
          echo "🔄 Restoring files... This is going to be quick! ⚡"
          
          pv "$BACKUP_FILE" | sudo tar -I zstd -xpf - -C /
          
          sudo rm -rf /mnt/restore
          echo "✅ Restoration completed successfully. System is back online. 🎉"
          
      - name: '🛠️ Post-Restoration System Repair'
        if: steps.discover_backup.outputs.backup_found == 'true'
        run: |
          set -euo pipefail
          echo "🔧 Performing a quick system repair..."
          
          sudo apt-get update -qq || true
          
          if ! command -v docker >/dev/null 2>&1; then
            curl -fsSL https://get.docker.com | sudo sh
          fi
          
          for service in ssh docker mariadb fail2ban; do
            if systemctl list-unit-files --type=service | grep -q "^${service}\.service"; then
              sudo systemctl daemon-reload
              sudo systemctl enable "$service" 2>/dev/null || true
              sudo systemctl restart "$service" 2>/dev/null || true
            fi
          done
          
          if [[ -d "/var/lib/mysql" ]]; then
            sudo chown -R mysql:mysql /var/lib/mysql
            sudo systemctl restart mariadb 2>/dev/null || true
          fi
          
          if [[ -f "/www/server/panel/init.sh" ]]; then
            sudo /www/server/panel/init.sh restart || true
          fi
          
          echo "✅ Repair complete! Your VPS is optimized and ready. ✨"

      - name: '🆕 Enhanced Fresh Installation'
        if: steps.discover_backup.outputs.backup_found == 'false'
        run: |
          set -euo pipefail
          echo "🚀 Performing a fresh, clean installation..."
          
          if ! command -v docker >/dev/null 2>&1; then
            curl -fsSL https://get.docker.com | sudo sh
            sudo usermod -aG docker "$USER"
          fi
          
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            mariadb-server fail2ban ufw openssh-server nginx
          
          if curl -fsSL -o /tmp/install_aapanel.sh "http://www.aapanel.com/script/install-ubuntu_6.0_en.sh"; then
            chmod +x /tmp/install_aapanel.sh
            timeout 1200 bash -c "printf 'y\nyes\n' | sudo bash /tmp/install_aapanel.sh" || \
              echo "⚠️ aaPanel installation timed out"
          fi
          
          echo "✅ Fresh installation completed. Building from scratch. 🏗️"

      - name: '🔐 Security & User Setup'
        if: steps.discover_backup.outputs.backup_found == 'false'
        run: |
          set -euo pipefail
          echo "🔐 Setting up an impenetrable fortress of security..."
          
          if ! id "spidey" >/dev/null 2>&1; then
            sudo useradd -m -s /bin/bash -G sudo,docker spidey
            if [[ -n "${{ secrets.USER_PASSWORD || '' }}" ]]; then
              echo "spidey:${{ secrets.USER_PASSWORD }}" | sudo chpasswd
              echo "spidey ALL=(ALL:ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/spidey
            fi
          fi
          
          sudo hostnamectl set-hostname spidey
          
          if systemctl is-active --quiet mariadb && [[ -n "${{ secrets.DB_ROOT_PASSWORD || '' }}" ]]; then
            sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED VIA mysql_native_password USING PASSWORD('${{ secrets.DB_ROOT_PASSWORD }}'); FLUSH PRIVILEGES;" || true
          fi
          
          if [[ -f "/www/server/panel/init.sh" ]]; then
            timeout 30 bash -c 'echo "Jacky" | sudo bt 6' || true
            timeout 30 bash -c 'echo "spidey" | sudo bt 5' || true
          fi
          
          sudo ufw --force reset
          sudo ufw default deny incoming
          sudo ufw default allow outgoing
          sudo ufw allow ssh
          sudo ufw allow http
          sudo ufw allow https
          sudo ufw allow 8888/tcp
          sudo ufw --force enable
          
          for service in fail2ban ssh mariadb docker nginx; do
            if systemctl list-unit-files --type=service | grep -q "^${service}\.service"; then
              sudo systemctl enable --now "$service" 2>/dev/null || true
            fi
          done
          
          echo "✅ Security setup complete. Your VPS is hardened and ready. 🛡️"

      - name: '🌐 Configure Network Access'
        run: |
          set -euo pipefail
          echo "🌐 Configuring network access... Getting those IPs! 📶"
          
          if ! command -v tailscale >/dev/null 2>&1; then
            curl -fsSL https://tailscale.com/install.sh | sh
          fi
          
          if [[ -n "${{ secrets.TAILSCALE_AUTHKEY || '' }}" ]]; then
            sudo systemctl enable --now tailscaled
            if [[ -f "/var/lib/tailscale/tailscaled.state" ]]; then
              sudo tailscale up --accept-routes || true
            else
              sudo tailscale up \
                --authkey="${{ secrets.TAILSCALE_AUTHKEY }}" \
                --hostname="spidey-vps" \
                --reset --accept-routes || true
            fi
          fi
          
          tmate -S /tmp/tmate.sock new-session -d
          timeout 60 bash -c 'while ! tmate -S /tmp/tmate.sock wait tmate-ready; do sleep 1; done' || true
          
          echo ""
          echo "================================================="
          echo "🎉      YOUR SUPER VPS IS ONLINE!      🎉"
          echo "================================================="
          
          if command -v tailscale >/dev/null 2>&1; then
            TAILSCALE_IP=$(sudo tailscale ip -4 2>/dev/null || echo "Not available")
            echo "🌐 Tailscale IP: $TAILSCALE_IP"
          fi
          
          if tmate -S /tmp/tmate.sock list-sessions >/dev/null 2>&1; then
            TMATE_SSH=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}' 2>/dev/null || echo "Not available")
            echo "🔑 tmate SSH:    $TMATE_SSH"
          fi
          
          if [[ -f "/www/server/panel/init.sh" ]]; then
            echo ""
            echo "📊 aaPanel Information:"
            sudo bt default || true
          fi
          
          echo "================================================="

      - name: '⏳ Session Maintenance'
        run: |
          set -euo pipefail
          echo "⏳ Starting session maintenance... keeping the dream alive. 💖"
          
          SESSION_DURATION_MINUTES=${{ github.event.inputs.session_duration_minutes || '220' }}
          SESSION_DURATION_SECONDS=$((SESSION_DURATION_MINUTES * 60))
          
          log_message() { echo "$(date '+%Y-%m-%d %H:%M:%S') - $1"; }
          
          cat << 'EOF' > /tmp/session_keeper.sh
          #!/bin/bash
          log_message() { echo "$(date '+%Y-%m-%d %H:%M:%S') - $1"; }
          
          while true; do
              for service in ssh tailscaled docker mariadb; do
                  if systemctl list-unit-files --type=service | grep -q "^${service}\.service"; then
                      if systemctl is-enabled --quiet "$service" 2>/dev/null && ! systemctl is-active --quiet "$service"; then
                          log_message "⚠️ $service down, restarting..."
                          sudo systemctl restart "$service"
                      fi
                  fi
              done
              
              if ! tmate -S /tmp/tmate.sock list-sessions >/dev/null 2>&1; then
                  log_message "⚠️ tmate session lost, restarting..."
                  tmate -S /tmp/tmate.sock new-session -d
                  sleep 5
                  tmate -S /tmp/tmate.sock wait tmate-ready
                  log_message "✅ tmate restarted: $(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}' 2>/dev/null)"
              fi
              
              sleep 300
          done
          EOF
          
          chmod +x /tmp/session_keeper.sh
          nohup bash /tmp/session_keeper.sh > /tmp/session_keeper.log 2>&1 &
          KEEPER_PID=$!
          
          log_message "🖥️ Session started (PID: $KEEPER_PID, Duration: $SESSION_DURATION_MINUTES min)"
          log_message "🛑 To shutdown early: touch /tmp/stop"
          
          END_TIME=$((SECONDS + SESSION_DURATION_SECONDS))
          
          while [ $SECONDS -lt $END_TIME ]; do
            if [ -f "/tmp/stop" ]; then
              log_message "✅ Early shutdown requested"
              sudo rm -f "/tmp/stop"
              break
            fi
            
            REMAINING_MINUTES=$(( (END_TIME - SECONDS) / 60 ))
            if (( SECONDS % 1800 == 0 )); then
              log_message "📊 $REMAINING_MINUTES minutes remaining"
            fi
            
            sleep 60
          done
          
          if kill -0 $KEEPER_PID 2>/dev/null; then
            kill $KEEPER_PID
          fi
          
          log_message "⏰ Session concluded. Starting the final backup. 💾"

      - name: '📦 Create Comprehensive Backup'
        id: create_backup
        if: always()
        run: |
          set -euo pipefail
          echo "📦 Creating the comprehensive system backup..."
          
          mkdir -p "${{ env.BACKUP_STORE }}"
          
          BACKUP_EXCLUDES=(
            "/dev/*"
            "/proc/*"
            "/sys/*"
            "/tmp/*"
            "/run/*"
            "/mnt/*"
            "/media/*"
            "/lost+found"
            "/home/runner"
            "/var/lib/docker/overlay2"
            "/var/cache/*"
            "/var/tmp/*"
            "/var/log/*"
            "${{ env.BACKUP_STORE }}/*"
          )
          
          EXCLUDE_OPTIONS=$(printf -- "--exclude=%s " "${BACKUP_EXCLUDES[@]}")
          
          BACKUP_FILE="${{ env.BACKUP_STORE }}/${{ env.FINAL_BACKUP_NAME }}"
          echo "🚀 Creating the compressed archive... This will be quick. ⚡"
          START_TIME=$(date +%s)
          
          sudo tar -c --exclude-from=<(printf "%s\n" "${BACKUP_EXCLUDES[@]}") -f - / | zstd -T0 -19 -q > "$BACKUP_FILE"
          
          END_TIME=$(date +%s)
          BACKUP_TIME=$((END_TIME - START_TIME))
          
          if [[ ! -f "$BACKUP_FILE" ]] || [[ ! -s "$BACKUP_FILE" ]]; then
            echo "❌ Backup failed or is corrupted! This is a big problem. 😱" >&2
            exit 1
          fi
          
          BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
          
          echo "✅ FULL SYSTEM BACKUP COMPLETED! It's a wrap! 🎬"
          echo "📊 Size: $BACKUP_SIZE (Incredibly compact!)"
          echo "⚡ Time: ${BACKUP_TIME} seconds (Lightning fast!)"
          echo "🎯 Contains: The ENTIRE system, minus junk. Everything you need. 👍"
          
          echo "backup_file=$BACKUP_FILE" >> $GITHUB_OUTPUT
          echo "artifact_name=$FINAL_BACKUP_NAME" >> $GITHUB_OUTPUT
          echo "backup_size=$BACKUP_SIZE" >> $GITHUB_OUTPUT
          echo "backup_time=${BACKUP_TIME}s" >> $GITHUB_OUTPUT

      - name: '⬆️ Upload Comprehensive Backup'
        if: always() && steps.create_backup.outputs.backup_file != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.create_backup.outputs.artifact_name }}
          path: ${{ steps.create_backup.outputs.backup_file }}
          retention-days: ${{ github.event.inputs.backup_retention_days || '7' }}
          if-no-files-found: error
          compression-level: 0

      - name: '🔗 Store Backup Link'
        if: always() && steps.create_backup.outputs.backup_file != ''
        run: |
          set -euo pipefail
          echo "🔗 Storing backup link in MEGA... Securing the final piece. 🔒"
          
          ARTIFACT_NAME="${{ steps.create_backup.outputs.artifact_name }}"
          BACKUP_SIZE="${{ steps.create_backup.outputs.backup_size }}"
          BACKUP_TIME="${{ steps.create_backup.outputs.backup_time }}"
          
          sleep 45
          
          ARTIFACT_ID=""
          for attempt in {1..10}; do
            echo "Getting artifact ID (attempt $attempt)..."
            ARTIFACT_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts" \
              | jq -r ".artifacts[] | select(.name == \"$ARTIFACT_NAME\") | .id")
            
            if [[ -n "$ARTIFACT_ID" && "$ARTIFACT_ID" != "null" ]]; then
              break
            fi
            sleep 15
          done
          
          if [[ -n "$ARTIFACT_ID" && "$ARTIFACT_ID" != "null" ]]; then
            ARTIFACT_LINK="https://api.github.com/repos/${{ github.repository }}/actions/artifacts/${ARTIFACT_ID}/zip"
            
            cat << EOF | rclone rcat "${MEGA_REMOTE}/full_backup_link.txt"
            $ARTIFACT_LINK
            Backup: Comprehensive System Backup 📦
            Size: $BACKUP_SIZE (Ultra Compact!)
            Time: $BACKUP_TIME (Lightning Fast!)
            Created: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            Run: ${{ github.run_id }}
            
            🚀 COMPREHENSIVE BACKUP CONTENTS:
              ========================
            ✅ The ENTIRE system state is captured, ensuring perfect restoration.
            ✅ All installed packages, services, configurations, and user data.
            ✅ Aggressive compression minimizes file size & upload time.
            🛡️ Avoids missing critical files and configurations.
            💡 The most reliable method for an ephemeral environment.
            
            Next restoration will be LIGHTNING FAST! ⚡
            EOF
            
            echo "✅ Full backup link stored successfully! Your data is safe. 💯"
            
          else
            echo "⚠️ Could not get artifact ID, uploading backup directly... This is a fallback. 🛡️"
            BACKUP_FILE="${{ steps.create_backup.outputs.backup_file }}"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            if rclone copy "$BACKUP_FILE" "${MEGA_REMOTE}/direct-backups/${TIMESTAMP}_${ARTIFACT_NAME}"; then
              echo "✅ Direct upload successful! Your backup is secure. 🤝"
            else
              echo "❌ All upload methods failed! This is a critical failure. 💀" >&2
              exit 1
            fi
          fi
          
          echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC') - FULL backup ($BACKUP_SIZE in $BACKUP_TIME) - Run ${{ github.run_id }}" | \
            rclone rcat "${MEGA_REMOTE}/full_backup_history.log" --append
          
          rclone delete "${MEGA_REMOTE}/smart_backup_link.txt" 2>/dev/null || true
          rclone delete "${MEGA_REMOTE}/essential_backup_link.txt" 2>/dev/null || true
          rclone delete "${MEGA_REMOTE}/incremental_backup_link.txt" 2>/dev/null || true
          
          echo "🎉 Full backup storage completed! The mission is a success. 🥳"

      - name: '🧹 Enhanced Cleanup'
        if: always()
        run: |
          set -euo pipefail
          echo "🧹 Performing final cleanup... leaving no traces. 👻"
          
          cleanup_paths=(
            "/tmp/tmate.sock"
            "/tmp/session_keeper.sh"
            "/tmp/session_keeper.log"
            "/mnt/restore"
            "/tmp/essential_backup_paths.txt"
            "/tmp/stopped_services.txt"
          )
          
          for path in "${cleanup_paths[@]}"; do
            if [[ -e "$path" ]]; then
              sudo rm -rf "$path"
            fi
          done
          
          sudo apt-get autoremove -y 2>/dev/null || true
          sudo apt-get autoclean 2>/dev/null || true
          
          echo "✅ Cleanup completed. All shiny and new. ✨"

      - name: '📊 Final Status Report'
        if: always()
        run: |
          echo ""
          echo "================================================="
          echo "🎯      ULTIMATE VPS - FINAL STATUS REPORT     🎯"
          echo "================================================="
          echo "⚡ SESSION TYPE: Ultimate Reliable VPS"
          echo "🕐 Duration: ${{ github.event.inputs.session_duration_minutes || '220' }} minutes"
          echo "💾 Backup Type: Comprehensive System Backup"
          echo "📦 Backup Size: ${{ steps.create_backup.outputs.backup_size || 'N/A' }}"
          echo "⚡ Backup Time: ${{ steps.create_backup.outputs.backup_time || 'N/A' }}"
          echo "🔍 Previous Backup: ${{ steps.discover_backup.outputs.backup_found || 'false' }}"
          echo "🆔 Run ID: ${{ github.run_id }}"
          echo "================================================="
          
          echo "💻 System Info:"
          echo "   OS: $(lsb_release -d 2>/dev/null | cut -f2 || echo 'Ubuntu')"
          echo "   Uptime: $(uptime -p 2>/dev/null || echo 'N/A')"
          echo "   Load: $(uptime | awk -F'load average:' '{print $2}' | xargs || echo 'N/A')"
          
          echo ""
          echo "🔧 Key Services:"
          for service in ssh docker mariadb tailscaled nginx; do
            if systemctl list-unit-files --type=service | grep -q "^${service}\.service"; then
              if systemctl is-active --quiet "$service"; then
                echo "   ✅ $service: Running"
              else
                echo "   ⚠️ $service: Stopped"
              fi
            fi
          done
          
          echo ""
          echo "🚀 COMPREHENSIVE BACKUP ADVANTAGES:"
          echo "   ✅ Captures the ENTIRE system state for a perfect restore."
          echo "   ⚡ Aggressive compression minimizes file size & upload time."
          echo "   🛡️ Avoids missing critical files and configurations."
          echo "   💡 The most reliable method for an ephemeral environment."
          
          echo ""
          echo "🎉 THE ULTIMATE VPS SESSION IS COMPLETE! 🎉"
          echo "Your VPS is safe and sound! 💯"
          echo "================================================="
