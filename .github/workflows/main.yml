
name: ğŸ•·ï¸ Spidey's Persistent VPS Adventure

on:
  workflow_dispatch:
    inputs:
      force_fresh_install:
        description: 'ğŸ”„ Force fresh install (ignore backups)'
        required: false
        default: 'false'
        type: boolean
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 420  # 7 hours to be safe
    
    steps:
      - name: ğŸ•¸ï¸ Web-slinging into action
        run: |
          echo "ğŸ•·ï¸ ===================================================="
          echo "ğŸ•·ï¸ SPIDEY'S VPS IS SWINGING INTO ACTION! ğŸ•¸ï¸"
          echo "ğŸ•·ï¸ Time: $(date)"
          echo "ğŸ•·ï¸ Your friendly neighborhood VPS is starting up! ğŸ¢"
          echo "ğŸ•·ï¸ ===================================================="
          
      - name: ğŸ”§ Installing Spidey's web-tools (rclone)
        run: |
          echo "ğŸ•·ï¸ Installing rclone - Spidey's file-slinging tool! ğŸ•¸ï¸"
          curl https://rclone.org/install.sh | sudo bash
          echo "âœ… Rclone installed! Ready to swing files around! ğŸ•¸ï¸"

      - name: ğŸ” Setting up MEGA web connection
        run: |
          echo "ğŸ•·ï¸ Decoding MEGA secrets with spider sense... ğŸ•¸ï¸"
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" | base64 -d > ~/.config/rclone/rclone.conf 2>/dev/null || echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf
          echo "âœ… MEGA connection established! ğŸ•¸ï¸"

      - name: ğŸ” Spider-sense:Checking for existing backups
        id: backup_check
        run: |
          echo "ğŸ•·ï¸ Spider-sense is tingling... checking for backups! ğŸ•¸ï¸"
          
          RESTORE_SUCCESS=false
          
          if [ "${{ github.event.inputs.force_fresh_install }}" = "true" ]; then
            echo "ğŸ”„ Force fresh install requested! Skipping all backups! ğŸ•·ï¸"
          else
            # Try GitHub artifacts first
            echo "ğŸ” Searching for GitHub artifacts..."
            # Note: In a real scenario, you'd need to download from previous workflow runs
            # This is a placeholder for the artifact download logic
            
            # Try MEGA backup
            echo "ğŸ” Checking MEGA for backup files..."
            if rclone ls mega:spidey-vps-backup/vps-backup.tar.gz > /dev/null 2>&1; then
              echo "ğŸ¯ Found MEGA backup! Spider-sense was right! ğŸ•¸ï¸"
              echo "ğŸ“¥ Downloading backup from MEGA web..."
              rclone copy mega:spidey-vps-backup/vps-backup.tar.gz ./
              if [ -f "vps-backup.tar.gz" ]; then
                echo "ğŸ•·ï¸ Extracting backup with spider precision..."
                sudo tar -xzf vps-backup.tar.gz -C / 2>/dev/null || echo "âš ï¸ Some files couldn't be restored (probably normal)"
                RESTORE_SUCCESS=true
                echo "âœ… Backup restored! The web is back! ğŸ•¸ï¸"
              fi
            else
              echo "ğŸ¤· No MEGA backup found. Time for a fresh start! ğŸ•·ï¸"
            fi
          fi
          
          echo "restore_success=$RESTORE_SUCCESS" >> $GITHUB_OUTPUT

      - name: ğŸ  Setting up Spidey's new home
        if: steps.backup_check.outputs.restore_success != 'true'
        run: |
          echo "ğŸ—ï¸ Building Spidey's new web-base from scratch! ğŸ•¸ï¸"
          
          # Set hostname
          echo "ğŸ·ï¸ Setting hostname to Spidey..."
          sudo hostnamectl set-hostname Spidey
          echo "âœ… Hostname set! This machine is now officially Spidey! ğŸ•·ï¸"

      - name: ğŸ‘¤ Creating Spidey's alter ego (jacky user)
        run: |
          echo "ğŸ•·ï¸ Creating secret identity: jacky ğŸ¥·"
          if ! id jacky > /dev/null 2>&1; then
            sudo useradd -m -s /bin/bash jacky
            echo "jacky:spidey" | sudo chpasswd
            sudo usermod -aG sudo jacky
            echo "âœ… Secret identity created! jacky is ready with spider powers! ğŸ•¸ï¸"
          else
            echo "ğŸ‘¤ Secret identity already exists! jacky is still in the game! ğŸ•·ï¸"
          fi

      - name: ğŸ•¸ï¸ Installing Tailscale (Spidey's private web)
        run: |
          echo "ğŸ•¸ï¸ Setting up Spidey's private web network... ğŸ•·ï¸"
          
          # Restore Tailscale state if available
          if [ -d "/var/lib/tailscale" ] && [ -f "/var/lib/tailscale/tailscaled.state" ]; then
            echo "ğŸ”„ Found existing Tailscale web! Preserving identity... ğŸ•¸ï¸"
            sudo systemctl enable --now tailscaled
            sudo systemctl start tailscaled
          else
            echo "ğŸ†• Fresh Tailscale installation! ğŸ•¸ï¸"
            curl -fsSL https://tailscale.com/install.sh | sh
            sudo systemctl enable --now tailscaled
            sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTHKEY }}" --accept-routes
            echo "âœ… Spidey's private web is now active! ğŸ•¸ï¸"
          fi

      - name: ğŸ—„ï¸ Setting up MariaDB (Spidey's data vault)
        run: |
          echo "ğŸ—„ï¸ Setting up Spidey's secure data vault! ğŸ•·ï¸"
          
          sudo apt-get update
          sudo apt-get install -y mariadb-server
          
          if [ ! -d "/var/lib/mysql/mysql" ]; then
            echo "ğŸ”§ Initializing fresh database..."
            sudo mysql_secure_installation << EOF
          

          y
          ${{ secrets.DB_ROOT_PASSWORD }}
          ${{ secrets.DB_ROOT_PASSWORD }}
          y
          y
          y
          y
          EOF
          else
            echo "ğŸ“Š Database already initialized! Data vault is secure! ğŸ•¸ï¸"
          fi
          
          sudo systemctl enable --now mariadb
          echo "âœ… Data vault is operational! ğŸ•¸ï¸"

      - name: ğŸ›ï¸ Installing aaPanel (Spidey's control center)
        run: |
          echo "ğŸ›ï¸ Installing Spidey's web control center! ğŸ•·ï¸"
          
          # Check if aaPanel is already installed
          if command -v bt > /dev/null 2>&1; then
            echo "âœ… aaPanel already installed! Control center is ready! ğŸ•¸ï¸"
          else
            echo "ğŸ“¥ Downloading latest aaPanel installer..."
            wget -O install.sh http://www.aapanel.com/script/install_7.0_en.sh
            chmod +x install.sh
            
            echo "ğŸ¤– Starting automated installation with spider precision..."
            # Automated installation with prompts handled
            expect << 'EOF'
          spawn sudo bash install.sh
          expect "Do you want to install aaPanel to the /www directory now?(y/n):" { send "y\r" }
          expect "Do you want to install aaPanel by force?(yes/no):" { send "yes\r" }
          expect eof
          EOF
            
            # Install expect if not available and retry
            if ! command -v expect > /dev/null 2>&1; then
              echo "ğŸ“¦ Installing expect for automated prompts..."
              sudo apt-get update && sudo apt-get install -y expect
              
              echo "ğŸ”„ Retrying aaPanel installation with expect..."
              expect << 'EOF'
          spawn sudo bash install.sh
          expect "Do you want to install aaPanel to the /www directory now?(y/n):" { send "y\r" }
          expect "Do you want to install aaPanel by force?(yes/no):" { send "yes\r" }
          expect eof
          EOF
            fi
          fi
          
          echo "ğŸ”§ Configuring aaPanel credentials..."
          if command -v bt > /dev/null 2>&1; then
            sudo bt 5 << EOF
          Jacky
          EOF
            sudo bt 6 << EOF
          spidey
          EOF
            echo "âœ… aaPanel configured! Username: Jacky, Password: spidey ğŸ•¸ï¸"
          else
            echo "âš ï¸ aaPanel command not found, trying alternative setup..."
          fi

      - name: ğŸŒ Starting all Spidey services
        run: |
          echo "ğŸš€ Firing up all of Spidey's web services! ğŸ•·ï¸"
          
          # Start essential services
          sudo systemctl start mariadb || echo "ğŸ“Š MariaDB already running"
          sudo systemctl start tailscaled || echo "ğŸ•¸ï¸ Tailscale already running"
          sudo systemctl start nginx || sudo systemctl start apache2 || echo "ğŸŒ Web server status unknown"
          
          # Start aaPanel if installed
          if command -v bt > /dev/null 2>&1; then
            sudo systemctl start bt || echo "ğŸ›ï¸ aaPanel service status unknown"
          fi
          
          echo "âœ… All services are web-slinging! ğŸ•¸ï¸"

      - name: ğŸ•·ï¸ Spidey's patrol loop (6 hours of web-slinging)
        run: |
          echo "ğŸ•·ï¸ Starting Spidey's patrol! Watching over the web for 6 hours... ğŸ•¸ï¸"
          echo "ğŸ’¡ Create /tmp/stop to trigger graceful shutdown! ğŸ›‘"
          
          START_TIME=$(date +%s)
          SIX_HOURS=21600  # 6 hours in seconds
          CHECK_INTERVAL=60  # Check every minute
          
          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            REMAINING=$((SIX_HOURS - ELAPSED))
            
            if [ -f "/tmp/stop" ]; then
              echo "ğŸ›‘ Stop signal detected! Spidey is preparing for graceful shutdown... ğŸ•·ï¸"
              break
            fi
            
            if [ $ELAPSED -ge $SIX_HOURS ]; then
              echo "â° 6 hours completed! Time for Spidey to swing home! ğŸ•¸ï¸"
              break
            fi
            
            # Friendly status update every 30 minutes
            if [ $((ELAPSED % 1800)) -eq 0 ] && [ $ELAPSED -gt 0 ]; then
              HOURS=$((ELAPSED / 3600))
              MINUTES=$(((ELAPSED % 3600) / 60))
              echo "ğŸ•·ï¸ Patrol status: ${HOURS}h ${MINUTES}m elapsed, still watching the web! ğŸ•¸ï¸"
            fi
            
            sleep $CHECK_INTERVAL
          done
          
          echo "ğŸ•·ï¸ Patrol completed! Time to secure the web base! ğŸ•¸ï¸"

      - name: ğŸ’¾ Creating backup of Spidey's web
        run: |
          echo "ğŸ’¾ Creating backup of Spidey's entire web! ğŸ•¸ï¸"
          
          # Create backup manifest
          cat > backup-manifest.txt << EOF
          ğŸ•·ï¸ SPIDEY'S BACKUP MANIFEST ğŸ•¸ï¸
          Backup created: $(date)
          Hostname: $(hostname)
          
          ğŸ“ Included directories:
          - /home (Spidey's personal files)
          - /root (Root's secret files)
          - /etc (System configurations)
          - /var/www (Web files)
          - /opt (Optional applications)
          - /www (aaPanel data)
          - /var/lib/tailscale (Private web state)
          - /var/lib/mysql (Data vault)
          
          ğŸ”’ This backup contains everything needed to restore Spidey's web!
          EOF
          
          echo "ğŸ“¦ Creating compressed backup archive..."
          sudo tar -czf vps-backup.tar.gz \
            -C / \
            --exclude='proc/*' \
            --exclude='sys/*' \
            --exclude='dev/*' \
            --exclude='tmp/*' \
            --exclude='var/log/*' \
            --exclude='var/cache/*' \
            home root etc/hostname etc/hosts etc/passwd etc/group etc/shadow \
            var/www opt www var/lib/tailscale var/lib/mysql \
            backup-manifest.txt 2>/dev/null || true
            
          echo "âœ… Backup archive created! Size: $(du -h vps-backup.tar.gz | cut -f1) ğŸ•¸ï¸"

      - name: ğŸ¯ Uploading to GitHub Artifacts (Primary backup)
        uses: actions/upload-artifact@v3
        with:
          name: spidey-vps-backup
          path: vps-backup.tar.gz
          retention-days: 30

      - name: â˜ï¸ Uploading to MEGA (Secondary backup)
        run: |
          echo "â˜ï¸ Uploading backup to MEGA cloud web! ğŸ•¸ï¸"
          
          # Create backup directory on MEGA if it doesn't exist
          rclone mkdir mega:spidey-vps-backup
          
          # Upload backup
          if rclone copy vps-backup.tar.gz mega:spidey-vps-backup/; then
            echo "âœ… Backup uploaded to MEGA successfully! ğŸ•¸ï¸"
            
            # Try to create a public link (if supported)
            MEGA_LINK=$(rclone link mega:spidey-vps-backup/vps-backup.tar.gz 2>/dev/null || echo "Direct link not available")
            echo "ğŸ”— MEGA Link: $MEGA_LINK" | tee mega-backup-link.txt
          else
            echo "âŒ Failed to upload to MEGA, but GitHub artifact backup exists! ğŸ•·ï¸"
          fi

      - name: ğŸ Spidey's mission complete!
        run: |
          echo "ğŸ•·ï¸ ===================================================="
          echo "ğŸ¯ SPIDEY'S MISSION COMPLETE! ğŸ•¸ï¸"
          echo "âœ… Backup created and uploaded"
          echo "â° Session duration: ~6 hours"
          echo "ğŸ”’ All services secured"
          echo "ğŸ•·ï¸ Your friendly neighborhood VPS will be back!"
          echo "ğŸ•·ï¸ ===================================================="
          echo ""
          echo "ğŸ“Š FINAL STATUS REPORT:"
          echo "ğŸ  Hostname: $(hostname)"
          echo "ğŸ‘¤ User: jacky (with spider powers!)"
          echo "ğŸŒ aaPanel: Configured (Jacky/spidey)"
          echo "ğŸ—„ï¸ MariaDB: Running and secured"
          echo "ğŸ•¸ï¸ Tailscale: Connected to private web"
          echo "ğŸ’¾ Backup: Stored in GitHub + MEGA"
          echo ""
          echo "ğŸ•·ï¸ Until next time, keep the web safe! ğŸ•¸ï¸"
