name: Persistent VPS

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'   # every 6 hours

jobs:
  vps-session:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y unzip curl wget neofetch rclone tmate net-tools

    - name: Configure rclone
      run: |
        mkdir -p ~/.config/rclone
        cat > ~/.config/rclone/rclone.conf << 'EOF'
        [gdrivveed]
        type = drive
        client_id = 534417340383-f4b86oa9dffhjuhdh4ekd38b0l9llnum.apps.googleusercontent.com
        client_secret = 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
        scope = drive
        root_folder_id = appDataFolder
        token = {"access_token":"ya29.A0AS3H6Nw8MBbpPmtrq8-3RRWIvB_UT9jfqtU5cY9SnMonjI9J9WtKY1O3VlLdWn4CKFQNGH6aXHHICHg_1TsD_LeHDGA8yMJDD4J68NYDSxKKrS3ilyhfa8CbhSpDE9-DrwA8qYnHnP0I3A4HgogqQRn2H-DTHlj-n6AbItkibxtu7IWLL2RxsB38wCXX8t7-uFJxrRAaCgYKAXQSARQSFQHGX2Micd2dOumHq5UQBnkvy6MCNw0206","token_type":"Bearer","refresh_token":"1//0gRBqns_f18v4CgYIARAAGBASNwF-L9IrHwzKqEfc8JmDh3oq8-jVbHeb0Crl3rBpCg0cRm6r7BjUXRAiOSOm4IpXnYYy9HsOHys","expiry":"2025-08-31T09:35:38.127202879Z"}
        EOF

    - name: Install Tailscale
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh

    - name: Start Tailscaled
      run: |
        sudo mkdir -p /var/run/tailscale
        sudo tailscaled --state=/var/lib/tailscale/tailscaled.state &

    - name: Restore Tailscale state (if available)
      run: |
        mkdir -p ~/backup
        rclone copy gdrivveed:tailscale_state.tgz ~/backup/ || true
        if [ -f ~/backup/tailscale_state.tgz ]; then
          sudo tar -xvzf ~/backup/tailscale_state.tgz -C /
          echo "✅ Restored Tailscale state"
        else
          echo "⚠️ No previous Tailscale state found, will create new one"
        fi

    - name: Login to Tailscale
      env:
        TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      run: |
        sudo tailscale up --authkey=${TAILSCALE_AUTHKEY} --hostname=gh-vps || true
        sudo tailscale ip -4

    - name: Backup Tailscale state (always refresh)
      run: |
        sudo tar -czvf ~/tailscale_state.tgz /var/lib/tailscale
        rclone copy ~/tailscale_state.tgz gdrivveed: --progress

    - name: Restore essential user data (if available)
      run: |
        rclone copy gdrivveed:user_backup.zip ~/backup/ || true
        if [ -f ~/backup/user_backup.zip ]; then
          sudo unzip -o ~/backup/user_backup.zip -d /
          echo "✅ Restored user data"
        fi

    - name: Start tmate session
      run: |
        curl -sSL https://github.com/pmq20/tmate/releases/download/v2.4.0/tmate-2.4.0-static-linux-amd64.tar.xz -o tmate.tar.xz
        tar -xf tmate.tar.xz
        ./tmate-2.4.0-static-linux-amd64/tmate -F &
        sleep 10
        ./tmate-2.4.0-static-linux-amd64/tmate display -p '#{tmate_ssh}'

    - name: Sleep to keep VPS alive
      run: sleep 3600

    - name: Backup essential user data
      if: always()
      run: |
        zip -r ~/user_backup.zip /etc /usr/local /opt /var/lib/tailscale /root/.bashrc /root/.profile
        rclone copy ~/user_backup.zip gdrivveed: --progress
