name: ðŸ•·ï¸ Spidey Persistent VPS - Fixed Backup

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Daily backup at midnight

env:
  PERSISTENT_DIR: /opt/persistent-vps
  BACKUP_STORE: /var/backups/vps  # Separate location for backups
  BACKUP_NAME: vps-backup-latest.tar.gz

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      # ðŸ•¸ï¸ Checkout Repo
      - name: ðŸ•¸ï¸ Checkout
        uses: actions/checkout@v4

      # âš¡ Install Required Tools
      - name: âš¡ Install System Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget unzip tar psmisc lsof screen

      # âš¡ Install Rclone
      - name: âš¡ Install Rclone
        run: |
          curl -fsSL https://rclone.org/install.sh | sudo bash
          rclone version

      # â˜ï¸ Configure Rclone MEGA
      - name: â˜ï¸ Configure Rclone (MEGA)
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [mega]
          type = mega
          user = ${{ secrets.MEGA_USER }}
          pass = ${{ secrets.MEGA_PASS }}
          EOF

      # â™»ï¸ Restore VPS from Backup (if exists)
      - name: â™»ï¸ Restore From MEGA
        run: |
          echo "ðŸ” Checking for existing backup..."
          if rclone ls mega:vps-backup/$BACKUP_NAME >/dev/null 2>&1; then
            echo "ðŸ“¥ Downloading VPS backup..."
            rclone copy mega:vps-backup/$BACKUP_NAME /tmp/
            
            echo "ðŸ›‘ Stopping services that might interfere with restore..."
            sudo pkill -f "tmate" || true
            sudo pkill -f "tailscale" || true
            
            echo "ðŸ”“ Unpacking backup to root..."
            sudo tar -xzf /tmp/$BACKUP_NAME -C /
            
            # Ensure our directories exist
            sudo mkdir -p $PERSISTENT_DIR $BACKUP_STORE
            echo "âœ… Restore complete"
          else
            echo "â„¹ï¸ No previous backup found. Starting fresh!"
            sudo mkdir -p $PERSISTENT_DIR $BACKUP_STORE
          fi

      # ðŸ‘¤ Create Jacky User + Set Hostname
      - name: ðŸ‘¤ Setup User & Hostname
        run: |
          if ! id -u jacky >/dev/null 2>&1; then
            sudo useradd -m -s /bin/bash jacky
            echo "jacky:root" | sudo chpasswd
            sudo usermod -aG sudo jacky
          fi
          
          # Restore home directory if it exists in backup
          if [ -d "$PERSISTENT_DIR/home/jacky" ]; then
            echo "ðŸ”„ Restoring jacky home directory..."
            sudo rsync -a $PERSISTENT_DIR/home/jacky/ /home/jacky/
            sudo chown -R jacky:jacky /home/jacky
          fi
          
          sudo hostnamectl set-hostname github-vps
          echo "âœ… User jacky ready (password: root)"
          echo "âœ… Hostname set to github-vps"

      # ðŸ•¸ï¸ Tailscale Setup with State Restoration
      - name: ðŸ•¸ï¸ Tailscale Setup
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo systemctl enable --now tailscaled

          # Restore Tailscale state if available
          if [ -d "$PERSISTENT_DIR/var/lib/tailscale" ]; then
            echo "â™»ï¸ Restoring Tailscale state..."
            sudo systemctl stop tailscaled
            sudo rsync -a $PERSISTENT_DIR/var/lib/tailscale/ /var/lib/tailscale/
            sudo systemctl start tailscaled
            sleep 3
            sudo tailscale up --hostname=github-vps --reset || true
          else
            echo "ðŸ†• No Tailscale state found, using fresh auth key..."
            sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=github-vps || true
          fi

          echo "âœ… Tailscale setup complete"
          echo "ðŸŒ Tailscale IP: $(sudo tailscale ip -4 || echo 'Not available')"

      # ðŸ”§ Restore System Services
      - name: ðŸ”§ Restore System Services
        run: |
          echo "ðŸ”§ Restoring system services..."
          
          # Restore systemd services if they exist
          if [ -d "$PERSISTENT_DIR/etc/systemd/system" ]; then
            sudo rsync -a $PERSISTENT_DIR/etc/systemd/system/ /etc/systemd/system/
            sudo systemctl daemon-reload
          fi
          
          # Start common services that should persist
          if [ -f "/etc/systemd/system/persistent-service.service" ]; then
            sudo systemctl enable --now persistent-service.service
          fi
          
          echo "âœ… Services restored"

      # ðŸ›°ï¸ Start Tmate Session in Background
      - name: ðŸ›°ï¸ Start Tmate Session
        run: |
          # Install tmate
          sudo apt-get install -y tmate
          
          # Start tmate in a screen session that will persist
          sudo -u jacky screen -dmS tmate-session tmate
          sleep 3
          
          # Get connection information
          echo "Tmate session started in background screen session"
          echo "Use 'sudo -u jacky screen -r tmate-session' to attach"

      # ðŸ’¾ Create Immediate Backup
      - name: ðŸ’¾ Create Initial Backup
        run: |
          echo "ðŸ“¦ Creating initial backup..."
          
          # Create backup in temporary location
          sudo tar --ignore-failed-read -czf /tmp/backup.tar.gz \
            /home/jacky \
            /etc/hostname \
            /etc/hosts \
            /etc/systemd/system \
            /var/lib/tailscale \
            /opt \
            /srv \
            /var/www 2>/dev/null || true
          
          # Move to backup store directory
          sudo mkdir -p $BACKUP_STORE
          sudo mv /tmp/backup.tar.gz $BACKUP_STORE/$BACKUP_NAME
          echo "âœ… Initial backup created at $BACKUP_STORE/$BACKUP_NAME"

      # â˜ï¸ Upload Initial Backup to MEGA
      - name: â˜ï¸ Upload Initial Backup
        run: |
          echo "ðŸš€ Uploading initial backup to MEGA..."
          rclone copy $BACKUP_STORE/$BACKUP_NAME mega:vps-backup/ --progress
          echo "âœ… Initial backup uploaded"

      # â³ Main Wait Loop
      - name: â³ Maintain VPS Session
        run: |
          echo "ðŸ–¥ï¸ VPS is now running and maintained"
          echo "The system will automatically backup before termination"
          echo "Session will timeout after 6 hours or press Ctrl+C to stop early"
          
          # Wait for most of the timeout period (leaving time for backup)
          sleep 1m

      # ðŸ’¾ Final Backup
      - name: ðŸ’¾ Create Final Backup
        if: always()
        run: |
          echo "ðŸ›‘ Preparing system for backup..."
          sudo systemctl stop tailscaled || true
          sudo pkill -f "tmate" || true
          
          echo "ðŸ“¦ Creating final backup archive..."
          sudo tar --ignore-failed-read -czf /tmp/backup.tar.gz \
            /home/jacky \
            /etc/hostname \
            /etc/hosts \
            /etc/systemd/system \
            /var/lib/tailscale \
            /opt \
            /srv \
            /var/www 2>/dev/null || true
          
          sudo mkdir -p $BACKUP_STORE
          sudo mv /tmp/backup.tar.gz $BACKUP_STORE/$BACKUP_NAME
          echo "âœ… Final backup created: $BACKUP_STORE/$BACKUP_NAME"

      # â˜ï¸ Upload Final Backup to MEGA
      - name: â˜ï¸ Upload Final Backup to MEGA
        if: always()
        run: |
          echo "ðŸš€ Uploading final backup to MEGA..."
          rclone copy $BACKUP_STORE/$BACKUP_NAME mega:vps-backup/ --progress
          echo "âœ… Final backup uploaded successfully"

      # ðŸ“ Final Status Report
      - name: ðŸ“ Status Report
        if: always()
        run: |
          echo "=== VPS STATUS REPORT ==="
          echo "Hostname: $(hostname)"
          echo "User: jacky (password: root)"
          echo "Tailscale IP: $(sudo tailscale ip -4 2>/dev/null || echo 'Not configured')"
          echo "Backup Status: ${{ job.status }}"
          echo "Backup Location: $BACKUP_STORE/$BACKUP_NAME"
          echo "========================="
