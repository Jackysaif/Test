name: Persistent VPS with Backup & Restore

on:
  workflow_dispatch:
  workflow_call:
  schedule:
    - cron: "0 */6 * * *"   # every 6 hours

jobs:
  vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create user jacky
        run: |
          sudo useradd -m -s /bin/bash jacky || true
          echo "jacky:root" | sudo chpasswd
          echo "jacky ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/jacky

      - name: Download VPS backup if exists
        uses: actions/download-artifact@v4
        with:
          name: vps-backup-latest
          path: backup
        continue-on-error: true

      - name: Restore VPS files
        run: |
          if [ -f backup/vps-backup.tar.gz ]; then
            echo "üì¶ Restoring VPS files..."
            sudo tar -xzf backup/vps-backup.tar.gz -C /
          else
            echo "‚ÑπÔ∏è No previous VPS backup found."
          fi

      - name: Download Tailscale state if exists
        uses: actions/download-artifact@v4
        with:
          name: ts-backup
          path: ts-backup
        continue-on-error: true

      - name: Restore Tailscale state
        run: |
          if [ -d ts-backup ]; then
            echo "üì¶ Restoring Tailscale state..."
            sudo mkdir -p /var/lib/tailscale
            sudo cp -r ts-backup/* /var/lib/tailscale/ || true
          else
            echo "‚ÑπÔ∏è No previous Tailscale state found."
          fi

      - name: Install & Start Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscaled & sleep 5
          sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --hostname github-vps --ssh

      - name: System Info
        run: |
          uname -a
          whoami
          id
          df -h
          free -m

      - name: Keep VPS alive (tmate session)
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 300

      # ===== BACKUP SECTION =====
      - name: Backup VPS files
        if: always()
        run: |
          echo "üì¶ Creating VPS backup..."
          mkdir -p backup
          sudo tar --exclude=./backup/vps-backup.tar.gz -czf backup/vps-backup.tar.gz /etc /home /var || true

      - name: Backup Tailscale state
        if: always()
        run: |
          echo "üîí Backing up Tailscale state..."
          mkdir -p ts-backup
          sudo cp -r /var/lib/tailscale/* ts-backup/ || true

      - name: Upload VPS backup
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vps-backup-latest
          path: backup/vps-backup.tar.gz
          retention-days: 3

      - name: Upload Tailscale state
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ts-backup
          path: ts-backup
          retention-days: 3

      - name: Completion summary
        if: always()
        run: |
          echo ""
          echo "üéâ ================================="
          echo "‚úÖ VPS BACKUP & RESTORE COMPLETED"
          echo "üéâ ================================="
          echo ""
          echo "üìä Backup Statistics:"
          du -sh backup/* || true
          echo ""
          echo "‚òÅÔ∏è Stored as GitHub Artifacts"
